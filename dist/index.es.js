/**
 * Copyright Metrichor Ltd. (An Oxford Nanopore Technologies Company) 2020
 */

import e from"aws-sdk";import t from"fs-extra";import{merge as n,flatten as r,remove as o,assign as i,filter as s,every as a,isFunction as u,defaults as c,takeRight as l,isArray as h}from"lodash";import f,{homedir as p,EOL as d}from"os";import g from"path";import m from"sqlite";import w from"axios";import v from"crypto";import{httpsOverHttps as y,httpsOverHttp as b}from"tunnel";import{BehaviorSubject as k,combineLatest as S}from"rxjs";import I from"graphql-tag";import{InMemoryCache as _}from"apollo-cache-inmemory";import E from"apollo-client";import{ApolloLink as P,execute as T}from"apollo-link";import{createHttpLink as x}from"apollo-link-http";import{buildAxiosFetch as j}from"@lifeomic/axios-fetch";import O from"socket.io-client";import R,{createGunzip as $}from"zlib";import A from"fdir";import N from"proxy-agent";import C from"readline";var W=function(e,t){return(W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function M(e,t){function n(){this.constructor=e}W(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var q=function(){return(q=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function F(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(t){i(t)}}function a(e){try{u(r.throw(e))}catch(t){i(t)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))}function D(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function Q(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}function U(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var z="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};function L(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===t||null===t)&&n.path)}},n.exports),n.exports}var J=L((function(e,t){!function(n){var r=t&&!t.nodeType&&t,o=e&&!e.nodeType&&e,i="object"==typeof z&&z;i.global!==i&&i.window!==i&&i.self!==i||(n=i);var s,a,u=2147483647,c=/^xn--/,l=/[^\x20-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,f={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},p=Math.floor,d=String.fromCharCode;function g(e){throw RangeError(f[e])}function m(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function w(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+m((e=e.replace(h,".")).split("."),t).join(".")}function v(e){for(var t,n,r=[],o=0,i=e.length;o<i;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<i?56320==(64512&(n=e.charCodeAt(o++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),o--):r.push(t);return r}function y(e){return m(e,(function(e){var t="";return e>65535&&(t+=d((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=d(e)})).join("")}function b(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function k(e,t,n){var r=0;for(e=n?p(e/700):e>>1,e+=p(e/t);e>455;r+=36)e=p(e/35);return p(r+36*e/(e+38))}function S(e){var t,n,r,o,i,s,a,c,l,h,f,d=[],m=e.length,w=0,v=128,b=72;for((n=e.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&g("not-basic"),d.push(e.charCodeAt(r));for(o=n>0?n+1:0;o<m;){for(i=w,s=1,a=36;o>=m&&g("invalid-input"),((c=(f=e.charCodeAt(o++))-48<10?f-22:f-65<26?f-65:f-97<26?f-97:36)>=36||c>p((u-w)/s))&&g("overflow"),w+=c*s,!(c<(l=a<=b?1:a>=b+26?26:a-b));a+=36)s>p(u/(h=36-l))&&g("overflow"),s*=h;b=k(w-i,t=d.length+1,0==i),p(w/t)>u-v&&g("overflow"),v+=p(w/t),w%=t,d.splice(w++,0,v)}return y(d)}function I(e){var t,n,r,o,i,s,a,c,l,h,f,m,w,y,S,I=[];for(m=(e=v(e)).length,t=128,n=0,i=72,s=0;s<m;++s)(f=e[s])<128&&I.push(d(f));for(r=o=I.length,o&&I.push("-");r<m;){for(a=u,s=0;s<m;++s)(f=e[s])>=t&&f<a&&(a=f);for(a-t>p((u-n)/(w=r+1))&&g("overflow"),n+=(a-t)*w,t=a,s=0;s<m;++s)if((f=e[s])<t&&++n>u&&g("overflow"),f==t){for(c=n,l=36;!(c<(h=l<=i?1:l>=i+26?26:l-i));l+=36)S=c-h,y=36-h,I.push(d(b(h+S%y,0))),c=p(S/y);I.push(d(b(c,0))),i=k(n,w,r==o),n=0,++r}++n,++t}return I.join("")}if(s={version:"1.3.2",ucs2:{decode:v,encode:y},decode:S,encode:I,toASCII:function(e){return w(e,(function(e){return l.test(e)?"xn--"+I(e):e}))},toUnicode:function(e){return w(e,(function(e){return c.test(e)?S(e.slice(4).toLowerCase()):e}))}},r&&o)if(e.exports==r)o.exports=s;else for(a in s)s.hasOwnProperty(a)&&(r[a]=s[a]);else n.punycode=s}(z)}));function H(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var G=function(e,t,n,r){t=t||"&",n=n||"=";var o={};if("string"!==typeof e||0===e.length)return o;var i=/\+/g;e=e.split(t);var s=1e3;r&&"number"===typeof r.maxKeys&&(s=r.maxKeys);var a=e.length;s>0&&a>s&&(a=s);for(var u=0;u<a;++u){var c,l,h,f,p=e[u].replace(i,"%20"),d=p.indexOf(n);d>=0?(c=p.substr(0,d),l=p.substr(d+1)):(c=p,l=""),h=decodeURIComponent(c),f=decodeURIComponent(l),H(o,h)?Array.isArray(o[h])?o[h].push(f):o[h]=[o[h],f]:o[h]=f}return o},B=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}},V=function(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"===typeof e?Object.keys(e).map((function(r){var o=encodeURIComponent(B(r))+n;return Array.isArray(e[r])?e[r].map((function(e){return o+encodeURIComponent(B(e))})).join(t):o+encodeURIComponent(B(e[r]))})).join(t):r?encodeURIComponent(B(r))+n+encodeURIComponent(B(e)):""},K=L((function(e,t){t.decode=t.parse=G,t.encode=t.stringify=V})),X=function(e,t){return le(e,!1,!0).resolve(t)};function Y(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var Z=/^([a-z0-9.+-]+:)/i,ee=/:[0-9]*$/,te=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),ne=["'"].concat(te),re=["%","/","?",";","#"].concat(ne),oe=["/","?","#"],ie=/^[a-z0-9A-Z_-]{0,63}$/,se=/^([a-z0-9A-Z_-]{0,63})(.*)$/,ae={javascript:!0,"javascript:":!0},ue={javascript:!0,"javascript:":!0},ce={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function le(e,t,n){if(e&&fe(e)&&e instanceof Y)return e;var r=new Y;return r.parse(e,t,n),r}function he(e){return"string"===typeof e}function fe(e){return"object"===typeof e&&null!==e}function pe(e){return null===e}Y.prototype.parse=function(e,t,n){if(!he(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var r=e;r=r.trim();var o=Z.exec(r);if(o){var i=(o=o[0]).toLowerCase();this.protocol=i,r=r.substr(o.length)}if(n||o||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var s="//"===r.substr(0,2);!s||o&&ue[o]||(r=r.substr(2),this.slashes=!0)}if(!ue[o]&&(s||o&&!ce[o])){for(var a,u,c=-1,l=0;l<oe.length;l++){-1!==(h=r.indexOf(oe[l]))&&(-1===c||h<c)&&(c=h)}-1!==(u=-1===c?r.lastIndexOf("@"):r.lastIndexOf("@",c))&&(a=r.slice(0,u),r=r.slice(u+1),this.auth=decodeURIComponent(a)),c=-1;for(l=0;l<re.length;l++){var h;-1!==(h=r.indexOf(re[l]))&&(-1===c||h<c)&&(c=h)}-1===c&&(c=r.length),this.host=r.slice(0,c),r=r.slice(c),this.parseHost(),this.hostname=this.hostname||"";var f="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!f)for(var p=this.hostname.split(/\./),d=(l=0,p.length);l<d;l++){var g=p[l];if(g&&!g.match(ie)){for(var m="",w=0,v=g.length;w<v;w++)g.charCodeAt(w)>127?m+="x":m+=g[w];if(!m.match(ie)){var y=p.slice(0,l),b=p.slice(l+1),k=g.match(se);k&&(y.push(k[1]),b.unshift(k[2])),b.length&&(r="/"+b.join(".")+r),this.hostname=y.join(".");break}}}if(this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),!f){var S=this.hostname.split("."),I=[];for(l=0;l<S.length;++l){var _=S[l];I.push(_.match(/[^A-Za-z0-9_-]/)?"xn--"+J.encode(_):_)}this.hostname=I.join(".")}var E=this.port?":"+this.port:"",P=this.hostname||"";this.host=P+E,this.href+=this.host,f&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==r[0]&&(r="/"+r))}if(!ae[i])for(l=0,d=ne.length;l<d;l++){var T=ne[l],x=encodeURIComponent(T);x===T&&(x=escape(T)),r=r.split(T).join(x)}var j=r.indexOf("#");-1!==j&&(this.hash=r.substr(j),r=r.slice(0,j));var O=r.indexOf("?");if(-1!==O?(this.search=r.substr(O),this.query=r.substr(O+1),t&&(this.query=K.parse(this.query)),r=r.slice(0,O)):t&&(this.search="",this.query={}),r&&(this.pathname=r),ce[i]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){E=this.pathname||"",_=this.search||"";this.path=E+_}return this.href=this.format(),this},Y.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",o=!1,i="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&fe(this.query)&&Object.keys(this.query).length&&(i=K.stringify(this.query));var s=this.search||i&&"?"+i||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||ce[t])&&!1!==o?(o="//"+(o||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):o||(o=""),r&&"#"!==r.charAt(0)&&(r="#"+r),s&&"?"!==s.charAt(0)&&(s="?"+s),t+o+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(s=s.replace("#","%23"))+r},Y.prototype.resolve=function(e){return this.resolveObject(le(e,!1,!0)).format()},Y.prototype.resolveObject=function(e){if(he(e)){var t=new Y;t.parse(e,!1,!0),e=t}var n=new Y;if(Object.keys(this).forEach((function(e){n[e]=this[e]}),this),n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol)return Object.keys(e).forEach((function(t){"protocol"!==t&&(n[t]=e[t])})),ce[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n;if(e.protocol&&e.protocol!==n.protocol){if(!ce[e.protocol])return Object.keys(e).forEach((function(t){n[t]=e[t]})),n.href=n.format(),n;if(n.protocol=e.protocol,e.host||ue[e.protocol])n.pathname=e.pathname;else{for(var r=(e.pathname||"").split("/");r.length&&!(e.host=r.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==r[0]&&r.unshift(""),r.length<2&&r.unshift(""),n.pathname=r.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var o=n.pathname||"",i=n.search||"";n.path=o+i}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var s=n.pathname&&"/"===n.pathname.charAt(0),a=e.host||e.pathname&&"/"===e.pathname.charAt(0),u=a||s||n.host&&e.pathname,c=u,l=n.pathname&&n.pathname.split("/")||[],h=(r=e.pathname&&e.pathname.split("/")||[],n.protocol&&!ce[n.protocol]);if(h&&(n.hostname="",n.port=null,n.host&&(""===l[0]?l[0]=n.host:l.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===r[0]?r[0]=e.host:r.unshift(e.host)),e.host=null),u=u&&(""===r[0]||""===l[0])),a)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,l=r;else if(r.length)l||(l=[]),l.pop(),l=l.concat(r),n.search=e.search,n.query=e.query;else if(null!=e.search){if(h)n.hostname=n.host=l.shift(),(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift());return n.search=e.search,n.query=e.query,pe(n.pathname)&&pe(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!l.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var f=l.slice(-1)[0],p=(n.host||e.host)&&("."===f||".."===f)||""===f,d=0,g=l.length;g>=0;g--)"."==(f=l[g])?l.splice(g,1):".."===f?(l.splice(g,1),d++):d&&(l.splice(g,1),d--);if(!u&&!c)for(;d--;d)l.unshift("..");!u||""===l[0]||l[0]&&"/"===l[0].charAt(0)||l.unshift(""),p&&"/"!==l.join("/").substr(-1)&&l.push("");var m,w=""===l[0]||l[0]&&"/"===l[0].charAt(0);h&&(n.hostname=n.host=w?"":l.length?l.shift():"",(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift()));return(u=u||n.host&&l.length)&&!w&&l.unshift(""),l.length?n.pathname=l.join("/"):(n.pathname=null,n.path=null),pe(n.pathname)&&pe(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},Y.prototype.parseHost=function(){var e=this.host,t=ee.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};var de="3.0.1510";w.defaults.validateStatus=function(e){return e<=504};var ge=function(){var e=this,t=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&(e.headers["X-EPI2ME-ApiKey"]=n.apikey,n.apisecret)){e.headers["X-EPI2ME-SignatureDate"]=(new Date).toISOString(),e.url.match(/^https:/)&&(e.url=e.url.replace(/:443/,"")),e.url.match(/^http:/)&&(e.url=e.url.replace(/:80/,""));var r=[e.url,Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n")].join("\n"),o=v.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SignatureV0"]=o}},r=function(t){return F(e,void 0,void 0,(function(){var e,n;return D(this,(function(r){return(e=t?t.data:null)?t&&t.status>=400?(n="Network error "+t.status,e.error&&(n=e.error),504===t.status&&(n="Please check your network connection and try again."),[2,Promise.reject(new Error(n))]):e.error?[2,Promise.reject(new Error(e.error))]:[2,Promise.resolve(e)]:[2,Promise.reject(new Error("unexpected non-json response"))]}))}))};return{version:"3.0.1510",headers:function(e,r){var o=n({log:{debug:function(){}}},r).log,i=r;if(i||(i={}),e.headers=n({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-Client":i.user_agent||"api","X-EPI2ME-Version":i.agent_version||ge.version},e.headers,i.headers),"signing"in i&&!i.signing||t(e,i),i.proxy){var s=i.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=s[2],u=s[3],c={host:s[4],port:s[5]};a&&u&&(c.proxyAuth=a+":"+u),i.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),e.httpsAgent=y({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),e.httpsAgent=b({proxy:c})),e.proxy=!1}},head:function(t,r){return F(e,void 0,void 0,(function(){var e,o,i,s,a,u,c,l;return D(this,(function(h){switch(h.label){case 0:e=n({log:{debug:function(){}}},r).log,i=r.url,s=t,r.skip_url_mangle?o=s:(s="/"+s,i=i.replace(/\/+$/,""),s=s.replace(/\/+/g,"/"),o=i+s),a={url:o,gzip:!0},ge.headers(a,r),h.label=1;case 1:return h.trys.push([1,3,,4]),e.debug("HEAD "+a.url),[4,w.head(a.url,a)];case 2:return(u=h.sent())&&u.status>=400?(c="Network error "+u.status,504===u.status&&(c="Please check your network connection and try again."),[2,Promise.reject(new Error(c))]):[3,4];case 3:return l=h.sent(),[2,Promise.reject(l)];case 4:return[2,Promise.resolve(u)]}}))}))},get:function(t,o){return F(e,void 0,void 0,(function(){var e,i,s,a,u,c,l;return D(this,(function(h){switch(h.label){case 0:e=n({log:{debug:function(){}}},o).log,s=o.url,a=t,o.skip_url_mangle?i=a:(a="/"+a,s=s.replace(/\/+$/,""),a=a.replace(/\/+/g,"/"),i=s+a),u={url:i,gzip:!0},ge.headers(u,o),h.label=1;case 1:return h.trys.push([1,3,,4]),e.debug("GET "+u.url),[4,w.get(u.url,u)];case 2:return c=h.sent(),[3,4];case 3:return l=h.sent(),[2,Promise.reject(l)];case 4:return[2,r(c,o)]}}))}))},post:function(t,o,i){return F(e,void 0,void 0,(function(){var e,s,a,u,c,l,h,f,p;return D(this,(function(d){switch(d.label){case 0:e=n({log:{debug:function(){}}},i).log,s=(s=i.url).replace(/\/+$/,""),a=t.replace(/\/+/g,"/"),u={url:s+"/"+a,gzip:!0,data:o,headers:{}},i.legacy_form&&(c=[],l=n({json:JSON.stringify(o)},o),Object.keys(l).sort().forEach((function(e){c.push(e+"="+escape(l[e]))})),u.data=c.join("&"),u.headers["Content-Type"]="application/x-www-form-urlencoded"),ge.headers(u,i),h=u.data,delete u.data,d.label=1;case 1:return d.trys.push([1,3,,4]),e.debug("POST "+u.url),[4,w.post(u.url,h,u)];case 2:return f=d.sent(),[3,4];case 3:return p=d.sent(),[2,Promise.reject(p)];case 4:return i.handler?[2,i.handler(f)]:[2,r(f,i)]}}))}))},put:function(t,o,i,s){return F(e,void 0,void 0,(function(){var e,a,u,c,l,h,f,p,d;return D(this,(function(g){switch(g.label){case 0:e=n({log:{debug:function(){}}},s).log,a=(a=s.url).replace(/\/+$/,""),u=t.replace(/\/+/g,"/"),c={url:a+"/"+u+"/"+o,gzip:!0,data:i,headers:{}},s.legacy_form&&(l=[],h=n({json:JSON.stringify(i)},i),Object.keys(h).sort().forEach((function(e){l.push(e+"="+escape(h[e]))})),c.data=l.join("&"),c.headers["Content-Type"]="application/x-www-form-urlencoded"),ge.headers(c,s),f=c.data,delete c.data,g.label=1;case 1:return g.trys.push([1,3,,4]),e.debug("PUT "+c.url),[4,w.put(c.url,f,c)];case 2:return p=g.sent(),[3,4];case 3:return d=g.sent(),[2,Promise.reject(d)];case 4:return[2,r(p,s)]}}))}))},convertResponseToObject:function(e){if("object"===typeof e)return e;try{return JSON.parse(e)}catch(t){throw new Error("exception parsing chain JSON "+String(t))}}}}();ge.pipe=function(e,n,r,o){return F(void 0,void 0,void 0,(function(){var i,s,a;return D(this,(function(u){return i=r.url,s="/"+e,i=i.replace(/\/+$/,""),s=s.replace(/\/+/g,"/"),a={url:i+s,gzip:!0,headers:{"Accept-Encoding":"gzip",Accept:"application/gzip"}},ge.headers(a,r),r.proxy&&(a.proxy=r.proxy),o&&(a.onUploadProgress=o),a.responseType="stream",[2,new Promise((function(e,r){w.get(a.url,a).then((function(o){var i=t.createWriteStream(n);o.data.pipe(i),i.on("finish",(function(){e(n)})),i.on("error",(function(e){r(new Error("writer failed "+String(e)))}))})).catch((function(e){r(e)}))}))]}))}))};var me=0;ge.getFileID=function(){return"FILE_"+(me+=1)},ge.lsRecursive=function(e,n,o){return F(void 0,void 0,void 0,(function(){var i,s;return D(this,(function(a){switch(a.label){case 0:return i=e,s=t.statSync(n),o?[4,o(n,s)]:[3,2];case 1:if(a.sent())return[2,[]];a.label=2;case 2:return s.isDirectory()?[2,t.readdir(n).then((function(e){return e.map((function(e){return g.join(n,e)}))})).then((function(e){return Promise.all(e.map((function(e){return ge.lsRecursive(i,e,o)})))})).then((function(e){return r(e)}))]:(s.isFile()&&i===n&&(i=g.dirname(n)),[2,[{name:g.parse(n).base,path:n,relative:n.replace(i,""),size:s.size,id:ge.getFileID()}]])}}))}))},ge.loadInputFiles=function(e,t,n){var r=e.inputFolders,o=e.outputFolder,i=e.filetype;return F(void 0,void 0,void 0,(function(){var e,t;return D(this,(function(s){switch(s.label){case 0:return(e=i)instanceof Array||(e=[e]),e=e.map((function(e){return e&&0!==e.indexOf(".")?"."+e:e})),t=function(t,r){return F(void 0,void 0,void 0,(function(){var i,s;return D(this,(function(a){return i=g.basename(t),s=[new Promise((function(e,n){return"downloads"===i||"skip"===i||"fail"===i||"fastq_fail"===i||"tmp"===i?n(new Error(t+" failed basic filename")):e("basic ok")})),new Promise((function(n,s){var a=e.length?new RegExp("(?:"+e.join("|")+")$"):null;return t.split(g.sep).filter((function(e){return e.match(/^[.]/)})).length||o&&i===g.basename(o)||a&&!t.match(a)&&r.isFile()?s(new Error(t+" failed extended filename")):n("extended ok")})),n?new Promise((function(e,r){n(t).then((function(n){return n?r(new Error(t+" failed extraFilter")):e("extra ok")}))})):Promise.resolve("extra skip")],[2,Promise.all(s).then((function(){return null})).catch((function(){return"exclude"}))]}))}))},[4,Promise.all(r.map((function(e){return ge.lsRecursive(e,e,t)})))];case 1:return[2,s.sent().reduce((function(e,t){return Q(e,t.filter((function(e){return!!e})))}),[])]}}))}))},ge.stripFile=function(e){return[g.dirname(e),g.basename(e)]};var we,ve,ye,be,ke,Se,Ie,_e,Ee,Pe,Te,xe,je,Oe,Re,$e=function(){function e(e,r,o){var i=this,s=n({},r);this.options=s,this.log=o;var a=s.idWorkflowInstance,u=s.inputFolders;o.debug("setting up "+e+"/db.sqlite for "+a),this.db=t.mkdirp(e).then((function(){return i.log.debug("opening "+e+"/db.sqlite"),m.open(g.join(e,"db.sqlite")).then((function(t){return F(i,void 0,void 0,(function(){var n,r;return D(this,(function(o){switch(o.label){case 0:return this.log.debug("opened "+e+"/db.sqlite"),[4,t.migrate({migrationsPath:g.join(__dirname,"migrations")})];case 1:o.sent(),n=u.map((function(){return"(?)"})).join(","),o.label=2;case 2:return o.trys.push([2,4,,5]),[4,Promise.all([t.run("INSERT INTO meta (version, idWorkflowInstance) VALUES(?, ?)",de,a),t.run("INSERT INTO folders (folder_path) VALUES "+n,u)])];case 3:return o.sent(),[2,Promise.resolve(t)];case 4:return r=o.sent(),this.log.error(r),[2,Promise.reject(r)];case 5:return[2]}}))}))}))})).catch((function(e){throw i.log.error(e),e}))}return e.prototype.uploadFile=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o;return D(this,(function(i){switch(i.label){case 0:return[4,this.db];case 1:return t=i.sent(),n=ge.stripFile(e),r=n[0],o=n[1],[4,t.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",r)];case 2:return i.sent(),[2,t.run("INSERT INTO uploads(filename, path_id) VALUES(?, (SELECT folder_id FROM folders WHERE folder_path = ?))",o,r)]}}))}))},e.prototype.skipFile=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o;return D(this,(function(i){switch(i.label){case 0:return[4,this.db];case 1:return t=i.sent(),n=ge.stripFile(e),r=n[0],o=n[1],[4,t.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",r)];case 2:return i.sent(),[2,t.run("INSERT INTO skips(filename, path_id) VALUES(?, (SELECT folder_id FROM folders WHERE folder_path = ?))",o,r)]}}))}))},e.prototype.splitFile=function(e,t){return F(this,void 0,void 0,(function(){var n,r,o,i,s;return D(this,(function(a){switch(a.label){case 0:return[4,this.db];case 1:return n=a.sent(),r=ge.stripFile(e),o=r[0],i=r[1],s=ge.stripFile(t)[1],[4,n.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",o)];case 2:return a.sent(),[2,n.run("INSERT INTO splits(filename, parent, child_path_id, start, end) VALUES(?, ?, (SELECT folder_id FROM folders WHERE folder_path = ?), CURRENT_TIMESTAMP, NULL)",i,s,o)]}}))}))},e.prototype.splitDone=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o;return D(this,(function(i){switch(i.label){case 0:return[4,this.db];case 1:return t=i.sent(),n=ge.stripFile(e),r=n[0],o=n[1],[2,t.run("UPDATE splits SET end=CURRENT_TIMESTAMP WHERE filename=? AND child_path_id=(SELECT folder_id FROM folders WHERE folder_path=?)",o,r)]}}))}))},e.prototype.splitClean=function(){return F(this,void 0,void 0,(function(){var e=this;return D(this,(function(n){switch(n.label){case 0:return[4,this.db];case 1:return[2,n.sent().all("SELECT splits.filename, folders.folder_path FROM splits INNER JOIN folders ON folders.folder_id = splits.child_path_id WHERE end IS NULL").then((function(n){if(!n)return e.log.info("no split files to clean"),Promise.resolve([]);e.log.info("cleaning "+n.length+" split files"),e.log.debug("going to clean: "+n.map((function(e){return e.filename})).join(" "));var r=n.map((function(e){return t.unlink(g.join(e.folder_path,e.filename)).catch((function(){console.warn("Failed to cleanup "+g.join(e.folder_path,e.filename))}))}));return Promise.all(r)}))]}}))}))},e.prototype.seenUpload=function(e){return F(this,void 0,void 0,(function(){var t,n,r,i;return D(this,(function(s){switch(s.label){case 0:return[4,this.db];case 1:return t=s.sent(),n=ge.stripFile(e),r=n[0],i=n[1],[2,Promise.all([t.get("SELECT * FROM uploads u INNER JOIN folders ON folders.folder_id = u.path_id WHERE u.filename=? AND folders.folder_path=? LIMIT 1",[i,r]),t.get("SELECT * FROM skips s INNER JOIN folders ON folders.folder_id = s.path_id WHERE s.filename=? AND folders.folder_path=? LIMIT 1",i,r)]).then((function(e){return o(e,void 0).length}))]}}))}))},e}(),Ae="https://epi2me.nanoporetech.com",Ne={local:!1,url:Ae,user_agent:"EPI2ME API",region:"eu-west-1",sessionGrace:5,uploadTimeout:1200,downloadTimeout:1200,fileCheckInterval:5,downloadCheckInterval:3,stateCheckInterval:60,inFlightDelay:600,waitTimeSeconds:20,waitTokenError:30,transferPoolSize:3,downloadMode:"data+telemetry",filetype:[".fastq",".fq",".fastq.gz",".fq.gz"],signing:!0,sampleDirectory:"/data"},Ce="\npage\npages\nhasNext\nhasPrevious\ntotalCount\n",We="\nidWorkflowInstance\nstartDate\nworkflowImage{\n  workflow\n  {\n    rev\n    name\n  }\n}\n",Me=function(){var e=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&n.apisecret){e.headers["X-EPI2ME-APIKEY"]=n.apikey,e.headers["X-EPI2ME-SIGNATUREDATE"]=(new Date).toISOString();var r=[Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n"),e.body].join("\n"),o=v.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SIGNATUREV0"]=o}};return{version:"3.0.1510",setHeaders:function(t,r){var o=n({log:{debug:function(){}}},r).log,i=r;if(i||(i={}),t.headers=n({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-CLIENT":i.user_agent||"api","X-EPI2ME-VERSION":i.agent_version||Me.version},t.headers,i.headers),"signing"in i&&!i.signing||e(t,i),i.proxy){var s=i.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=s[2],u=s[3],c={host:s[4],port:s[5]};a&&u&&(c.proxyAuth=a+":"+u),i.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),t.httpsAgent=y({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),t.httpsAgent=b({proxy:c})),t.proxy=!1}}}}(),qe=j(w),Fe=function(e,t){var n=t.headers.keys,r=n.apikey,o=n.apisecret;return delete t.headers.keys,Me.setHeaders(t,{apikey:r,apisecret:o,signing:!0}),qe(e,t)},De=new E({link:new P((function(e){var t=e.getContext(),n=t.apikey,r=t.apisecret,o=t.url,i=x({uri:X(o,"/graphql"),fetch:Fe,headers:{keys:{apikey:n,apisecret:r}}});return T(i,e)})),cache:new _}),Qe=function(e){var t=this;this.createContext=function(e){var r=t.options,o=r.apikey,i=r.apisecret,s=r.url;return n({apikey:o,apisecret:i,url:s},e)},this.query=function(e){return function(n){var r,o=void 0===n?{}:n,i=o.context,s=void 0===i?{}:i,a=o.variables,u=void 0===a?{}:a,c=o.options,l=void 0===c?{}:c,h=t.createContext(s);return r="string"===typeof e?I(we||(we=U(["\n        ","\n      "],["\n        ","\n      "])),e):"function"===typeof e?I(ve||(ve=U(["\n        ","\n      "],["\n        ","\n      "])),e(Ce)):e,t.client.query(q(q({query:r,variables:u},l),{context:h}))}},this.mutate=function(e){return function(n){var r,o=void 0===n?{}:n,i=o.context,s=void 0===i?{}:i,a=o.variables,u=void 0===a?{}:a,c=o.options,l=void 0===c?{}:c,h=t.createContext(s);return r="string"===typeof e?I(ye||(ye=U(["\n        ","\n      "],["\n        ","\n      "])),e):e,t.client.mutate(q(q({mutation:r,variables:u},l),{context:h}))}},this.resetCache=function(){t.client.resetStore()},this.workflows=this.query(I(be||(be=U(["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "],["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "])),Ce,"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowPages=function(e){return F(t,void 0,void 0,(function(){var t,n,r,o=this;return D(this,(function(i){switch(i.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return n=i.sent(),r=function(e){return F(o,void 0,void 0,(function(){return D(this,(function(r){switch(r.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return[2,n=r.sent()]}}))}))},[2,{data:n,next:function(){return r(t+1)},previous:function(){return r(t-1)},first:function(){return r(1)},last:function(){return r(0)}}]}}))}))},this.workflow=this.query(I(ke||(ke=U(["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "],["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "])),"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowInstances=this.query(I(Se||(Se=U(["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "],["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "])),Ce,We)),this.workflowInstance=this.query(I(Ie||(Ie=U(["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "],["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "])),We)),this.startWorkflow=this.mutate(I(_e||(_e=U(["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "],["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "])))),this.stopWorkflow=this.mutate(I(Ee||(Ee=U(["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "],["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "])))),this.instanceToken=this.mutate(I(Pe||(Pe=U(["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "],["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "])))),this.user=this.query(I(Te||(Te=U(["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "],["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "])))),this.updateUser=this.mutate(I(xe||(xe=U(["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "],["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "])))),this.register=this.mutate(I(je||(je=U(["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "],["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "])))),this.status=this.query(I(Oe||(Oe=U(["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "],["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "])))),this.healthCheck=function(){return ge.get("/status",q(q({},t.options),{log:{debug:function(){}}}))},this.regions=this.query(I(Re||(Re=U(["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "],["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "])))),this.options=i({agent_version:ge.version,local:!1,url:Ae,user_agent:"EPI2ME API",signing:!0},e),this.options.url=this.options.url.replace(/:\/\//,"://graphql."),this.options.url=this.options.url.replace(/\/$/,""),this.log=this.options.log,this.client=De},Ue=function(e,t){var n=["","K","M","G","T","P","E","Z"],r=t||0,o=e||0;return o>=1e3?(o/=1e3,(r+=1)>=n.length?"???":Ue(o,r)):0===r?""+o+n[r]:""+o.toFixed(1)+n[r]},ze=function(){function e(e){this.allProfileData={},this.defaultEndpoint=process.env.METRICHOR||Ne.url,e&&(this.allProfileData=n({profiles:{}},e)),this.allProfileData.endpoint&&(this.defaultEndpoint=this.allProfileData.endpoint)}return e.prototype.profile=function(e){return e?n({endpoint:this.defaultEndpoint},n({profiles:{}},this.allProfileData).profiles[e]):{}},e.prototype.profiles=function(){return Object.keys(this.allProfileData.profiles||{})},e}(),Le=function(){function e(e){this.options=i({agent_version:ge.version,local:!1,url:Ae,user_agent:"EPI2ME API",signing:!0},e),this.log=this.options.log,this.cachedResponses={}}return e.prototype.list=function(e){return F(this,void 0,void 0,(function(){var t;return D(this,(function(n){return t=e.match(/^[a-z_]+/i)[0],[2,ge.get(e,this.options).then((function(e){return e[t+"s"]}))]}))}))},e.prototype.read=function(e,t){return F(this,void 0,void 0,(function(){return D(this,(function(n){return[2,ge.get(e+"/"+t,this.options)]}))}))},e.prototype.user=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){return this.options.local?[2,{accounts:[{id_user_account:"none",number:"NONE",name:"None"}]}]:[2,ge.get("user",this.options)]}))}))},e.prototype.status=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){return[2,ge.get("status",this.options)]}))}))},e.prototype.jwt=function(){return F(this,void 0,void 0,(function(){var e;return D(this,(function(t){return e=function(e){return e.headers["x-epi2me-jwt"]?Promise.resolve(e.headers["x-epi2me-jwt"]):Promise.reject(new Error("failed to fetch JWT"))},[2,ge.post("authenticate",{},n({handler:e},this.options))]}))}))},e.prototype.instanceToken=function(e,t){return F(this,void 0,void 0,(function(){return D(this,(function(r){return[2,ge.post("token",n(t,{id_workflow_instance:e}),i({},this.options,{legacy_form:!0}))]}))}))},e.prototype.installToken=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return[2,ge.post("token/install",{id_workflow:e},i({},this.options,{legacy_form:!0}))]}))}))},e.prototype.attributes=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){return[2,this.list("attribute")]}))}))},e.prototype.workflows=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){return[2,this.list("workflow")]}))}))},e.prototype.amiImages=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){if(this.options.local)throw new Error("amiImages unsupported in local mode");return[2,this.list("ami_image")]}))}))},e.prototype.amiImage=function(e,t){return F(this,void 0,void 0,(function(){var n,r,o;return D(this,(function(i){if(e&&t instanceof Object?(n=e,r=t,o="update"):e instanceof Object&&!t?(r=e,o="create"):(o="read",n=e),this.options.local)throw new Error("ami_image unsupported in local mode");if("update"===o)return[2,ge.put("ami_image",n,r,this.options)];if("create"===o)return[2,ge.post("ami_image",r,this.options)];if(!n)throw new Error("no id_ami_image specified");return[2,this.read("ami_image",n)]}))}))},e.prototype.workflow=function(e,t,r){return F(this,void 0,void 0,(function(){var o,i,a,u,c,l,h,f,p,d,g,m,w,v,y,b,k,S=this;return D(this,(function(I){switch(I.label){case 0:if(e&&t&&r instanceof Function?(o=e,i=t,a=r,u="update"):e&&t instanceof Object&&!(t instanceof Function)?(o=e,i=t,u="update"):e instanceof Object&&t instanceof Function?(i=e,a=t,u="create"):e instanceof Object&&!t?(i=e,u="create"):(u="read",o=e,a=t instanceof Function?t:null),"update"!==u)return[3,4];I.label=1;case 1:return I.trys.push([1,3,,4]),[4,ge.put("workflow",o,i,this.options)];case 2:return c=I.sent(),[2,a?a(null,c):Promise.resolve(c)];case 3:return l=I.sent(),[2,a?a(l):Promise.reject(l)];case 4:if("create"!==u)return[3,8];I.label=5;case 5:return I.trys.push([5,7,,8]),[4,ge.post("workflow",i,this.options)];case 6:return h=I.sent(),[2,a?a(null,h):Promise.resolve(h)];case 7:return f=I.sent(),[2,a?a(f):Promise.reject(f)];case 8:if(!o)return p=new Error("no workflow id specified"),[2,a?a(p):Promise.reject(p)];d={},I.label=9;case 9:return I.trys.push([9,11,,12]),[4,this.read("workflow",o)];case 10:if((g=I.sent()).error)throw new Error(g.error);return n(d,g),[3,12];case 11:return m=I.sent(),this.log.error(o+": error fetching workflow "+String(m)),[2,a?a(m):Promise.reject(m)];case 12:n(d,{params:{}}),I.label=13;case 13:return I.trys.push([13,15,,16]),[4,ge.get("workflow/config/"+o,this.options)];case 14:if((w=I.sent()).error)throw new Error(w.error);return n(d,w),[3,16];case 15:return v=I.sent(),this.log.error(o+": error fetching workflow config "+String(v)),[2,a?a(v):Promise.reject(v)];case 16:y=s(d.params,{widget:"ajax_dropdown"}),b=Q(y.map((function(e,t){var n=y[t];return new Promise((function(e,t){var r=n.values.source.replace("{{EPI2ME_HOST}}","").replace(/&?apikey=\{\{EPI2ME_API_KEY\}\}/,"");ge.get(r,S.options).then((function(t){var r=t[n.values.data_root];return r&&(n.values=r.map((function(e){return{label:e[n.values.items.label_key],value:e[n.values.items.value_key]}}))),e()})).catch((function(e){return S.log.error("failed to fetch "+r),t(e)}))}))}))),I.label=17;case 17:return I.trys.push([17,19,,20]),[4,Promise.all(b)];case 18:return I.sent(),[2,a?a(null,d):Promise.resolve(d)];case 19:return k=I.sent(),this.log.error(o+": error fetching config and parameters "+String(k)),[2,a?a(k):Promise.reject(k)];case 20:return[2]}}))}))},e.prototype.startWorkflow=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return[2,ge.post("workflow_instance",e,i({},this.options,{legacy_form:!0}))]}))}))},e.prototype.stopWorkflow=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return[2,ge.put("workflow_instance/stop",e,null,i({},this.options,{legacy_form:!0}))]}))}))},e.prototype.workflowInstances=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return e&&e.run_id?[2,ge.get("workflow_instance/wi?show=all&columns[0][name]=run_id;columns[0][searchable]=true;columns[0][search][regex]=true;columns[0][search][value]="+e.run_id+";",this.options).then((function(e){return e.data.map((function(e){return{id_workflow_instance:e.id_ins,id_workflow:e.id_flo,run_id:e.run_id,description:e.desc,rev:e.rev}}))}))]:[2,this.list("workflow_instance")]}))}))},e.prototype.workflowInstance=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return[2,this.read("workflow_instance",e)]}))}))},e.prototype.workflowConfig=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return[2,ge.get("workflow/config/"+e,this.options)]}))}))},e.prototype.register=function(e,t){return F(this,void 0,void 0,(function(){return D(this,(function(n){return[2,ge.put("reg",e,{description:t||f.userInfo().username+"@"+f.hostname()},i({},this.options,{signing:!1}))]}))}))},e.prototype.datasets=function(e){return F(this,void 0,void 0,(function(){var t;return D(this,(function(n){return(t=e)||(t={}),t.show||(t.show="mine"),[2,this.list("dataset?show="+t.show)]}))}))},e.prototype.dataset=function(e){return F(this,void 0,void 0,(function(){return D(this,(function(t){return this.options.local?[2,this.datasets().then((function(t){return t.find((function(t){return t.id_dataset===e}))}))]:[2,this.read("dataset",e)]}))}))},e.prototype.fetchContent=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o,s;return D(this,(function(a){switch(a.label){case 0:t=i({},this.options,{skip_url_mangle:!0,headers:{"Content-Type":""}}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,ge.head(e,t)];case 2:return r=a.sent(),(n=r.headers.etag)&&this.cachedResponses[e]&&this.cachedResponses[e].etag===n?[2,this.cachedResponses[e].response]:[3,4];case 3:return o=a.sent(),this.log.warn("Failed to HEAD request "+e+": "+String(o)),[3,4];case 4:return[4,ge.get(e,t)];case 5:return s=a.sent(),n&&(this.cachedResponses[e]={etag:n,response:s}),[2,s]}}))}))},e}(),Je=function(){function e(e,t){var r=this;this.debounces={},this.debounceWindow=n({debounceWindow:2e3},t).debounceWindow,this.log=n({log:{debug:function(){}}},t).log,e.jwt().then((function(e){r.socket=O(t.url,{transportOptions:{polling:{extraHeaders:{Cookie:"x-epi2me-jwt="+e}}}}),r.socket.on("connect",(function(){r.log.debug("socket ready")}))})).catch((function(e){r.log.error("socket connection failed - JWT authentication error")}))}return e.prototype.debounce=function(e,t){var r=this,o=n(e)._uuid;if(o){if(this.debounces[o])return;this.debounces[o]=1,setTimeout((function(){delete r.debounces[o]}),this.debounceWindow)}t&&t(e)},e.prototype.watch=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing watch on "+e),void setTimeout((function(){n.watch(e,t)}),1e3);this.socket.on(e,(function(e){return n.debounce(e,t)}))},e.prototype.emit=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing emit on "+e),void setTimeout((function(){n.emit(e,t)}),1e3);this.log.debug("socket emit "+e+" "+JSON.stringify(t)),this.socket.emit(e,t)},e}(),He=function(){function e(e){var t;if((t="string"===typeof e||"object"===typeof e&&e.constructor===String?JSON.parse(e):e||{}).endpoint&&(t.url=t.endpoint,delete t.endpoint),t.log){if(!a([t.log.info,t.log.warn,t.log.error,t.log.debug,t.log.json],u))throw new Error("expected log object to have error, debug, info, warn and json methods");this.log=t.log}else this.log={info:function(e){console.info("["+(new Date).toISOString()+"] INFO: "+e)},debug:function(e){console.debug("["+(new Date).toISOString()+"] DEBUG: "+e)},warn:function(e){console.warn("["+(new Date).toISOString()+"] WARN: "+e)},error:function(e){console.error("["+(new Date).toISOString()+"] ERROR: "+e)},json:function(e){console.log(JSON.stringify(e))}};this.stopped=!0,this.uploadState$=new k(!1),this.analyseState$=new k(!1),this.reportState$=new k(!1),this.instanceTelemetry$=new k(null),this.experimentalWorkerStatus$=new k(null),this.runningStates$=S(this.uploadState$,this.analyseState$,this.reportState$),this.states={upload:{filesCount:0,success:{files:0,bytes:0,reads:0},types:{},niceTypes:"",progress:{bytes:0,total:0}},download:{progress:{},success:{files:0,reads:0,bytes:0},fail:0,types:{},niceTypes:""},warnings:[]},this.liveStates$=new k(this.states),this.config={options:c(t,Ne),instance:{id_workflow_instance:t.id_workflow_instance,inputQueueName:null,outputQueueName:null,outputQueueURL:null,discoverQueueCache:{},bucket:null,bucketFolder:null,remote_addr:null,chain:null,key_id:null}},this.config.instance.awssettings={region:this.config.options.region},this.REST=new Le(n({log:this.log},this.config.options)),this.graphQL=new Qe(n({log:this.log},this.config.options)),this.timers={downloadCheckInterval:null,stateCheckInterval:null,fileCheckInterval:null,transferTimeouts:{},visibilityIntervals:{},summaryTelemetryInterval:null}}return e.prototype.socket=function(){return F(this,void 0,void 0,(function(){var e,t=this;return D(this,(function(r){return this.mySocket?[2,this.mySocket]:(this.mySocket=new Je(this.REST,n({log:this.log},this.config.options)),(e=this.config.instance.id_workflow_instance)&&this.mySocket.watch("workflow_instance:state:"+e,(function(e){var n=t.config.instance;if(n){var r=n.summaryTelemetry,o=Object.entries(n.chain.components).sort((function(e,t){return e[0]-t[0]})).reduce((function(t,n){var o=n[0],i=n[1];if(!e[o])return t;var s=+o,a=s&&Object.keys(r[i.wid])[0]||"ROOT",u=e[o].split(",").map((function(e){return Math.max(0,+e)}));return Q(t,[{running:u[0],complete:u[1],error:u[2],step:s,name:a}])}),[]);t.experimentalWorkerStatus$.next(o)}})),[2,this.mySocket])}))}))},e.prototype.realtimeFeedback=function(e,t){return F(this,void 0,void 0,(function(){return D(this,(function(n){switch(n.label){case 0:return[4,this.socket()];case 1:return n.sent().emit(e,t),[2]}}))}))},e.prototype.stopTimer=function(e){this.timers[e]&&(this.log.debug("clearing "+e+" interval"),clearInterval(this.timers[e]),this.timers[e]=null)},e.prototype.stopAnalysis=function(){return F(this,void 0,void 0,(function(){var e,t;return D(this,(function(n){switch(n.label){case 0:if(this.stopUpload(),this.stopped=!0,!(e=this.config.instance.id_workflow_instance))return[3,8];n.label=1;case 1:return n.trys.push([1,6,,7]),this.config.options.graphQL?[4,this.graphQL.stopWorkflow({variables:{idWorkflowInstance:e}})]:[3,3];case 2:return n.sent(),[3,5];case 3:return[4,this.REST.stopWorkflow(e)];case 4:n.sent(),n.label=5;case 5:return this.analyseState$.next(!1),[3,7];case 6:return t=n.sent(),this.log.error("Error stopping instance: "+String(t)),[2,Promise.reject(t)];case 7:this.log.info("workflow instance "+e+" stopped"),n.label=8;case 8:return[2,Promise.resolve()]}}))}))},e.prototype.stopUpload=function(){return F(this,void 0,void 0,(function(){var e=this;return D(this,(function(t){return this.log.debug("stopping watchers"),["stateCheckInterval","fileCheckInterval"].forEach((function(t){return e.stopTimer(t)})),this.uploadState$.next(!1),[2]}))}))},e.prototype.stopEverything=function(){return F(this,void 0,void 0,(function(){var e=this;return D(this,(function(t){switch(t.label){case 0:return this.stopAnalysis(),Object.keys(this.timers.transferTimeouts).forEach((function(t){e.log.debug("clearing transferTimeout for "+t),clearTimeout(e.timers.transferTimeouts[t]),delete e.timers.transferTimeouts[t]})),Object.keys(this.timers.visibilityIntervals).forEach((function(t){e.log.debug("clearing visibilityInterval for "+t),clearInterval(e.timers.visibilityIntervals[t]),delete e.timers.visibilityIntervals[t]})),this.downloadWorkerPool?(this.log.debug("clearing downloadWorkerPool"),[4,Promise.all(Object.values(this.downloadWorkerPool))]):[3,2];case 1:t.sent(),this.downloadWorkerPool=null,t.label=2;case 2:return["summaryTelemetryInterval","downloadCheckInterval"].forEach((function(t){return e.stopTimer(t)})),[2]}}))}))},e.prototype.reportProgress=function(){var e=this.states,t=e.upload,n=e.download;this.log.json({progress:{download:n,upload:t}})},e.prototype.storeState=function(e,t,n,r){var o=this,i=r||{};this.states[e]||(this.states[e]={}),this.states[e][t]||(this.states[e][t]={}),"incr"===n?Object.keys(i).forEach((function(n){o.states[e][t][n]=o.states[e][t][n]?o.states[e][t][n]+parseInt(i[n],10):parseInt(i[n],10)})):Object.keys(i).forEach((function(n){o.states[e][t][n]=o.states[e][t][n]?o.states[e][t][n]-parseInt(i[n],10):-parseInt(i[n],10)}));try{this.states[e].success.niceReads=Ue(this.states[e].success.reads)}catch(a){this.states[e].success.niceReads=0}try{this.states[e].progress.niceSize=Ue(this.states[e].success.bytes+this.states[e].progress.bytes||0)}catch(a){this.states[e].progress.niceSize=0}try{this.states[e].success.niceSize=Ue(this.states[e].success.bytes)}catch(a){this.states[e].success.niceSize=0}this.states[e].niceTypes=Object.keys(this.states[e].types||{}).sort().map((function(t){return o.states[e].types[t]+" "+t})).join(", ");var s=Date.now();(!this.stateReportTime||s-this.stateReportTime>2e3)&&(this.stateReportTime=s,this.reportProgress()),this.liveStates$.next(q({},this.states))},e.prototype.uploadState=function(e,t,n){return this.storeState("upload",e,t,n)},e.prototype.downloadState=function(e,t,n){return this.storeState("download",e,t,n)},e.prototype.url=function(){return this.config.options.url},e.prototype.apikey=function(){return this.config.options.apikey},e.prototype.attr=function(e,t){if(!(e in this.config.options))throw new Error("config object does not contain property "+e);return t?(this.config.options[e]=t,this):this.config.options[e]},e.prototype.stats=function(e){return this.states[e]},e}();He.version=ge.version,He.Profile=ze,He.REST=Le,He.utils=ge;var Ge=function(){function e(e,t){this.EPI2ME=e,this.options=t,this.masterInstance=new e(this.options),this.log=this.masterInstance.log,this.REST=this.masterInstance.REST,this.graphQL=this.masterInstance.graphQL,this.SampleReader=this.masterInstance.SampleReader,this.utils=e.utils,this.version=e.version,this.runningInstances={}}return e.prototype.startRun=function(e,t){return F(this,void 0,void 0,(function(){var n,r,o,i;return D(this,(function(s){switch(s.label){case 0:n=new this.EPI2ME(q(q({},this.options),e)),s.label=1;case 1:return s.trys.push([1,3,,8]),[4,n.autoStart(t)];case 2:return r=s.sent(),this.runningInstances[r.id_workflow_instance]=n,[3,8];case 3:o=s.sent(),this.log.error("Experienced error starting "+String(o)),s.label=4;case 4:return s.trys.push([4,6,,7]),[4,n.stopEverything()];case 5:return s.sent(),[3,7];case 6:return i=s.sent(),this.log.error("Also experienced error stopping "+String(i)),[3,7];case 7:return[3,8];case 8:return[2,n]}}))}))},e.prototype.startGQLRun=function(e,t){return F(this,void 0,void 0,(function(){var n,r,o,i;return D(this,(function(s){switch(s.label){case 0:n=new this.EPI2ME(q(q(q({},this.options),e),{useGraphQL:!0})),s.label=1;case 1:return s.trys.push([1,3,,8]),[4,n.autoStartGQL(t)];case 2:return r=s.sent(),this.runningInstances[r.id_workflow_instance]=n,console.log(r),[3,8];case 3:o=s.sent(),this.log.error("Experienced error starting "+String(o)),s.label=4;case 4:return s.trys.push([4,6,,7]),[4,n.stopEverything()];case 5:return s.sent(),[3,7];case 6:return i=s.sent(),this.log.error("Also experienced error stopping "+String(i)),[3,7];case 7:return[3,8];case 8:return[2,n]}}))}))},e}();var Be={fastq:function(e){return new Promise((function(n,r){var o=1,i=-1,s={size:0};try{s=t.statSync(e)}catch(a){return void r(a)}t.createReadStream(e).on("data",(function(e){i=-1,o-=1;do{i=e.indexOf(10,i+1),o+=1}while(-1!==i)})).on("end",(function(){return n({type:"fastq",bytes:s.size,reads:Math.floor(o/4)})})).on("error",r)}))},fasta:function(e){return new Promise((function(n,r){var o=1,i=-1,s={size:0};try{s=t.statSync(e)}catch(a){r(a)}t.createReadStream(e).on("data",(function(e){i=-1,o-=1;do{i=e.indexOf(62,i+1),o+=1}while(-1!==i)})).on("end",(function(){return n({type:"fasta",bytes:s.size,sequences:Math.floor((1+o)/2)})})).on("error",r)}))},fastqgz:function(e){return new Promise((function(n,r){var o=1,i=-1,s={size:0};try{s=t.statSync(e)}catch(u){return void r(u)}var a=$();t.createReadStream(e).pipe(a).on("data",(function(e){i=-1,o-=1;do{i=e.indexOf(10,i+1),o+=1}while(-1!==i)})).on("end",(function(){return n({type:"gz",bytes:s.size,reads:Math.floor(o/4)})})).on("error",r)}))},default:function(e){return F(this,void 0,void 0,(function(){return D(this,(function(n){return[2,t.stat(e).then((function(e){return{type:"bytes",bytes:e.size}}))]}))}))}},Ve={fq:"fastq",fa:"fasta"};function Ke(e){if("string"!==typeof e&&!(e instanceof String))return Promise.resolve({});var t=g.extname(e).toLowerCase().replace(/^[.]/,"");(Ve[t]&&(t=Ve[t]),"gz"===t)&&(t=e.split(".").slice(1).reduce((function(e,t){return e+(Ve[t]||t)}),""));return Be[t]||(t="default"),Be[t](e)}var Xe=function(e){function r(o,i){var s=e.call(this,{})||this;s.raiseExceptions=!!i,s.prefsFile=o||r.profilePath(),s.allProfileData={};try{s.allProfileData=n({profiles:{}},t.readJSONSync(s.prefsFile)),s.allProfileData.endpoint&&(s.defaultEndpoint=s.allProfileData.endpoint)}catch(a){if(s.raiseExceptions)throw a}return s}return M(r,e),r.profilePath=function(){return g.join(p(),".epi2me.json")},r.prototype.profile=function(e,r){var o;if(e&&r){n(this.allProfileData,{profiles:(o={},o[e]=r,o)});try{t.writeJSONSync(this.prefsFile,this.allProfileData)}catch(i){if(this.raiseExceptions)throw i}}if(e){if(!this.allProfileData.profiles)throw new Error("cannot read property");return n({endpoint:this.defaultEndpoint},this.allProfileData.profiles[e])}return{}},r}(ze),Ye=function(){function e(e){var t=n({bandwidth:1,interval:500},e);this.bandwidth=t.bandwidth,this.interval=t.interval,this.pipeline=[],this.running=[],this.completed=0,this.intervalId=null,"start"in t&&!t.start||this.start()}return e.MakeQueryablePromise=function(e){if(e.isResolved)return e;var t=!0,n=!1,r=!1,o=e.then((function(e){return r=!0,t=!1,e})).catch((function(e){throw n=!0,t=!1,e}));return o.dependsOn=e,o.isResolved=function(){return r},o.isPending=function(){return t},o.isRejected=function(){return n},o},e.prototype.enqueue=function(e){this.pipeline.push(e)},e.prototype.start=function(){var e=this;this.intervalId||(this.intervalId=setInterval((function(){e.monitorInterval()}),this.interval))},e.prototype.stop=function(){clearInterval(this.intervalId),delete this.intervalId},e.prototype.state=function(){return{queued:this.pipeline.length,running:this.running.length,completed:this.completed,state:this.intervalId?"running":"stopped"}},e.prototype.monitorInterval=function(){var t=this;this.running.map((function(e,t){return e.isPending()?null:t})).filter((function(e){return e})).reverse().forEach((function(e){t.running.splice(e,1),t.completed+=1}));for(var n=this.bandwidth-this.running.length,r=0;r<n;r+=1){var o=this.pipeline.shift();if(!o)return;this.running.push(e.MakeQueryablePromise(o()))}},e}(),Ze=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return M(n,e),n.prototype.workflows=function(n){return F(this,void 0,void 0,(function(){var r,o,i,s;return D(this,(function(a){switch(a.label){case 0:if(!this.options.local)return[2,e.prototype.workflows.call(this,n)];r=g.join(this.options.url,"workflows"),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,t.readdir(r)];case 2:return i=a.sent(),o=i.filter((function(e){return t.statSync(g.join(r,e)).isDirectory()})).map((function(e){return g.join(r,e,"workflow.json")})).map((function(e){return t.readJsonSync(e)})),[2,n?n(null,o):Promise.resolve(o)];case 3:return s=a.sent(),this.log.warn(s),[2,n?n(void 0):Promise.reject(void 0)];case 4:return[2]}}))}))},n.prototype.workflow=function(n,r,o){return F(this,void 0,void 0,(function(){var i,s,a,u;return D(this,(function(c){switch(c.label){case 0:if(!this.options.local||!n||"object"===typeof n||o)return[2,e.prototype.workflow.call(this,n,r,o)];i=g.join(this.options.url,"workflows"),s=g.join(i,n,"workflow.json"),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,t.readJson(s)];case 2:return a=c.sent(),[2,o?o(null,a):Promise.resolve(a)];case 3:return u=c.sent(),[2,o?o(u):Promise.reject(u)];case 4:return[2]}}))}))},n.prototype.workflowInstances=function(n,r){return F(this,void 0,void 0,(function(){var o,i,s,a,u,c;return D(this,(function(l){switch(l.label){case 0:if(!this.options.local)return[2,e.prototype.workflowInstances.call(this,n,r)];if(!n||n instanceof Function||void 0!==r?(o=n,i=r):i=n,i)return s=new Error("querying of local instances unsupported in local mode"),[2,o?o(s):Promise.reject(s)];a=g.join(this.options.url,"instances"),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,t.readdir(a)];case 2:return u=(u=(u=l.sent()).filter((function(e){return t.statSync(g.join(a,e)).isDirectory()}))).map((function(e){var n,r=g.join(a,e,"workflow.json");try{n=t.readJsonSync(r)}catch(o){n={id_workflow:"-",description:"-",rev:"0.0"}}return n.id_workflow_instance=e,n.filename=r,n})),[2,o?o(null,u):Promise.resolve(u)];case 3:return c=l.sent(),[2,o?o(c):Promise.reject(c)];case 4:return[2]}}))}))},n.prototype.datasets=function(n,r){return F(this,void 0,void 0,(function(){var o,i,s,a,u,c;return D(this,(function(l){switch(l.label){case 0:if(!this.options.local)return[2,e.prototype.datasets.call(this,n,r)];if(!n||n instanceof Function||void 0!==r?(o=n,i=r):i=n,i||(i={}),i.show||(i.show="mine"),"mine"!==i.show)return[2,o(new Error("querying of local datasets unsupported in local mode"))];s=g.join(this.options.url,"datasets"),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,t.readdir(s)];case 2:return a=(a=l.sent()).filter((function(e){return t.statSync(g.join(s,e)).isDirectory()})),u=0,a=a.sort().map((function(e){return{is_reference_dataset:!0,summary:null,dataset_status:{status_label:"Active",status_value:"active"},size:0,prefix:e,id_workflow_instance:null,id_account:null,is_consented_human:null,data_fields:null,component_id:null,uuid:e,is_shared:!1,id_dataset:u+=1,id_user:null,last_modified:null,created:null,name:e,source:e,attributes:null}})),[2,o?o(null,a):Promise.resolve(a)];case 3:return c=l.sent(),this.log.warn(c),[2,o?o(null,[]):Promise.resolve([])];case 4:return[2]}}))}))},n.prototype.bundleWorkflow=function(e,t,n){return F(this,void 0,void 0,(function(){return D(this,(function(r){return[2,ge.pipe("workflow/bundle/"+e+".tar.gz",t,this.options,n)]}))}))},n}(Le),et=function(){function e(){this.experiments={}}return e.prototype.getExperiments=function(e){var t=e.sourceDir,n=void 0===t?Ne.sampleDirectory:t,r=e.refresh,o=void 0!==r&&r;return F(this,void 0,void 0,(function(){return D(this,(function(e){switch(e.label){case 0:return Object.keys(this.experiments).length&&!o?[3,2]:[4,this.updateExperiments(n)];case 1:e.sent(),e.label=2;case 2:return[2,this.experiments]}}))}))},e.prototype.updateExperiments=function(e){return void 0===e&&(e=Ne.sampleDirectory),F(this,void 0,void 0,(function(){var t,n;return D(this,(function(r){switch(r.label){case 0:"sequencing_summary",t=(new A).withBasePath().withErrors().filter((function(e){return e.includes("sequencing_summary")})).exclude((function(e){return e.includes("fastq_")})).withMaxDepth(3).crawl(e),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,t.withPromise()];case 2:return n=r.sent(),[3,4];case 3:return r.sent(),[2];case 4:return this.experiments=n.reduce((function(e,t){var n,r=l(t.split(g.sep),3),o=r[0],i=r[1],s=/(?<date>[0-9]{8})_(?<time>[0-9]{4})_.*_(?<flowcell>\w+\d+)_\w+/;if(!s.test(i))return e;var a=null===(n=s.exec(i))||void 0===n?void 0:n.groups,u=a.date,c=a.time,h=a.flowcell,f=u.slice(0,4)+"-"+u.slice(4,6)+"-"+u.slice(6,8),p="T"+c.slice(0,2)+":"+c.slice(2,4)+":00",d=new Date(f+p);return e[o]={startDate:d.toDateString()+" "+d.toLocaleTimeString(),samples:Q(e[o]?e[o].samples:[],[{sample:i,flowcell:h,path:g.dirname(t)+"/fastq_pass"}])},e}),{}),[2]}}))}))},e}(),tt=function(){function e(e,t,r,o,i){if(this.id_workflow_instance=e,this.children=r,this.options=n(o),this.log=this.options.log,this.REST=t,this.graphQL=i,!e)throw new Error("must specify id_workflow_instance");if(!r||!r.length)throw new Error("must specify children to session")}return e.prototype.session=function(){return F(this,void 0,void 0,(function(){var e,t,r,o,i=this;return D(this,(function(s){switch(s.label){case 0:if(this.sts_expiration&&this.sts_expiration>Date.now())return[2,Promise.resolve()];this.log.debug("new instance token needed"),s.label=1;case 1:return s.trys.push([1,6,,7]),this.options.useGraphQL?[4,this.graphQL.instanceToken({variables:{idWorkflowInstance:this.id_workflow_instance}})]:[3,3];case 2:return t=s.sent().data.token,[3,5];case 3:return[4,this.REST.instanceToken(this.id_workflow_instance,this.options)];case 4:t=s.sent(),s.label=5;case 5:return e=t,this.log.debug("allocated new instance token expiring at "+e.expiration),this.sts_expiration=new Date(e.expiration).getTime()-60*parseInt(this.options.sessionGrace||"0",10),r={},this.options.proxy&&n(r,{httpOptions:{agent:N(this.options.proxy,!0)}}),n(r,{region:this.options.region},e),this.children.forEach((function(e){try{e.config.update(r)}catch(t){i.log.warn("failed to update config on "+String(e)+": "+String(t))}})),[3,7];case 6:return o=s.sent(),this.log.warn("failed to fetch instance token: "+String(o)),[3,7];case 7:return[2,Promise.resolve()]}}))}))},e}();function nt(e,r,o,i,s,a){return F(this,void 0,void 0,(function(){var u,c,l,h,f,p,d,m,w,v,y,b=this;return D(this,(function(k){switch(k.label){case 0:return u=4,c=n(r),l=c.maxChunkBytes,h=c.maxChunkReads,f=g.dirname(e),p=g.basename(e),d=p.match(/^[^.]+/),m=d?d[0]:"",w=p.replace(m,""),v=g.join(f,m),l||h?[4,t.stat(e)]:[2,o(e).then((function(){return{source:e,split:!1,chunks:[e]}}))];case 1:return y=k.sent(),l&&y.size<l?[2,o(e).then((function(){return{source:e,split:!1,chunks:[e]}}))]:[2,new Promise((function(r){var c,f,p,d=0,g=0,m="",y=0,k=0,S={source:e,split:!0,chunks:[]},I=[new Promise((function(e){p=e}))];C.createInterface({input:s(e)}).on("line",(function(e){return F(b,void 0,void 0,(function(){return D(this,(function(n){var r;return m+=e,m+="\n",(g+=1)>=u&&(g=0,r=m,F(b,void 0,void 0,(function(){var e;return D(this,(function(n){return y||(c=v+"_"+(d+=1)+w,e=new Promise((function(e,n){var r=c,s=function(){o(r).then((function(){e(r)})).catch((function(e){n(e)})).finally((function(){t.unlink(r).catch((function(e){i.warn("Error unlinking chunk "+r+": "+String(e))}))}))};a?f=a(r,s):(f=t.createWriteStream(r)).on("close",s)})),I.push(e)),y+=1,k+=r.length,f.write(r,(function(){})),(l&&k>=l||h&&y>=h)&&(y=0,k=0,f.end()),[2]}))})),m=""),[2]}))}))})).on("close",(function(){f.end(),p(),Promise.all(I).then((function(e){e.shift(),r(n({chunks:e},S))}))})).on("error",(function(t){i.error("Error chunking "+e+": "+String(t))}))}))]}}))}))}function rt(e,n,r,o){return F(this,void 0,void 0,(function(){return D(this,(function(i){return[2,nt(e,n,r,o,(function(e){return t.createReadStream(e)}))]}))}))}function ot(e,n,r,o){return F(this,void 0,void 0,(function(){return D(this,(function(i){return[2,nt(e,n,r,o,(function(e){return t.createReadStream(e).pipe(R.createGunzip())}),(function(e,n){var r=t.createWriteStream(e);r.on("close",n);var o=R.createGzip();return o.pipe(r),o}))]}))}))}var it=function(){var e=process.env.APPDATA||("darwin"===process.platform?g.join(p(),"Library/Application Support"):p());return process.env.EPI2ME_HOME||g.join(e,"linux"===process.platform?".epi2me":"EPI2ME")},st=function(r){function o(e){var t=r.call(this,e)||this;return t.config.options.inputFolders=t.config.options.inputFolders||[],t.config.options.inputFolder&&t.config.options.inputFolders.push(t.config.options.inputFolder),t.REST=new Ze(n({},{log:t.log},t.config.options)),t.SampleReader=new et,t.uploadsInProgress=[],t}return M(o,r),o.prototype.sessionedS3=function(){return F(this,void 0,void 0,(function(){return D(this,(function(t){switch(t.label){case 0:return this.sessionManager||(this.sessionManager=this.initSessionManager()),[4,this.sessionManager.session()];case 1:return t.sent(),[2,new e.S3({useAccelerateEndpoint:"on"===this.config.options.awsAcceleration})]}}))}))},o.prototype.sessionedSQS=function(){return F(this,void 0,void 0,(function(){return D(this,(function(t){switch(t.label){case 0:return this.sessionManager||(this.sessionManager=this.initSessionManager()),[4,this.sessionManager.session()];case 1:return t.sent(),[2,new e.SQS]}}))}))},o.prototype.deleteMessage=function(e){return F(this,void 0,void 0,(function(){var t,n;return D(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 1:return t=r.sent(),[4,this.sessionedSQS()];case 2:return[2,r.sent().deleteMessage({QueueUrl:t,ReceiptHandle:e.ReceiptHandle}).promise()];case 3:return n=r.sent(),this.log.error("deleteMessage exception: "+String(n)),this.states.download.failure||(this.states.download.failure={}),this.states.download.failure[n]=this.states.download.failure[n]?this.states.download.failure[n]+1:1,[2,Promise.reject(n)];case 4:return[2]}}))}))},o.prototype.discoverQueue=function(e){return F(this,void 0,void 0,(function(){var t,n;return D(this,(function(r){switch(r.label){case 0:if(this.config.instance.discoverQueueCache[e])return[2,Promise.resolve(this.config.instance.discoverQueueCache[e])];this.log.debug("discovering queue for "+e),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,this.sessionedSQS()];case 2:return[4,r.sent().getQueueUrl({QueueName:e}).promise()];case 3:return t=r.sent(),[3,5];case 4:return n=r.sent(),this.log.error("Error: failed to find queue for "+e+": "+String(n)),[2,Promise.reject(n)];case 5:return this.log.debug("found queue "+t.QueueUrl),this.config.instance.discoverQueueCache[e]=t.QueueUrl,[2,Promise.resolve(t.QueueUrl)]}}))}))},o.prototype.queueLength=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o;return D(this,(function(i){switch(i.label){case 0:if(!e)return[2,Promise.reject(new Error("no queueURL specified"))];t=e.match(/([\w\-_]+)$/)[0],this.log.debug("querying queue length of "+t),i.label=1;case 1:return i.trys.push([1,4,,5]),[4,this.sessionedSQS()];case 2:return[4,i.sent().getQueueAttributes({QueueUrl:e,AttributeNames:["ApproximateNumberOfMessages"]}).promise()];case 3:return(null===(n=i.sent())||void 0===n?void 0:n.Attributes)&&"ApproximateNumberOfMessages"in n.Attributes?(r=n.Attributes.ApproximateNumberOfMessages,r=parseInt(r,10)||0,[2,Promise.resolve(r)]):[2,Promise.reject(new Error("unexpected response"))];case 4:return o=i.sent(),this.log.error("error in getQueueAttributes "+String(o)),[2,Promise.reject(o)];case 5:return[2]}}))}))},o.prototype.autoStart=function(e,t){return F(this,void 0,void 0,(function(){var n,r=this;return D(this,(function(o){switch(o.label){case 0:return[4,this.autoStartGeneric(e,(function(){return r.REST.startWorkflow(e)}),t)];case 1:return n=o.sent(),this.setClassConfigREST(n),[2,this.autoConfigure(n,t)]}}))}))},o.prototype.autoStartGQL=function(e,t){return F(this,void 0,void 0,(function(){var n,r=this;return D(this,(function(o){switch(o.label){case 0:return[4,this.autoStartGeneric(e,(function(){return r.graphQL.startWorkflow({variables:e})}),t)];case 1:return n=o.sent(),this.setClassConfigGQL(n),[2,this.autoConfigure(this.config.instance,t)]}}))}))},o.prototype.autoStartGeneric=function(e,t,n){return F(this,void 0,void 0,(function(){var r,o,i;return D(this,(function(s){switch(s.label){case 0:this.stopped=!1,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t()];case 2:return r=s.sent(),this.analyseState$.next(!0),[3,4];case 3:return o=s.sent(),i="Failed to start workflow: "+String(o),this.log.warn(i),[2,n?n(i):Promise.reject(o)];case 4:return this.config.workflow=JSON.parse(JSON.stringify(e)),this.log.info("instance "+JSON.stringify(r)),this.log.info("workflow config "+JSON.stringify(this.config.workflow)),[2,r]}}))}))},o.prototype.autoJoin=function(e,t){return F(this,void 0,void 0,(function(){var n,r,o;return D(this,(function(i){switch(i.label){case 0:this.stopped=!1,this.config.instance.id_workflow_instance=e,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.REST.workflowInstance(e)];case 2:return n=i.sent(),[3,4];case 3:return r=i.sent(),o="Failed to join workflow instance: "+String(r),this.log.warn(o),[2,t?t(o):Promise.reject(r)];case 4:return"stopped"===n.state?(this.log.warn("workflow "+e+" is already stopped"),[2,t?t("could not join workflow"):Promise.reject(new Error("could not join workflow"))]):(this.config.workflow=this.config.workflow||{},this.log.debug("instance "+JSON.stringify(n)),this.log.debug("workflow config "+JSON.stringify(this.config.workflow)),this.setClassConfigREST(n),[2,this.autoConfigure(n,t)])}}))}))},o.prototype.setClassConfigGQL=function(e){var t=e.data.startData,n=t.bucket,r=t.idUser,o=t.remoteAddr,i=t.userDefined,s=void 0===i?{}:i,a=t.instance,u=a.outputqueue,c=a.keyId,l=a.startDate,h=a.idWorkflowInstance,f=a.mappedTelemetry,p=a.chain,d=a.workflowImage,g=d.region.name,m=d.workflow.idWorkflow,w=d.inputqueue,v={bucket:n,user_defined:s,id_user:parseInt(r),remote_addr:o,id_workflow_instance:h,key_id:c,start_date:l,outputQueueName:u,summaryTelemetry:f,inputQueueName:w,id_workflow:parseInt(m),region:g||this.config.options.region,bucketFolder:u+"/"+r+"/"+h,chain:ge.convertResponseToObject(p)};this.config.instance=q(q({},this.config.instance),v)},o.prototype.setClassConfigREST=function(e){var t=this;["id_workflow_instance","id_workflow","remote_addr","key_id","bucket","user_defined","start_date","id_user"].forEach((function(n){t.config.instance[n]=e[n]})),this.config.instance.inputQueueName=e.inputqueue,this.config.instance.outputQueueName=e.outputqueue,this.config.instance.region=e.region||this.config.options.region,this.config.instance.bucketFolder=e.outputqueue+"/"+e.id_user+"/"+e.id_workflow_instance,this.config.instance.summaryTelemetry=e.telemetry,e.chain&&(this.config.instance.chain=ge.convertResponseToObject(e.chain))},o.prototype.initSessionManager=function(t,r){return new tt(this.config.instance.id_workflow_instance,this.REST,Q([e],r||[]),n({sessionGrace:this.config.options.sessionGrace,proxy:this.config.options.proxy,region:this.config.instance.region,log:this.log,useGraphQL:this.config.options.useGraphQL},t),this.graphQL)},o.prototype.autoConfigure=function(e,n){return F(this,void 0,void 0,(function(){var r,o,i,s,a,u=this;return D(this,(function(c){switch(c.label){case 0:if(!this.config.options.inputFolders.length)throw new Error("must set inputFolder");if(!this.config.options.outputFolder)throw new Error("must set outputFolder");if(!this.config.instance.bucketFolder)throw new Error("bucketFolder must be set");if(!this.config.instance.inputQueueName)throw new Error("inputQueueName must be set");if(!this.config.instance.outputQueueName)throw new Error("outputQueueName must be set");return t.mkdirpSync(this.config.options.outputFolder),r=g.join(it(),"instances"),o=g.join(r,this.config.instance.id_workflow_instance),this.db=new $e(o,{idWorkflowInstance:this.config.instance.id_workflow_instance,inputFolders:this.config.options.inputFolders},this.log),i=this.config.instance.id_workflow_instance?"telemetry-"+this.config.instance.id_workflow_instance+".log":"telemetry.log",s=g.join(this.config.options.outputFolder,"epi2me-logs"),a=g.join(s,i),t.mkdirp(s,(function(e){if(e&&!String(e).match(/EEXIST/))u.log.error("error opening telemetry log stream: mkdirpException:"+String(e));else try{u.telemetryLogStream=t.createWriteStream(a,{flags:"a"}),u.log.info("logging telemetry to "+a)}catch(n){u.log.error("error opening telemetry log stream: "+String(n))}})),n&&n(null,this.config.instance),this.timers.summaryTelemetryInterval=setInterval((function(){u.stopped?clearInterval(u.timers.summaryTelemetryInterval):u.fetchTelemetry()}),1e4*this.config.options.downloadCheckInterval),this.timers.downloadCheckInterval=setInterval((function(){u.stopped?clearInterval(u.timers.downloadCheckInterval):u.checkForDownloads()}),1e3*this.config.options.downloadCheckInterval),this.timers.stateCheckInterval=setInterval((function(){return F(u,void 0,void 0,(function(){var e,t,n,r;return D(this,(function(o){switch(o.label){case 0:if(this.stopped)return clearInterval(this.timers.stateCheckInterval),[2];o.label=1;case 1:return o.trys.push([1,10,,11]),e=void 0,this.config.options.useGraphQL?[4,this.graphQL.query("query workflowInstance($idWorkflowInstance: ID!) {\n              instanceObj:workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n                stop_date: stopDate\n                state\n              }\n            }")({variables:{idWorkflowInstance:this.config.instance.id_workflow_instance}})]:[3,3];case 2:return e=o.sent().data.instanceObj,[3,5];case 3:return[4,this.REST.workflowInstance(this.config.instance.id_workflow_instance)];case 4:e=o.sent(),o.label=5;case 5:if("stopped"!==e.state)return[3,9];this.log.warn("instance was stopped remotely at "+e.stop_date+". shutting down the workflow."),o.label=6;case 6:return o.trys.push([6,8,,9]),[4,this.stopEverything()];case 7:return"function"===typeof(t=o.sent()).config.options.remoteShutdownCb&&t.config.options.remoteShutdownCb("instance was stopped remotely at "+e.stop_date),[3,9];case 8:return n=o.sent(),this.log.error("Error whilst stopping: "+String(n)),[3,9];case 9:return[3,11];case 10:return r=o.sent(),this.log.warn("failed to check instance state: "+((null===r||void 0===r?void 0:r.error)?r.error:r)),[3,11];case 11:return[2]}}))}))}),1e3*this.config.options.stateCheckInterval),this.sessionManager=this.initSessionManager(),[4,this.sessionManager.session()];case 1:return c.sent(),this.reportProgress(),this.loadUploadFiles(),this.uploadState$.next(!0),this.timers.fileCheckInterval=setInterval(this.loadUploadFiles.bind(this),1e3*this.config.options.fileCheckInterval),[2,Promise.resolve(e)]}}))}))},o.prototype.stopUpload=function(){return F(this,void 0,void 0,(function(){var e,t;return D(this,(function(n){switch(n.label){case 0:for(e=0,t=this.uploadsInProgress;e<t.length;e++)t[e].abort();return this.uploadsInProgress=[],[4,r.prototype.stopUpload.call(this)];case 1:return n.sent(),this.log.debug("clearing split files"),this.db?[2,this.db.splitClean()]:[2]}}))}))},o.prototype.stopEverything=function(){return F(this,void 0,void 0,(function(){return D(this,(function(e){switch(e.label){case 0:return delete this.sessionManager,[4,r.prototype.stopEverything.call(this)];case 1:return e.sent(),[2]}}))}))},o.prototype.checkForDownloads=function(){return F(this,void 0,void 0,(function(){var e,t,n;return D(this,(function(r){switch(r.label){case 0:if(this.checkForDownloadsRunning)return[2,Promise.resolve()];this.checkForDownloadsRunning=!0,this.log.debug("checkForDownloads checking for downloads"),r.label=1;case 1:return r.trys.push([1,7,,8]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 2:return e=r.sent(),[4,this.queueLength(e)];case 3:return(t=r.sent())?[3,4]:(this.log.debug("no downloads available"),[3,6]);case 4:return this.log.debug("downloads available: "+t),[4,this.downloadAvailable()];case 5:r.sent(),r.label=6;case 6:return[3,8];case 7:return n=r.sent(),this.log.warn("checkForDownloads error "+String(n)),this.states.download.failure||(this.states.download.failure={}),this.states.download.failure[n]=this.states.download.failure[n]?this.states.download.failure[n]+1:1,[3,8];case 8:return this.checkForDownloadsRunning=!1,[2,Promise.resolve()]}}))}))},o.prototype.downloadAvailable=function(){return F(this,void 0,void 0,(function(){var e,t,n,r;return D(this,(function(o){switch(o.label){case 0:if((e=Object.keys(this.downloadWorkerPool||{}).length)>=this.config.options.transferPoolSize)return this.log.debug(e+" downloads already queued"),[2,Promise.resolve()];o.label=1;case 1:return o.trys.push([1,5,,6]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 2:return n=o.sent(),this.log.debug("fetching messages"),[4,this.sessionedSQS()];case 3:return[4,o.sent().receiveMessage({AttributeNames:["All"],QueueUrl:n,VisibilityTimeout:this.config.options.inFlightDelay,MaxNumberOfMessages:this.config.options.transferPoolSize-e,WaitTimeSeconds:this.config.options.waitTimeSeconds}).promise()];case 4:return t=o.sent(),[3,6];case 5:return r=o.sent(),this.log.error("receiveMessage exception: "+String(r)),this.states.download.failure[r]=this.states.download.failure[r]?this.states.download.failure[r]+1:1,[2,Promise.reject(r)];case 6:return[2,this.receiveMessages(t)]}}))}))},o.prototype.loadUploadFiles=function(){return F(this,void 0,void 0,(function(){var e,t,n,r,o,i=this;return D(this,(function(s){switch(s.label){case 0:if(this.dirScanInProgress)return[2,Promise.resolve()];this.dirScanInProgress=!0,this.log.debug("upload: started directory scan"),s.label=1;case 1:return s.trys.push([1,6,,7]),e=function(e){return i.db.seenUpload(e)},[4,ge.loadInputFiles(this.config.options,this.log,e)];case 2:t=s.sent(),n=0,r=function(){return new Promise((function(e){if(i.stopped)return t.length=0,i.log.debug("upload: skipping, stopped"),void e();if(n>i.config.options.transferPoolSize)setTimeout(e,1e3);else{var r=t.splice(0,i.config.options.transferPoolSize-n);n+=r.length,i.enqueueUploadFiles(r).then().catch((function(e){i.log.error("upload: exception in enqueueUploadFiles: "+String(e))})).finally((function(){n-=r.length,e()}))}}))},s.label=3;case 3:return t.length?[4,r()]:[3,5];case 4:return s.sent(),[3,3];case 5:return[3,7];case 6:return o=s.sent(),this.log.error("upload: exception in loadInputFiles: "+String(o)),[3,7];case 7:return this.dirScanInProgress=!1,this.log.debug("upload: finished directory scan"),[2,Promise.resolve()]}}))}))},o.prototype.enqueueUploadFiles=function(e){return F(this,void 0,void 0,(function(){var t,n,r,o,i,s,a,u,c,l=this;return D(this,(function(f){switch(f.label){case 0:if(t=0,n=0,r=0,o=0,i={},!h(e)||!e.length)return[2,Promise.resolve()];if(this.log.info("enqueueUploadFiles "+e.length+" files: "+e.map((function(e){return e.path})).join(" ")+"."),"workflow"in this.config&&("workflow_attributes"in this.config.workflow?i=this.config.workflow.workflow_attributes:"attributes"in this.config.workflow&&((s=this.config.workflow.attributes)||(s={}),["max_size","max_files","split_size","split_reads"].forEach((function(e){"epi2me:"+e in s&&(i[e]=parseInt(s["epi2me:"+e],10))})),"epi2me:category"in s&&s["epi2me:category"].includes("storage")&&(i.requires_storage=!0))),this.log.info("enqueueUploadFiles settings "+JSON.stringify(i)),"requires_storage"in i&&i.requires_storage&&!("storage_account"in this.config.workflow))return a={msg:"ERROR: Workflow requires storage enabled. Please provide a valid storage account [ --storage ].",type:"WARNING_STORAGE_ENABLED"},this.log.error(a.msg),this.states.warnings.push(a),[2,Promise.resolve()];if("split_size"in i&&(r=parseInt(i.split_size,10),this.log.info("enqueueUploadFiles splitting supported files at "+r+" bytes")),"split_reads"in i&&(o=parseInt(i.split_reads,10),this.log.info("enqueueUploadFiles splitting supported files at "+o+" reads")),"max_size"in i&&(n=parseInt(i.max_size,10),this.log.info("enqueueUploadFiles restricting file size to "+n)),"max_files"in i&&(t=parseInt(i.max_files,10),this.log.info("enqueueUploadFiles restricting file count to "+t),e.length>t))return a={msg:"ERROR: "+e.length+" files found. Workflow can only accept "+t+". Please move the extra files away.",type:"WARNING_FILE_TOO_MANY"},this.log.error(a.msg),this.states.warnings.push(a),[2,Promise.resolve()];this.states.upload.filesCount+=e.length,u=e.map((function(e){return F(l,void 0,void 0,(function(){var i,s,a,u,c,l,h,f,p,d,m,w,v,y=this;return D(this,(function(b){switch(b.label){case 0:return i=e,t&&this.states.upload.filesCount>t?(p="Maximum "+t+" file(s) already uploaded. Marking "+i.relative+" as skipped.",d={msg:p,type:"WARNING_FILE_TOO_MANY"},this.log.error(p),this.states.warnings.push(d),this.states.upload.filesCount-=1,i.skip="SKIP_TOO_MANY",[3,11]):[3,1];case 1:return 0!==i.size?[3,2]:(p='The file "'+i.relative+'" is empty. It will be skipped.',d={msg:p,type:"WARNING_FILE_EMPTY"},i.skip="SKIP_EMPTY",this.states.upload.filesCount-=1,this.log.error(p),this.states.warnings.push(d),[3,11]);case 2:if(!((null===(v=i.path)||void 0===v?void 0:v.match(/\.(?:fastq|fq)(?:\.gz)?$/))&&(r&&i.size>r||o)))return[3,7];p=i.relative+(i.size>r?" is too big and":"")+" is going to be split",this.log.warn(p),d={msg:p,type:"WARNING_FILE_SPLIT"},this.states.warnings.push(d),s=r?{maxChunkBytes:r}:{maxChunkReads:o},a=i.path.match(/\.gz$/)?ot:rt,u=ge.getFileID(),c=new Ye({bandwidth:this.config.options.transferPoolSize}),l=0,h=function(e){return F(y,void 0,void 0,(function(){var t=this;return D(this,(function(n){switch(n.label){case 0:return this.log.debug("chunkHandler for "+e),[4,this.db.splitFile(e,i.path)];case 1:return n.sent(),this.stopped?(c.stop(),this.log.info("stopped, so skipping "+e),[2,Promise.reject(new Error("stopped"))]):(l+=1,[2,Ke(e).then((function(n){return{name:g.basename(e),path:e,relative:e.replace(t.config.options.inputFolder,""),id:u+"_"+l,stats:n,size:n.bytes}})).then((function(e){return F(t,void 0,void 0,(function(){var t=this;return D(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){c.enqueue((function(){return t.log.info("chunk upload starting "+e.id+" "+e.path),t.stopped?(t.log.info("chunk upload skipped (stopped) "+e.id+" "+e.path),c.stop(),n(),Promise.resolve()):t.uploadJob(e).then((function(){return t.db.splitDone(e.path)})).catch((function(n){t.log.error("chunk upload failed "+e.id+" "+e.path+": "+String(n))})).finally(n)}))}))];case 1:return n.sent(),[2]}}))}))}))])}}))}))},b.label=3;case 3:return b.trys.push([3,5,,6]),[4,a(i.path,s,h,this.log)];case 4:return b.sent(),c.stop(),[3,6];case 5:if(f=b.sent(),c.stop(),"Error: stopped"===String(f))return[2,Promise.resolve()];throw f;case 6:return[2,this.db.uploadFile(i.path)];case 7:return n&&i.size>n?(p='The file "'+i.relative+'" is bigger than the maximum size limit ('+Ue(n)+"B). It will be skipped.",d={msg:p,type:"WARNING_FILE_TOO_BIG"},i.skip="SKIP_TOO_BIG",this.states.upload.filesCount-=1,this.log.error(p),this.states.warnings.push(d),[3,11]):[3,8];case 8:return b.trys.push([8,10,,11]),m=i,[4,Ke(i.path)];case 9:return m.stats=b.sent(),[3,11];case 10:return w=b.sent(),this.log.error("failed to stat "+i.path+": "+String(w)),[3,11];case 11:return[2,this.uploadJob(i)]}}))}))})),f.label=1;case 1:return f.trys.push([1,3,,4]),[4,Promise.all(u)];case 2:return f.sent(),this.log.info("upload: inputBatchQueue ("+u.length+" jobs) complete"),[2,this.loadUploadFiles()];case 3:return c=f.sent(),this.log.error("upload: enqueueUploadFiles exception "+String(c)),[2,Promise.reject(c)];case 4:return[2]}}))}))},o.prototype.uploadJob=function(e){return F(this,void 0,void 0,(function(){var t,r,o,i,s;return D(this,(function(a){switch(a.label){case 0:if("skip"in e)return[2,this.db.skipFile(e.path)];a.label=1;case 1:return a.trys.push([1,3,,4]),this.log.info("upload: "+e.id+" starting"),[4,this.uploadHandler(e)];case 2:return t=a.sent(),this.log.info("upload: "+t.id+" uploaded and notified"),[3,4];case 3:return o=a.sent(),r=o,this.log.error("upload: "+e.id+" done, but failed: "+String(r)),[3,4];case 4:if(t||(t={}),r){if(this.log.error("uploadJob "+r),this.states.upload.failure||(this.states.upload.failure={}),this.states.upload.failure[r]=this.states.upload.failure[r]?this.states.upload.failure[r]+1:1,String(r).match(/AWS.SimpleQueueService.NonExistentQueue/))return this.log.error("instance stopped because of a fatal error"),[2,this.stopEverything()]}else this.uploadState("success","incr",n({files:1},t.stats)),t.name&&(i=g.extname(t.name),this.uploadState("types","incr",((s={})[i]=1,s)));return[2,Promise.resolve()]}}))}))},o.prototype.receiveMessages=function(e){return F(this,void 0,void 0,(function(){var t=this;return D(this,(function(n){return e&&e.Messages&&e.Messages.length?(this.downloadWorkerPool||(this.downloadWorkerPool={}),e.Messages.forEach((function(e){t.downloadWorkerPool[e.MessageId]=1;var n=setTimeout((function(){throw t.log.error("this.downloadWorkerPool timeoutHandle. Clearing queue slot for message: "+e.MessageId),new Error("download timed out")}),1e3*(60+t.config.options.downloadTimeout));t.processMessage(e).catch((function(e){t.log.error("processMessage "+String(e))})).finally((function(){clearTimeout(n),e&&delete t.downloadWorkerPool[e.MessageId]}))})),this.log.info("downloader queued "+e.Messages.length+" messages for processing"),[2,Promise.resolve()]):(this.log.info("complete (empty)"),[2,Promise.resolve()])}))}))},o.prototype.processMessage=function(e){var r,o,i,s,a,u,c;return F(this,void 0,void 0,(function(){var l,h,f,p,m,w,v,y,b,k,S,I,_,E,P,T,x,j,O=this;return D(this,(function(R){switch(R.label){case 0:if(!e)return this.log.debug("download.processMessage: empty message"),[2,Promise.resolve()];"Attributes"in e&&"ApproximateReceiveCount"in e.Attributes&&this.log.debug("download.processMessage: "+e.MessageId+" / "+e.Attributes.ApproximateReceiveCount),R.label=1;case 1:return R.trys.push([1,2,,7]),l=JSON.parse(e.Body),[3,7];case 2:f=R.sent(),this.log.error("error parsing JSON message.Body from message: "+JSON.stringify(e)+" "+String(f)),R.label=3;case 3:return R.trys.push([3,5,,6]),[4,this.deleteMessage(e)];case 4:return R.sent(),[3,6];case 5:return p=R.sent(),this.log.error("Exception deleting message: "+String(p)),[3,6];case 6:return[2,Promise.resolve()];case 7:if(!l.telemetry)return[3,13];if(!(m=l.telemetry).tm_path)return[3,12];R.label=8;case 8:return R.trys.push([8,11,,12]),this.log.debug("download.processMessage: "+e.MessageId+" fetching telemetry"),[4,this.sessionedS3()];case 9:return[4,R.sent().getObject({Bucket:l.bucket,Key:m.tm_path}).promise()];case 10:return w=R.sent(),this.log.info("download.processMessage: "+e.MessageId+" fetched telemetry"),m.batch=w.Body.toString("utf-8").split("\n").filter((function(e){return(null===e||void 0===e?void 0:e.length)>0})).map((function(e){try{return JSON.parse(e)}catch(t){return O.log.error("Telemetry Batch JSON Parse error: "+String(t)),e}})),[3,12];case 11:return v=R.sent(),this.log.error("Could not fetch telemetry JSON: "+String(v)),[3,12];case 12:try{this.telemetryLogStream.write(JSON.stringify(m)+d)}catch($){this.log.error("error writing telemetry: "+$)}this.config.options.telemetryCb&&this.config.options.telemetryCb(m),R.label=13;case 13:if(!l.path)return this.log.warn("nothing to download"),[2,Promise.resolve()];if(y=l.path.match(/[\w\W]*\/([\w\W]*?)$/),b=y?y[1]:"",h=g.join(this.config.options.outputFolder,this.config.instance.id_workflow_instance||""),(null===(o=null===(r=l.telemetry)||void 0===r?void 0:r.hints)||void 0===o?void 0:o.folder)&&(this.log.debug("using folder hint "+l.telemetry.hints.folder),k=l.telemetry.hints.folder.split("/").map((function(e){return e.toUpperCase()})),h=g.join.apply(null,Q([h],k))),t.mkdirpSync(h),S=g.join(h,b),"data+telemetry"!==this.config.options.downloadMode)return[3,18];I=[""],("string"===typeof(_=(null===(a=null===(s=null===(i=this.config)||void 0===i?void 0:i.workflow)||void 0===s?void 0:s.settings)||void 0===a?void 0:a.output_format)?this.config.workflow.settings.output_format:[])||_ instanceof String)&&(_=_.trim().split(/[\s,]+/));try{I.push.apply(I,_)}catch(A){this.log.error("Failed to work out workflow file suffixes: "+String(A))}R.label=14;case 14:return R.trys.push([14,16,,17]),E=I.map((function(t){var n=l.path+t,r=S+t;return O.log.debug("download.processMessage: "+e.MessageId+" downloading "+n+" to "+r),new Promise((function(o,i){O.initiateDownloadStream({bucket:l.bucket,path:n},e,r).then(o).catch((function(e){O.log.error("Caught exception waiting for initiateDownloadStream: "+String(e)),t?i(e):o()}))}))})),[4,Promise.all(E)];case 15:return R.sent(),[3,17];case 16:return P=R.sent(),this.log.error("Exception fetching file batch: "+String(P)),[3,17];case 17:try{(T=!(null===(u=l.telemetry)||void 0===u||!u.json)&&l.telemetry.json.exit_status)&&this.config.options.dataCb&&this.config.options.dataCb(S,T)}catch(N){this.log.warn("failed to fire data callback: "+N)}return[3,19];case 18:x=(null===(c=l.telemetry.batch_summary)||void 0===c?void 0:c.reads_num)?l.telemetry.batch_summary.reads_num:1,this.downloadState("success","incr",{files:1,reads:x}),R.label=19;case 19:return R.trys.push([19,21,,22]),[4,this.deleteMessage(e)];case 20:return R.sent(),[3,22];case 21:return j=R.sent(),this.log.error("Exception deleting message: "+String(j)),[3,22];case 22:return this.realtimeFeedback("workflow_instance:state",{type:"stop",id_workflow_instance:this.config.instance.id_workflow_instance,id_workflow:this.config.instance.id_workflow,component_id:"0",message_id:n(e).MessageId,id_user:this.config.instance.id_user}).catch((function(e){O.log.warn("realtimeFeedback failed: "+String(e))})),[2,Promise.resolve()]}}))}))},o.prototype.initiateDownloadStream=function(e,r,o){return F(this,void 0,void 0,(function(){var i=this;return D(this,(function(s){return[2,new Promise((function(s,a){return F(i,void 0,void 0,(function(){var i,u,c,l,h,f,p,d,m,w=this;return D(this,(function(v){switch(v.label){case 0:return v.trys.push([0,2,,3]),[4,this.sessionedS3()];case 1:return i=v.sent(),[3,3];case 2:return u=v.sent(),a(u),[3,3];case 3:h=function(n){if(w.log.error("Error during stream of bucket="+e.bucket+" path="+e.path+" to file="+o+" "+String(n)),clearTimeout(w.timers.transferTimeouts[o]),delete w.timers.transferTimeouts[o],!c.networkStreamError)try{c.networkStreamError=1,c.close(),t.remove(o).then((function(){w.log.warn("removed failed download "+o)})).catch((function(e){w.log.warn("failed to remove "+o+". unlinkException: "+String(e))})),l.destroy&&(w.log.error("destroying read stream for "+o),l.destroy())}catch(r){w.log.error("error handling stream error: "+String(r))}};try{f={Bucket:e.bucket,Key:e.path},c=t.createWriteStream(o),(p=i.getObject(f)).on("httpHeaders",(function(e,t){w.downloadState("progress","incr",{total:parseInt(t["content-length"],10)})})),l=p.createReadStream()}catch(y){return this.log.error("getObject/createReadStream exception: "+String(y)),a(y),[2]}return l.on("error",h),c.on("finish",(function(){return F(w,void 0,void 0,(function(){var e,t,r,i;return D(this,(function(s){switch(s.label){case 0:if(c.networkStreamError)return[2];this.log.debug("downloaded "+o),s.label=1;case 1:return s.trys.push([1,3,,4]),e=g.extname(o),[4,Ke(o)];case 2:return t=s.sent(),this.downloadState("success","incr",n({files:1},t)),this.downloadState("types","incr",((i={})[e]=1,i)),this.downloadState("progress","decr",{total:t.bytes,bytes:t.bytes}),[3,4];case 3:return r=s.sent(),this.log.warn("failed to stat "+o+": "+String(r)),[3,4];case 4:return this.reportProgress(),[2]}}))}))})),c.on("close",(function(t){w.log.debug("closing writeStream "+o),t&&w.log.error("error closing write stream "+t),clearInterval(w.timers.visibilityIntervals[o]),delete w.timers.visibilityIntervals[o],clearTimeout(w.timers.transferTimeouts[o]),delete w.timers.transferTimeouts[o],setTimeout(w.checkForDownloads.bind(w)),w.log.info("download.initiateDownloadStream: "+r.MessageId+" downloaded "+e.path+" to "+o),s()})),c.on("error",h),d=function(){h(new Error("transfer timed out"))},this.timers.transferTimeouts[o]=setTimeout(d,1e3*this.config.options.downloadTimeout),m=function(){return F(w,void 0,void 0,(function(){var e,t,n;return D(this,(function(i){switch(i.label){case 0:this.stopped&&(clearInterval(this.timers.visibilityIntervals[o]),delete this.timers.visibilityIntervals[o]),e=this.config.instance.outputQueueURL,t=r.ReceiptHandle,this.log.debug({message_id:r.MessageId},"updateVisibility"),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.sqs.changeMessageVisibility({QueueUrl:e,ReceiptHandle:t,VisibilityTimeout:this.config.options.inFlightDelay}).promise()];case 2:return i.sent(),[3,4];case 3:return n=i.sent(),this.log.error({message_id:r.MessageId,queue:e,error:n},"Error setting visibility"),clearInterval(this.timers.visibilityIntervals[o]),[3,4];case 4:return[2]}}))}))},this.timers.visibilityIntervals[o]=setInterval(m,900*this.config.options.inFlightDelay),l.on("data",(function(e){clearTimeout(w.timers.transferTimeouts[o]),w.timers.transferTimeouts[o]=setTimeout(d,1e3*w.config.options.downloadTimeout),w.downloadState("progress","incr",{bytes:e.length})})).pipe(c),[2]}}))}))}))]}))}))},o.prototype.uploadHandler=function(e){return F(this,void 0,void 0,(function(){var n,r,o,i,s,a=this;return D(this,(function(u){switch(u.label){case 0:return[4,this.sessionedS3()];case 1:return n=u.sent(),o=e.relative.replace(/^[\\/]+/,"").replace(/\\/g,"/").replace(/\//g,"_"),i=[this.config.instance.bucketFolder,"component-0",o,o].join("/").replace(/\/+/g,"/"),[2,new Promise((function(o,u){var c=function(){r&&!r.closed&&r.close(),u(new Error(e.name+" timed out"))};s=setTimeout(c,1e3*(a.config.options.uploadTimeout+5));try{r=t.createReadStream(e.path)}catch(l){return clearTimeout(s),void u(l)}r.on("error",(function(e){r.close();var t="error in upload readstream";(null===e||void 0===e?void 0:e.message)&&(t+=": "+e.message),clearTimeout(s),u(new Error(t))})),r.on("open",(function(){var t={Bucket:a.config.instance.bucket,Key:i,Body:r};a.config.instance.key_id&&(t.SSEKMSKeyId=a.config.instance.key_id,t.ServerSideEncryption="aws:kms"),e.size&&(t["Content-Length"]=e.size),a.uploadState("progress","incr",{total:e.size});var l=0,h=n.upload(t,{partSize:10485760,queueSize:1});a.uploadsInProgress.push(h);var f=a.initSessionManager(null,[h.service]);f.sts_expiration=a.sessionManager.sts_expiration,h.on("httpUploadProgress",(function(e){return F(a,void 0,void 0,(function(){var t;return D(this,(function(n){switch(n.label){case 0:this.uploadState("progress","incr",{bytes:e.loaded-l}),l=e.loaded,clearTimeout(s),s=setTimeout(c,1e3*(this.config.options.uploadTimeout+5)),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,f.session()];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),this.log.warn("Error refreshing token: "+String(t)),[3,4];case 4:return[2]}}))}))})),h.promise().then((function(){a.log.info(e.id+" S3 upload complete"),r.close(),clearTimeout(s),a.uploadComplete(i,e).then((function(){o(e)})).catch((function(e){console.log("catch"),u(e)})).finally((function(){a.uploadState("progress","decr",{total:e.size,bytes:e.size}),a.uploadsInProgress=a.uploadsInProgress.filter((function(e){return e!==h}))}))})).catch((function(t){a.log.warn(e.id+" uploadStreamError "+t),u(t)}))}))}))]}}))}))},o.prototype.uploadComplete=function(e,t){return F(this,void 0,void 0,(function(){var r,o,i,s,a,u=this;return D(this,(function(c){switch(c.label){case 0:if(this.log.info(t.id+" uploaded to S3: "+e),r={bucket:this.config.instance.bucket,outputQueue:this.config.instance.outputQueueName,remote_addr:this.config.instance.remote_addr,user_defined:this.config.instance.user_defined||null,apikey:this.config.options.apikey,id_workflow_instance:this.config.instance.id_workflow_instance,id_master:this.config.instance.id_workflow,utc:(new Date).toISOString(),path:e,prefix:e.substring(0,e.lastIndexOf("/"))},this.config.instance.chain)try{r.components=JSON.parse(JSON.stringify(this.config.instance.chain.components)),r.targetComponentId=this.config.instance.chain.targetComponentId}catch(l){return this.log.error(t.id+" exception parsing components JSON "+String(l)),[2,Promise.reject(l)]}if(this.config.instance.key_id&&(r.key_id=this.config.instance.key_id),this.config.options.agent_address)try{r.agent_address=JSON.parse(this.config.options.agent_address)}catch(h){this.log.error(t.id+" Could not parse agent_address "+String(h))}r.components&&Object.keys(r.components).forEach((function(e){"uploadMessageQueue"===r.components[e].inputQueueName&&(r.components[e].inputQueueName=u.uploadMessageQueue),"downloadMessageQueue"===r.components[e].inputQueueName&&(r.components[e].inputQueueName=u.downloadMessageQueue)})),o={},c.label=1;case 1:return c.trys.push([1,5,,6]),[4,this.discoverQueue(this.config.instance.inputQueueName)];case 2:return i=c.sent(),[4,this.sessionedSQS()];case 3:return s=c.sent(),this.log.info(t.id+" sending SQS message to input queue"),[4,s.sendMessage({QueueUrl:i,MessageBody:JSON.stringify(r)}).promise()];case 4:return o=c.sent(),[3,6];case 5:return a=c.sent(),this.log.error(t.id+" exception sending SQS message: "+String(a)),[2,Promise.reject(a)];case 6:return this.realtimeFeedback("workflow_instance:state",{type:"start",id_workflow_instance:this.config.instance.id_workflow_instance,id_workflow:this.config.instance.id_workflow,component_id:"0",message_id:n(o).MessageId,id_user:this.config.instance.id_user}).catch((function(e){u.log.warn("realtimeFeedback failed: "+String(e))})),this.log.info(t.id+" SQS message sent. Mark as uploaded"),[2,this.db.uploadFile(t.path)]}}))}))},o.prototype.fetchTelemetry=function(){var e,n;return F(this,void 0,void 0,(function(){var r,o,i,s,a,u=this;return D(this,(function(c){switch(c.label){case 0:if(!(null===(n=null===(e=this.config)||void 0===e?void 0:e.instance)||void 0===n?void 0:n.summaryTelemetry))return[2,Promise.resolve()];r=g.join(it(),"instances"),o=g.join(r,this.config.instance.id_workflow_instance),i=[],Object.keys(this.config.instance.summaryTelemetry).forEach((function(e){var n=u.config.instance.summaryTelemetry[e]||{},r=n[Object.keys(n)[0]];if(r){r.startsWith("http")||(r=X(u.config.options.url,r));var s=g.join(o,e+".json");i.push(u.REST.fetchContent(r).then((function(e){return t.writeJSONSync(s,e),u.reportState$.next(!0),u.log.debug("fetched telemetry summary "+s),Promise.resolve(e)})).catch((function(e){return u.log.debug("Error fetching telemetry: "+String(e)),Promise.resolve(null)})))}})),s=0,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,Promise.all(i)];case 2:return a=c.sent(),this.instanceTelemetry$.next(a),[3,4];case 3:return c.sent(),s+=1,[3,4];case 4:return s&&this.log.warn("summary telemetry incomplete"),[2,Promise.resolve()]}}))}))},o}(He);st.version=ge.version,st.REST=Ze,st.utils=ge,st.SessionManager=tt,st.EPI2ME_HOME=it(),st.Profile=Xe,st.Factory=Ge;export default st;
