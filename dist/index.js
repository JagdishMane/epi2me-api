/**
 * Copyright Metrichor Ltd. (An Oxford Nanopore Technologies Company) 2020
 */

"use strict";function e(e){return e&&"object"===typeof e&&"default"in e?e.default:e}var t=e(require("aws-sdk")),n=e(require("fs-extra")),r=require("lodash"),i=require("os"),o=e(i),s=e(require("path")),a=e(require("sqlite")),u=e(require("axios")),c=e(require("crypto")),l=require("tunnel"),h=require("rxjs"),f=e(require("graphql-tag")),p=require("apollo-cache-inmemory"),d=e(require("apollo-client")),g=require("apollo-link"),m=require("apollo-link-http"),w=require("@lifeomic/axios-fetch"),v=e(require("socket.io-client")),y=require("zlib"),b=e(y),k=e(require("fdir")),S=e(require("proxy-agent")),I=e(require("readline")),_=function(e,t){return(_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function E(e,t){function n(){this.constructor=e}_(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var P=function(){return(P=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function T(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(t){o(t)}}function a(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))}function x(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(a){o=[6,a],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function j(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function O(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var R="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};function A(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===t||null===t)&&n.path)}},n.exports),n.exports}var $=A((function(e,t){!function(n){var r=t&&!t.nodeType&&t,i=e&&!e.nodeType&&e,o="object"==typeof R&&R;o.global!==o&&o.window!==o&&o.self!==o||(n=o);var s,a,u=2147483647,c=/^xn--/,l=/[^\x20-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,f={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},p=Math.floor,d=String.fromCharCode;function g(e){throw RangeError(f[e])}function m(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function w(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+m((e=e.replace(h,".")).split("."),t).join(".")}function v(e){for(var t,n,r=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function y(e){return m(e,(function(e){var t="";return e>65535&&(t+=d((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=d(e)})).join("")}function b(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function k(e,t,n){var r=0;for(e=n?p(e/700):e>>1,e+=p(e/t);e>455;r+=36)e=p(e/35);return p(r+36*e/(e+38))}function S(e){var t,n,r,i,o,s,a,c,l,h,f,d=[],m=e.length,w=0,v=128,b=72;for((n=e.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&g("not-basic"),d.push(e.charCodeAt(r));for(i=n>0?n+1:0;i<m;){for(o=w,s=1,a=36;i>=m&&g("invalid-input"),((c=(f=e.charCodeAt(i++))-48<10?f-22:f-65<26?f-65:f-97<26?f-97:36)>=36||c>p((u-w)/s))&&g("overflow"),w+=c*s,!(c<(l=a<=b?1:a>=b+26?26:a-b));a+=36)s>p(u/(h=36-l))&&g("overflow"),s*=h;b=k(w-o,t=d.length+1,0==o),p(w/t)>u-v&&g("overflow"),v+=p(w/t),w%=t,d.splice(w++,0,v)}return y(d)}function I(e){var t,n,r,i,o,s,a,c,l,h,f,m,w,y,S,I=[];for(m=(e=v(e)).length,t=128,n=0,o=72,s=0;s<m;++s)(f=e[s])<128&&I.push(d(f));for(r=i=I.length,i&&I.push("-");r<m;){for(a=u,s=0;s<m;++s)(f=e[s])>=t&&f<a&&(a=f);for(a-t>p((u-n)/(w=r+1))&&g("overflow"),n+=(a-t)*w,t=a,s=0;s<m;++s)if((f=e[s])<t&&++n>u&&g("overflow"),f==t){for(c=n,l=36;!(c<(h=l<=o?1:l>=o+26?26:l-o));l+=36)S=c-h,y=36-h,I.push(d(b(h+S%y,0))),c=p(S/y);I.push(d(b(c,0))),o=k(n,w,r==i),n=0,++r}++n,++t}return I.join("")}if(s={version:"1.3.2",ucs2:{decode:v,encode:y},decode:S,encode:I,toASCII:function(e){return w(e,(function(e){return l.test(e)?"xn--"+I(e):e}))},toUnicode:function(e){return w(e,(function(e){return c.test(e)?S(e.slice(4).toLowerCase()):e}))}},r&&i)if(e.exports==r)i.exports=s;else for(a in s)s.hasOwnProperty(a)&&(r[a]=s[a]);else n.punycode=s}(R)}));function q(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var N=function(e,t,n,r){t=t||"&",n=n||"=";var i={};if("string"!==typeof e||0===e.length)return i;var o=/\+/g;e=e.split(t);var s=1e3;r&&"number"===typeof r.maxKeys&&(s=r.maxKeys);var a=e.length;s>0&&a>s&&(a=s);for(var u=0;u<a;++u){var c,l,h,f,p=e[u].replace(o,"%20"),d=p.indexOf(n);d>=0?(c=p.substr(0,d),l=p.substr(d+1)):(c=p,l=""),h=decodeURIComponent(c),f=decodeURIComponent(l),q(i,h)?Array.isArray(i[h])?i[h].push(f):i[h]=[i[h],f]:i[h]=f}return i},C=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}},W=function(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"===typeof e?Object.keys(e).map((function(r){var i=encodeURIComponent(C(r))+n;return Array.isArray(e[r])?e[r].map((function(e){return i+encodeURIComponent(C(e))})).join(t):i+encodeURIComponent(C(e[r]))})).join(t):r?encodeURIComponent(C(r))+n+encodeURIComponent(C(e)):""},M=A((function(e,t){t.decode=t.parse=N,t.encode=t.stringify=W})),F=function(e,t){return Y(e,!1,!0).resolve(t)};function D(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var Q=/^([a-z0-9.+-]+:)/i,U=/:[0-9]*$/,z=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),L=["'"].concat(z),H=["%","/","?",";","#"].concat(L),J=["/","?","#"],B=/^[a-z0-9A-Z_-]{0,63}$/,G=/^([a-z0-9A-Z_-]{0,63})(.*)$/,V={javascript:!0,"javascript:":!0},K={javascript:!0,"javascript:":!0},X={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function Y(e,t,n){if(e&&ee(e)&&e instanceof D)return e;var r=new D;return r.parse(e,t,n),r}function Z(e){return"string"===typeof e}function ee(e){return"object"===typeof e&&null!==e}function te(e){return null===e}D.prototype.parse=function(e,t,n){if(!Z(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var r=e;r=r.trim();var i=Q.exec(r);if(i){var o=(i=i[0]).toLowerCase();this.protocol=o,r=r.substr(i.length)}if(n||i||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var s="//"===r.substr(0,2);!s||i&&K[i]||(r=r.substr(2),this.slashes=!0)}if(!K[i]&&(s||i&&!X[i])){for(var a,u,c=-1,l=0;l<J.length;l++){-1!==(h=r.indexOf(J[l]))&&(-1===c||h<c)&&(c=h)}-1!==(u=-1===c?r.lastIndexOf("@"):r.lastIndexOf("@",c))&&(a=r.slice(0,u),r=r.slice(u+1),this.auth=decodeURIComponent(a)),c=-1;for(l=0;l<H.length;l++){var h;-1!==(h=r.indexOf(H[l]))&&(-1===c||h<c)&&(c=h)}-1===c&&(c=r.length),this.host=r.slice(0,c),r=r.slice(c),this.parseHost(),this.hostname=this.hostname||"";var f="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!f)for(var p=this.hostname.split(/\./),d=(l=0,p.length);l<d;l++){var g=p[l];if(g&&!g.match(B)){for(var m="",w=0,v=g.length;w<v;w++)g.charCodeAt(w)>127?m+="x":m+=g[w];if(!m.match(B)){var y=p.slice(0,l),b=p.slice(l+1),k=g.match(G);k&&(y.push(k[1]),b.unshift(k[2])),b.length&&(r="/"+b.join(".")+r),this.hostname=y.join(".");break}}}if(this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),!f){var S=this.hostname.split("."),I=[];for(l=0;l<S.length;++l){var _=S[l];I.push(_.match(/[^A-Za-z0-9_-]/)?"xn--"+$.encode(_):_)}this.hostname=I.join(".")}var E=this.port?":"+this.port:"",P=this.hostname||"";this.host=P+E,this.href+=this.host,f&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==r[0]&&(r="/"+r))}if(!V[o])for(l=0,d=L.length;l<d;l++){var T=L[l],x=encodeURIComponent(T);x===T&&(x=escape(T)),r=r.split(T).join(x)}var j=r.indexOf("#");-1!==j&&(this.hash=r.substr(j),r=r.slice(0,j));var O=r.indexOf("?");if(-1!==O?(this.search=r.substr(O),this.query=r.substr(O+1),t&&(this.query=M.parse(this.query)),r=r.slice(0,O)):t&&(this.search="",this.query={}),r&&(this.pathname=r),X[o]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){E=this.pathname||"",_=this.search||"";this.path=E+_}return this.href=this.format(),this},D.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",i=!1,o="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&ee(this.query)&&Object.keys(this.query).length&&(o=M.stringify(this.query));var s=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||X[t])&&!1!==i?(i="//"+(i||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):i||(i=""),r&&"#"!==r.charAt(0)&&(r="#"+r),s&&"?"!==s.charAt(0)&&(s="?"+s),t+i+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(s=s.replace("#","%23"))+r},D.prototype.resolve=function(e){return this.resolveObject(Y(e,!1,!0)).format()},D.prototype.resolveObject=function(e){if(Z(e)){var t=new D;t.parse(e,!1,!0),e=t}var n=new D;if(Object.keys(this).forEach((function(e){n[e]=this[e]}),this),n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol)return Object.keys(e).forEach((function(t){"protocol"!==t&&(n[t]=e[t])})),X[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n;if(e.protocol&&e.protocol!==n.protocol){if(!X[e.protocol])return Object.keys(e).forEach((function(t){n[t]=e[t]})),n.href=n.format(),n;if(n.protocol=e.protocol,e.host||K[e.protocol])n.pathname=e.pathname;else{for(var r=(e.pathname||"").split("/");r.length&&!(e.host=r.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==r[0]&&r.unshift(""),r.length<2&&r.unshift(""),n.pathname=r.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var i=n.pathname||"",o=n.search||"";n.path=i+o}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var s=n.pathname&&"/"===n.pathname.charAt(0),a=e.host||e.pathname&&"/"===e.pathname.charAt(0),u=a||s||n.host&&e.pathname,c=u,l=n.pathname&&n.pathname.split("/")||[],h=(r=e.pathname&&e.pathname.split("/")||[],n.protocol&&!X[n.protocol]);if(h&&(n.hostname="",n.port=null,n.host&&(""===l[0]?l[0]=n.host:l.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===r[0]?r[0]=e.host:r.unshift(e.host)),e.host=null),u=u&&(""===r[0]||""===l[0])),a)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,l=r;else if(r.length)l||(l=[]),l.pop(),l=l.concat(r),n.search=e.search,n.query=e.query;else if(null!=e.search){if(h)n.hostname=n.host=l.shift(),(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift());return n.search=e.search,n.query=e.query,te(n.pathname)&&te(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!l.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var f=l.slice(-1)[0],p=(n.host||e.host)&&("."===f||".."===f)||""===f,d=0,g=l.length;g>=0;g--)"."==(f=l[g])?l.splice(g,1):".."===f?(l.splice(g,1),d++):d&&(l.splice(g,1),d--);if(!u&&!c)for(;d--;d)l.unshift("..");!u||""===l[0]||l[0]&&"/"===l[0].charAt(0)||l.unshift(""),p&&"/"!==l.join("/").substr(-1)&&l.push("");var m,w=""===l[0]||l[0]&&"/"===l[0].charAt(0);h&&(n.hostname=n.host=w?"":l.length?l.shift():"",(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift()));return(u=u||n.host&&l.length)&&!w&&l.unshift(""),l.length?n.pathname=l.join("/"):(n.pathname=null,n.path=null),te(n.pathname)&&te(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},D.prototype.parseHost=function(){var e=this.host,t=U.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};var ne="3.0.1733";u.defaults.validateStatus=function(e){return e<=504};var re=function(){var e=this,t=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&(e.headers["X-EPI2ME-ApiKey"]=n.apikey,n.apisecret)){e.headers["X-EPI2ME-SignatureDate"]=(new Date).toISOString(),e.url.match(/^https:/)&&(e.url=e.url.replace(/:443/,"")),e.url.match(/^http:/)&&(e.url=e.url.replace(/:80/,""));var r=[e.url,Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n")].join("\n"),i=c.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SignatureV0"]=i}},n=function(t){return T(e,void 0,void 0,(function(){var e,n;return x(this,(function(r){return(e=t?t.data:null)?t&&t.status>=400?(n="Network error "+t.status,e.error&&(n=e.error),504===t.status&&(n="Please check your network connection and try again."),[2,Promise.reject(new Error(n))]):e.error?[2,Promise.reject(new Error(e.error))]:[2,Promise.resolve(e)]:[2,Promise.reject(new Error("unexpected non-json response"))]}))}))};return{version:"3.0.1733",headers:function(e,n){var i=r.merge({log:{debug:function(){}}},n).log,o=n;if(o||(o={}),e.headers=r.merge({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-Client":o.user_agent||"api","X-EPI2ME-Version":o.agent_version||re.version},e.headers,o.headers),"signing"in o&&!o.signing||t(e,o),o.proxy){var s=o.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=s[2],u=s[3],c={host:s[4],port:s[5]};a&&u&&(c.proxyAuth=a+":"+u),o.proxy.match(/^https/)?(i.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),e.httpsAgent=l.httpsOverHttps({proxy:c})):(i.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),e.httpsAgent=l.httpsOverHttp({proxy:c})),e.proxy=!1}},head:function(t,n){return T(e,void 0,void 0,(function(){var e,i,o,s,a,c,l,h;return x(this,(function(f){switch(f.label){case 0:e=r.merge({log:{debug:function(){}}},n).log,o=n.url,s=t,n.skip_url_mangle?i=s:(s="/"+s,o=o.replace(/\/+$/,""),s=s.replace(/\/+/g,"/"),i=o+s),a={url:i,gzip:!0},re.headers(a,n),f.label=1;case 1:return f.trys.push([1,3,,4]),e.debug("HEAD "+a.url),[4,u.head(a.url,a)];case 2:return(c=f.sent())&&c.status>=400?(l="Network error "+c.status,504===c.status&&(l="Please check your network connection and try again."),[2,Promise.reject(new Error(l))]):[3,4];case 3:return h=f.sent(),[2,Promise.reject(h)];case 4:return[2,Promise.resolve(c)]}}))}))},get:function(t,i){return T(e,void 0,void 0,(function(){var e,o,s,a,c,l,h;return x(this,(function(f){switch(f.label){case 0:e=r.merge({log:{debug:function(){}}},i).log,s=i.url,a=t,i.skip_url_mangle?o=a:(a="/"+a,s=s.replace(/\/+$/,""),a=a.replace(/\/+/g,"/"),o=s+a),c={url:o,gzip:!0},re.headers(c,i),f.label=1;case 1:return f.trys.push([1,3,,4]),e.debug("GET "+c.url),[4,u.get(c.url,c)];case 2:return l=f.sent(),[3,4];case 3:return h=f.sent(),[2,Promise.reject(h)];case 4:return[2,n(l,i)]}}))}))},post:function(t,i,o){return T(e,void 0,void 0,(function(){var e,s,a,c,l,h,f,p,d;return x(this,(function(g){switch(g.label){case 0:e=r.merge({log:{debug:function(){}}},o).log,s=(s=o.url).replace(/\/+$/,""),a=t.replace(/\/+/g,"/"),c={url:s+"/"+a,gzip:!0,data:i,headers:{}},o.legacy_form&&(l=[],h=r.merge({json:JSON.stringify(i)},i),Object.keys(h).sort().forEach((function(e){l.push(e+"="+escape(h[e]))})),c.data=l.join("&"),c.headers["Content-Type"]="application/x-www-form-urlencoded"),re.headers(c,o),f=c.data,delete c.data,g.label=1;case 1:return g.trys.push([1,3,,4]),e.debug("POST "+c.url),[4,u.post(c.url,f,c)];case 2:return p=g.sent(),[3,4];case 3:return d=g.sent(),[2,Promise.reject(d)];case 4:return o.handler?[2,o.handler(p)]:[2,n(p,o)]}}))}))},put:function(t,i,o,s){return T(e,void 0,void 0,(function(){var e,a,c,l,h,f,p,d,g;return x(this,(function(m){switch(m.label){case 0:e=r.merge({log:{debug:function(){}}},s).log,a=(a=s.url).replace(/\/+$/,""),c=t.replace(/\/+/g,"/"),l={url:a+"/"+c+"/"+i,gzip:!0,data:o,headers:{}},s.legacy_form&&(h=[],f=r.merge({json:JSON.stringify(o)},o),Object.keys(f).sort().forEach((function(e){h.push(e+"="+escape(f[e]))})),l.data=h.join("&"),l.headers["Content-Type"]="application/x-www-form-urlencoded"),re.headers(l,s),p=l.data,delete l.data,m.label=1;case 1:return m.trys.push([1,3,,4]),e.debug("PUT "+l.url),[4,u.put(l.url,p,l)];case 2:return d=m.sent(),[3,4];case 3:return g=m.sent(),[2,Promise.reject(g)];case 4:return[2,n(d,s)]}}))}))},convertResponseToObject:function(e){if("object"===typeof e)return e;try{return JSON.parse(e)}catch(t){throw new Error("exception parsing chain JSON "+String(t))}}}}();re.pipe=function(e,t,r,i){return T(void 0,void 0,void 0,(function(){var o,s,a;return x(this,(function(c){return o=r.url,s="/"+e,o=o.replace(/\/+$/,""),s=s.replace(/\/+/g,"/"),a={url:o+s,gzip:!0,headers:{"Accept-Encoding":"gzip",Accept:"application/gzip"}},re.headers(a,r),r.proxy&&(a.proxy=r.proxy),i&&(a.onUploadProgress=i),a.responseType="stream",[2,new Promise((function(e,r){u.get(a.url,a).then((function(i){var o=n.createWriteStream(t);i.data.pipe(o),o.on("finish",(function(){e(t)})),o.on("error",(function(e){r(new Error("writer failed "+String(e)))}))})).catch((function(e){r(e)}))}))]}))}))};var ie=0;re.getFileID=function(){return"FILE_"+(ie+=1)},re.lsRecursive=function(e,t,i){return T(void 0,void 0,void 0,(function(){var o,a;return x(this,(function(u){switch(u.label){case 0:return o=e,a=n.statSync(t),i?[4,i(t,a)]:[3,2];case 1:if(u.sent())return[2,[]];u.label=2;case 2:return a.isDirectory()?[2,n.readdir(t).then((function(e){return e.map((function(e){return s.join(t,e)}))})).then((function(e){return Promise.all(e.map((function(e){return re.lsRecursive(o,e,i)})))})).then((function(e){return r.flatten(e)}))]:(a.isFile()&&o===t&&(o=s.dirname(t)),[2,[{name:s.parse(t).base,path:t,relative:t.replace(o,""),size:a.size,id:re.getFileID()}]])}}))}))},re.loadInputFiles=function(e,t,n){var r=e.inputFolders,i=e.outputFolder,o=e.filetype;return T(void 0,void 0,void 0,(function(){var e,t;return x(this,(function(a){switch(a.label){case 0:return(e=o)instanceof Array||(e=[e]),e=e.map((function(e){return e&&0!==e.indexOf(".")?"."+e:e})),t=function(t,r){return T(void 0,void 0,void 0,(function(){var o,a;return x(this,(function(u){return o=s.basename(t),a=[new Promise((function(e,n){return"downloads"===o||"skip"===o||"fail"===o||"fastq_fail"===o||"tmp"===o?n(new Error(t+" failed basic filename")):e("basic ok")})),new Promise((function(n,a){var u=e.length?new RegExp("(?:"+e.join("|")+")$"):null;return t.split(s.sep).filter((function(e){return e.match(/^[.]/)})).length||i&&o===s.basename(i)||u&&!t.match(u)&&r.isFile()?a(new Error(t+" failed extended filename")):n("extended ok")})),n?new Promise((function(e,r){n(t).then((function(n){return n?r(new Error(t+" failed extraFilter")):e("extra ok")}))})):Promise.resolve("extra skip")],[2,Promise.all(a).then((function(){return null})).catch((function(){return"exclude"}))]}))}))},[4,Promise.all(r.map((function(e){return re.lsRecursive(e,e,t)})))];case 1:return[2,a.sent().reduce((function(e,t){return j(e,t.filter((function(e){return!!e})))}),[])]}}))}))},re.stripFile=function(e){return[s.dirname(e),s.basename(e)]};var oe,se,ae,ue,ce,le,he,fe,pe,de,ge,me,we,ve,ye,be=function(){function e(e,t,i){var o=this,u=r.merge({},t);this.options=u,this.log=i;var c=u.idWorkflowInstance,l=u.inputFolders;i.debug("setting up "+e+"/db.sqlite for "+c),this.db=n.mkdirp(e).then((function(){return o.log.debug("opening "+e+"/db.sqlite"),a.open(s.join(e,"db.sqlite")).then((function(t){return T(o,void 0,void 0,(function(){var n,r;return x(this,(function(i){switch(i.label){case 0:return this.log.debug("opened "+e+"/db.sqlite"),[4,t.migrate({migrationsPath:s.join(__dirname,"migrations")})];case 1:i.sent(),n=l.map((function(){return"(?)"})).join(","),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,Promise.all([t.run("INSERT INTO meta (version, idWorkflowInstance) VALUES(?, ?)",ne,c),t.run("INSERT INTO folders (folder_path) VALUES "+n,l)])];case 3:return i.sent(),[2,Promise.resolve(t)];case 4:return r=i.sent(),this.log.error(r),[2,Promise.reject(r)];case 5:return[2]}}))}))}))})).catch((function(e){throw o.log.error(e),e}))}return e.prototype.uploadFile=function(e){return T(this,void 0,void 0,(function(){var t,n,r,i;return x(this,(function(o){switch(o.label){case 0:return[4,this.db];case 1:return t=o.sent(),n=re.stripFile(e),r=n[0],i=n[1],[4,t.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",r)];case 2:return o.sent(),[2,t.run("INSERT INTO uploads(filename, path_id) VALUES(?, (SELECT folder_id FROM folders WHERE folder_path = ?))",i,r)]}}))}))},e.prototype.skipFile=function(e){return T(this,void 0,void 0,(function(){var t,n,r,i;return x(this,(function(o){switch(o.label){case 0:return[4,this.db];case 1:return t=o.sent(),n=re.stripFile(e),r=n[0],i=n[1],[4,t.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",r)];case 2:return o.sent(),[2,t.run("INSERT INTO skips(filename, path_id) VALUES(?, (SELECT folder_id FROM folders WHERE folder_path = ?))",i,r)]}}))}))},e.prototype.splitFile=function(e,t){return T(this,void 0,void 0,(function(){var n,r,i,o,s;return x(this,(function(a){switch(a.label){case 0:return[4,this.db];case 1:return n=a.sent(),r=re.stripFile(e),i=r[0],o=r[1],s=re.stripFile(t)[1],[4,n.run("INSERT OR IGNORE INTO folders (folder_path) VALUES (?)",i)];case 2:return a.sent(),[2,n.run("INSERT INTO splits(filename, parent, child_path_id, start, end) VALUES(?, ?, (SELECT folder_id FROM folders WHERE folder_path = ?), CURRENT_TIMESTAMP, NULL)",o,s,i)]}}))}))},e.prototype.splitDone=function(e){return T(this,void 0,void 0,(function(){var t,n,r,i;return x(this,(function(o){switch(o.label){case 0:return[4,this.db];case 1:return t=o.sent(),n=re.stripFile(e),r=n[0],i=n[1],[2,t.run("UPDATE splits SET end=CURRENT_TIMESTAMP WHERE filename=? AND child_path_id=(SELECT folder_id FROM folders WHERE folder_path=?)",i,r)]}}))}))},e.prototype.splitClean=function(){return T(this,void 0,void 0,(function(){var e=this;return x(this,(function(t){switch(t.label){case 0:return[4,this.db];case 1:return[2,t.sent().all("SELECT splits.filename, folders.folder_path FROM splits INNER JOIN folders ON folders.folder_id = splits.child_path_id WHERE end IS NULL").then((function(t){if(!t)return e.log.info("no split files to clean"),Promise.resolve([]);e.log.info("cleaning "+t.length+" split files"),e.log.debug("going to clean: "+t.map((function(e){return e.filename})).join(" "));var r=t.map((function(e){return n.unlink(s.join(e.folder_path,e.filename)).catch((function(){console.warn("Failed to cleanup "+s.join(e.folder_path,e.filename))}))}));return Promise.all(r)}))]}}))}))},e.prototype.seenUpload=function(e){return T(this,void 0,void 0,(function(){var t,n,i,o;return x(this,(function(s){switch(s.label){case 0:return[4,this.db];case 1:return t=s.sent(),n=re.stripFile(e),i=n[0],o=n[1],[2,Promise.all([t.get("SELECT * FROM uploads u INNER JOIN folders ON folders.folder_id = u.path_id WHERE u.filename=? AND folders.folder_path=? LIMIT 1",[o,i]),t.get("SELECT * FROM skips s INNER JOIN folders ON folders.folder_id = s.path_id WHERE s.filename=? AND folders.folder_path=? LIMIT 1",o,i)]).then((function(e){return r.remove(e,void 0).length}))]}}))}))},e}(),ke="https://epi2me.nanoporetech.com",Se={local:!1,url:ke,user_agent:"EPI2ME API",region:"eu-west-1",sessionGrace:5,uploadTimeout:1200,downloadTimeout:1200,fileCheckInterval:5,downloadCheckInterval:3,stateCheckInterval:60,inFlightDelay:600,waitTimeSeconds:20,waitTokenError:30,transferPoolSize:3,downloadMode:"data+telemetry",filetype:[".fastq",".fq",".fastq.gz",".fq.gz"],signing:!0,sampleDirectory:"/data"},Ie="\npage\npages\nhasNext\nhasPrevious\ntotalCount\n",_e="\nidWorkflowInstance\nstartDate\nworkflowImage{\n  workflow\n  {\n    rev\n    name\n  }\n}\n",Ee=function(){var e=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&n.apisecret){e.headers["X-EPI2ME-APIKEY"]=n.apikey,e.headers["X-EPI2ME-SIGNATUREDATE"]=(new Date).toISOString();var r=[Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n"),e.body].join("\n"),i=c.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SIGNATUREV0"]=i}};return{version:"3.0.1733",setHeaders:function(t,n){var i=r.merge({log:{debug:function(){}}},n).log,o=n;if(o||(o={}),t.headers=r.merge({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-CLIENT":o.user_agent||"api","X-EPI2ME-VERSION":o.agent_version||Ee.version},t.headers,o.headers),"signing"in o&&!o.signing||e(t,o),o.proxy){var s=o.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=s[2],u=s[3],c={host:s[4],port:s[5]};a&&u&&(c.proxyAuth=a+":"+u),o.proxy.match(/^https/)?(i.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),t.httpsAgent=l.httpsOverHttps({proxy:c})):(i.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),t.httpsAgent=l.httpsOverHttp({proxy:c})),t.proxy=!1}}}}(),Pe=w.buildAxiosFetch(u),Te=function(e,t){var n=t.headers.keys,r=n.apikey,i=n.apisecret;return delete t.headers.keys,Ee.setHeaders(t,{apikey:r,apisecret:i,signing:!0}),Pe(e,t)},xe=new d({link:new g.ApolloLink((function(e){var t=e.getContext(),n=t.apikey,r=t.apisecret,i=t.url,o=m.createHttpLink({uri:F(i,"/graphql"),fetch:Te,headers:{keys:{apikey:n,apisecret:r}}});return g.execute(o,e)})),cache:new p.InMemoryCache}),je=function(e){var t=this;this.createContext=function(e){var n=t.options,i=n.apikey,o=n.apisecret,s=n.url;return r.merge({apikey:i,apisecret:o,url:s},e)},this.query=function(e){return function(n){var r,i=void 0===n?{}:n,o=i.context,s=void 0===o?{}:o,a=i.variables,u=void 0===a?{}:a,c=i.options,l=void 0===c?{}:c,h=t.createContext(s);return r="string"===typeof e?f(oe||(oe=O(["\n        ","\n      "],["\n        ","\n      "])),e):"function"===typeof e?f(se||(se=O(["\n        ","\n      "],["\n        ","\n      "])),e(Ie)):e,t.client.query(P(P({query:r,variables:u},l),{context:h}))}},this.mutate=function(e){return function(n){var r,i=void 0===n?{}:n,o=i.context,s=void 0===o?{}:o,a=i.variables,u=void 0===a?{}:a,c=i.options,l=void 0===c?{}:c,h=t.createContext(s);return r="string"===typeof e?f(ae||(ae=O(["\n        ","\n      "],["\n        ","\n      "])),e):e,t.client.mutate(P(P({mutation:r,variables:u},l),{context:h}))}},this.resetCache=function(){t.client.resetStore()},this.workflows=this.query(f(ue||(ue=O(["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "],["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "])),Ie,"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowPages=function(e){return T(t,void 0,void 0,(function(){var t,n,r,i=this;return x(this,(function(o){switch(o.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return n=o.sent(),r=function(e){return T(i,void 0,void 0,(function(){return x(this,(function(r){switch(r.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return[2,n=r.sent()]}}))}))},[2,{data:n,next:function(){return r(t+1)},previous:function(){return r(t-1)},first:function(){return r(1)},last:function(){return r(0)}}]}}))}))},this.workflow=this.query(f(ce||(ce=O(["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "],["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "])),"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowInstances=this.query(f(le||(le=O(["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "],["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "])),Ie,_e)),this.workflowInstance=this.query(f(he||(he=O(["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "],["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "])),_e)),this.startWorkflow=this.mutate(f(fe||(fe=O(["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "],["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "])))),this.stopWorkflow=this.mutate(f(pe||(pe=O(["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "],["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "])))),this.instanceToken=this.mutate(f(de||(de=O(["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "],["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "])))),this.user=this.query(f(ge||(ge=O(["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "],["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "])))),this.updateUser=this.mutate(f(me||(me=O(["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "],["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "])))),this.register=this.mutate(f(we||(we=O(["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "],["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "])))),this.status=this.query(f(ve||(ve=O(["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "],["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "])))),this.healthCheck=function(){return re.get("/status",t.options)},this.regions=this.query(f(ye||(ye=O(["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "],["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "])))),this.options=r.assign({agent_version:re.version,local:!1,url:ke,user_agent:"EPI2ME API",signing:!0},e),this.options.url=this.options.url.replace(/:\/\//,"://graphql."),this.options.url=this.options.url.replace(/\/$/,""),this.log=this.options.log,this.client=xe},Oe=function(e,t){var n=["","K","M","G","T","P","E","Z"],r=t||0,i=e||0;return i>=1e3?(i/=1e3,(r+=1)>=n.length?"???":Oe(i,r)):0===r?""+i+n[r]:""+i.toFixed(1)+n[r]},Re=function(){function e(e){this.allProfileData={},this.defaultEndpoint=process.env.METRICHOR||Se.url,e&&(this.allProfileData=r.merge({profiles:{}},e)),this.allProfileData.endpoint&&(this.defaultEndpoint=this.allProfileData.endpoint)}return e.prototype.profile=function(e){return e?r.merge({endpoint:this.defaultEndpoint},r.merge({profiles:{}},this.allProfileData).profiles[e]):{}},e.prototype.profiles=function(){return Object.keys(this.allProfileData.profiles||{})},e}(),Ae=function(){function e(e){this.options=r.assign({agent_version:re.version,local:!1,url:ke,user_agent:"EPI2ME API",signing:!0},e),this.log=this.options.log,this.cachedResponses={}}return e.prototype.list=function(e){return T(this,void 0,void 0,(function(){var t;return x(this,(function(n){return t=e.match(/^[a-z_]+/i)[0],[2,re.get(e,this.options).then((function(e){return e[t+"s"]}))]}))}))},e.prototype.read=function(e,t){return T(this,void 0,void 0,(function(){return x(this,(function(n){return[2,re.get(e+"/"+t,this.options)]}))}))},e.prototype.user=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){return this.options.local?[2,{accounts:[{id_user_account:"none",number:"NONE",name:"None"}]}]:[2,re.get("user",this.options)]}))}))},e.prototype.status=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){return[2,re.get("status",this.options)]}))}))},e.prototype.jwt=function(){return T(this,void 0,void 0,(function(){var e;return x(this,(function(t){return e=function(e){return e.headers["x-epi2me-jwt"]?Promise.resolve(e.headers["x-epi2me-jwt"]):Promise.reject(new Error("failed to fetch JWT"))},[2,re.post("authenticate",{},r.merge({handler:e},this.options))]}))}))},e.prototype.instanceToken=function(e,t){return T(this,void 0,void 0,(function(){return x(this,(function(n){return[2,re.post("token",r.merge(t,{id_workflow_instance:e}),r.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.installToken=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,re.post("token/install",{id_workflow:e},r.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.attributes=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){return[2,this.list("attribute")]}))}))},e.prototype.workflows=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){return[2,this.list("workflow")]}))}))},e.prototype.amiImages=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){if(this.options.local)throw new Error("amiImages unsupported in local mode");return[2,this.list("ami_image")]}))}))},e.prototype.amiImage=function(e,t){return T(this,void 0,void 0,(function(){var n,r,i;return x(this,(function(o){if(e&&t instanceof Object?(n=e,r=t,i="update"):e instanceof Object&&!t?(r=e,i="create"):(i="read",n=e),this.options.local)throw new Error("ami_image unsupported in local mode");if("update"===i)return[2,re.put("ami_image",n,r,this.options)];if("create"===i)return[2,re.post("ami_image",r,this.options)];if(!n)throw new Error("no id_ami_image specified");return[2,this.read("ami_image",n)]}))}))},e.prototype.workflow=function(e,t,n){return T(this,void 0,void 0,(function(){var i,o,s,a,u,c,l,h,f,p,d,g,m,w,v,y,b,k=this;return x(this,(function(S){switch(S.label){case 0:if(e&&t&&n instanceof Function?(i=e,o=t,s=n,a="update"):e&&t instanceof Object&&!(t instanceof Function)?(i=e,o=t,a="update"):e instanceof Object&&t instanceof Function?(o=e,s=t,a="create"):e instanceof Object&&!t?(o=e,a="create"):(a="read",i=e,s=t instanceof Function?t:null),"update"!==a)return[3,4];S.label=1;case 1:return S.trys.push([1,3,,4]),[4,re.put("workflow",i,o,this.options)];case 2:return u=S.sent(),[2,s?s(null,u):Promise.resolve(u)];case 3:return c=S.sent(),[2,s?s(c):Promise.reject(c)];case 4:if("create"!==a)return[3,8];S.label=5;case 5:return S.trys.push([5,7,,8]),[4,re.post("workflow",o,this.options)];case 6:return l=S.sent(),[2,s?s(null,l):Promise.resolve(l)];case 7:return h=S.sent(),[2,s?s(h):Promise.reject(h)];case 8:if(!i)return f=new Error("no workflow id specified"),[2,s?s(f):Promise.reject(f)];p={},S.label=9;case 9:return S.trys.push([9,11,,12]),[4,this.read("workflow",i)];case 10:if((d=S.sent()).error)throw new Error(d.error);return r.merge(p,d),[3,12];case 11:return g=S.sent(),this.log.error(i+": error fetching workflow "+String(g)),[2,s?s(g):Promise.reject(g)];case 12:r.merge(p,{params:{}}),S.label=13;case 13:return S.trys.push([13,15,,16]),[4,re.get("workflow/config/"+i,this.options)];case 14:if((m=S.sent()).error)throw new Error(m.error);return r.merge(p,m),[3,16];case 15:return w=S.sent(),this.log.error(i+": error fetching workflow config "+String(w)),[2,s?s(w):Promise.reject(w)];case 16:v=r.filter(p.params,{widget:"ajax_dropdown"}),y=j(v.map((function(e,t){var n=v[t];return new Promise((function(e,t){var r=n.values.source.replace("{{EPI2ME_HOST}}","").replace(/&?apikey=\{\{EPI2ME_API_KEY\}\}/,"");re.get(r,k.options).then((function(t){var r=t[n.values.data_root];return r&&(n.values=r.map((function(e){return{label:e[n.values.items.label_key],value:e[n.values.items.value_key]}}))),e()})).catch((function(e){return k.log.error("failed to fetch "+r),t(e)}))}))}))),S.label=17;case 17:return S.trys.push([17,19,,20]),[4,Promise.all(y)];case 18:return S.sent(),[2,s?s(null,p):Promise.resolve(p)];case 19:return b=S.sent(),this.log.error(i+": error fetching config and parameters "+String(b)),[2,s?s(b):Promise.reject(b)];case 20:return[2]}}))}))},e.prototype.startWorkflow=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,re.post("workflow_instance",e,r.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.stopWorkflow=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,re.put("workflow_instance/stop",e,null,r.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.workflowInstances=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return e&&e.run_id?[2,re.get("workflow_instance/wi?show=all&columns[0][name]=run_id;columns[0][searchable]=true;columns[0][search][regex]=true;columns[0][search][value]="+e.run_id+";",this.options).then((function(e){return e.data.map((function(e){return{id_workflow_instance:e.id_ins,id_workflow:e.id_flo,run_id:e.run_id,description:e.desc,rev:e.rev}}))}))]:[2,this.list("workflow_instance")]}))}))},e.prototype.workflowInstance=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,this.read("workflow_instance",e)]}))}))},e.prototype.workflowConfig=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,re.get("workflow/config/"+e,this.options)]}))}))},e.prototype.register=function(e,t){return T(this,void 0,void 0,(function(){return x(this,(function(n){return[2,re.put("reg",e,{description:t||o.userInfo().username+"@"+o.hostname()},r.assign({},this.options,{signing:!1}))]}))}))},e.prototype.datasets=function(e){return T(this,void 0,void 0,(function(){var t;return x(this,(function(n){return(t=e)||(t={}),t.show||(t.show="mine"),[2,this.list("dataset?show="+t.show)]}))}))},e.prototype.dataset=function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return this.options.local?[2,this.datasets().then((function(t){return t.find((function(t){return t.id_dataset===e}))}))]:[2,this.read("dataset",e)]}))}))},e.prototype.fetchContent=function(e){return T(this,void 0,void 0,(function(){var t,n,i,o,s;return x(this,(function(a){switch(a.label){case 0:t=r.assign({},this.options,{skip_url_mangle:!0,headers:{"Content-Type":""}}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,re.head(e,t)];case 2:return i=a.sent(),(n=i.headers.etag)&&this.cachedResponses[e]&&this.cachedResponses[e].etag===n?[2,this.cachedResponses[e].response]:[3,4];case 3:return o=a.sent(),this.log.warn("Failed to HEAD request "+e+": "+String(o)),[3,4];case 4:return[4,re.get(e,t)];case 5:return s=a.sent(),n&&(this.cachedResponses[e]={etag:n,response:s}),[2,s]}}))}))},e}(),$e=function(){function e(e,t){var n=this;this.debounces={},this.debounceWindow=r.merge({debounceWindow:2e3},t).debounceWindow,this.log=r.merge({log:{debug:function(){}}},t).log,e.jwt().then((function(e){n.socket=v(t.url,{transportOptions:{polling:{extraHeaders:{Cookie:"x-epi2me-jwt="+e}}}}),n.socket.on("connect",(function(){n.log.debug("socket ready")}))})).catch((function(e){n.log.error("socket connection failed - JWT authentication error")}))}return e.prototype.debounce=function(e,t){var n=this,i=r.merge(e)._uuid;if(i){if(this.debounces[i])return;this.debounces[i]=1,setTimeout((function(){delete n.debounces[i]}),this.debounceWindow)}t&&t(e)},e.prototype.watch=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing watch on "+e),void setTimeout((function(){n.watch(e,t)}),1e3);this.socket.on(e,(function(e){return n.debounce(e,t)}))},e.prototype.emit=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing emit on "+e),void setTimeout((function(){n.emit(e,t)}),1e3);this.log.debug("socket emit "+e+" "+JSON.stringify(t)),this.socket.emit(e,t)},e}(),qe=function(){function e(e){var t;if((t="string"===typeof e||"object"===typeof e&&e.constructor===String?JSON.parse(e):e||{}).endpoint&&(t.url=t.endpoint,delete t.endpoint),t.log){if(!r.every([t.log.info,t.log.warn,t.log.error,t.log.debug,t.log.json],r.isFunction))throw new Error("expected log object to have error, debug, info, warn and json methods");this.log=t.log}else this.log={info:function(e){console.info("["+(new Date).toISOString()+"] INFO: "+e)},debug:function(e){console.debug("["+(new Date).toISOString()+"] DEBUG: "+e)},warn:function(e){console.warn("["+(new Date).toISOString()+"] WARN: "+e)},error:function(e){console.error("["+(new Date).toISOString()+"] ERROR: "+e)},json:function(e){console.log(JSON.stringify(e))}};this.stopped=!0,this.uploadState$=new h.BehaviorSubject(!1),this.analyseState$=new h.BehaviorSubject(!1),this.reportState$=new h.BehaviorSubject(!1),this.instanceTelemetry$=new h.BehaviorSubject(null),this.experimentalWorkerStatus$=new h.BehaviorSubject(null),this.runningStates$=h.combineLatest(this.uploadState$,this.analyseState$,this.reportState$),this.states={upload:{filesCount:0,success:{files:0,bytes:0,reads:0},types:{},niceTypes:"",progress:{bytes:0,total:0}},download:{progress:{},success:{files:0,reads:0,bytes:0},fail:0,types:{},niceTypes:""},warnings:[]},this.liveStates$=new h.BehaviorSubject(this.states),this.config={options:r.defaults(t,Se),instance:{id_workflow_instance:t.id_workflow_instance,inputQueueName:null,outputQueueName:null,outputQueueURL:null,discoverQueueCache:{},bucket:null,bucketFolder:null,remote_addr:null,chain:null,key_id:null}},this.config.instance.awssettings={region:this.config.options.region},this.REST=new Ae(r.merge({log:this.log},this.config.options)),this.graphQL=new je(r.merge({log:this.log},this.config.options)),this.timers={downloadCheckInterval:null,stateCheckInterval:null,fileCheckInterval:null,transferTimeouts:{},visibilityIntervals:{},summaryTelemetryInterval:null}}return e.prototype.socket=function(){return T(this,void 0,void 0,(function(){var e,t=this;return x(this,(function(n){return this.mySocket?[2,this.mySocket]:(this.mySocket=new $e(this.REST,r.merge({log:this.log},this.config.options)),(e=this.config.instance.id_workflow_instance)&&this.mySocket.watch("workflow_instance:state:"+e,(function(e){var n=t.config.instance;if(n){var r=n.summaryTelemetry,i=Object.entries(n.chain.components).sort((function(e,t){return e[0]-t[0]})).reduce((function(t,n){var i=n[0],o=n[1];if(!e[i])return t;var s=+i,a=s&&Object.keys(r[o.wid])[0]||"ROOT",u=e[i].split(",").map((function(e){return Math.max(0,+e)}));return j(t,[{running:u[0],complete:u[1],error:u[2],step:s,name:a}])}),[]);t.experimentalWorkerStatus$.next(i)}})),[2,this.mySocket])}))}))},e.prototype.realtimeFeedback=function(e,t){return T(this,void 0,void 0,(function(){return x(this,(function(n){switch(n.label){case 0:return[4,this.socket()];case 1:return n.sent().emit(e,t),[2]}}))}))},e.prototype.stopTimer=function(e){this.timers[e]&&(this.log.debug("clearing "+e+" interval"),clearInterval(this.timers[e]),this.timers[e]=null)},e.prototype.stopAnalysis=function(){return T(this,void 0,void 0,(function(){var e,t;return x(this,(function(n){switch(n.label){case 0:if(this.stopUpload(),this.stopped=!0,!(e=this.config.instance.id_workflow_instance))return[3,8];n.label=1;case 1:return n.trys.push([1,6,,7]),this.config.options.graphQL?[4,this.graphQL.stopWorkflow({variables:{idWorkflowInstance:e}})]:[3,3];case 2:return n.sent(),[3,5];case 3:return[4,this.REST.stopWorkflow(e)];case 4:n.sent(),n.label=5;case 5:return this.analyseState$.next(!1),[3,7];case 6:return t=n.sent(),this.log.error("Error stopping instance: "+String(t)),[2,Promise.reject(t)];case 7:this.log.info("workflow instance "+e+" stopped"),n.label=8;case 8:return[2,Promise.resolve()]}}))}))},e.prototype.stopUpload=function(){return T(this,void 0,void 0,(function(){var e=this;return x(this,(function(t){return this.log.debug("stopping watchers"),["stateCheckInterval","fileCheckInterval"].forEach((function(t){return e.stopTimer(t)})),this.uploadState$.next(!1),[2]}))}))},e.prototype.stopEverything=function(){return T(this,void 0,void 0,(function(){var e=this;return x(this,(function(t){switch(t.label){case 0:return this.stopAnalysis(),Object.keys(this.timers.transferTimeouts).forEach((function(t){e.log.debug("clearing transferTimeout for "+t),clearTimeout(e.timers.transferTimeouts[t]),delete e.timers.transferTimeouts[t]})),Object.keys(this.timers.visibilityIntervals).forEach((function(t){e.log.debug("clearing visibilityInterval for "+t),clearInterval(e.timers.visibilityIntervals[t]),delete e.timers.visibilityIntervals[t]})),this.downloadWorkerPool?(this.log.debug("clearing downloadWorkerPool"),[4,Promise.all(Object.values(this.downloadWorkerPool))]):[3,2];case 1:t.sent(),this.downloadWorkerPool=null,t.label=2;case 2:return["summaryTelemetryInterval","downloadCheckInterval"].forEach((function(t){return e.stopTimer(t)})),[2]}}))}))},e.prototype.reportProgress=function(){var e=this.states,t=e.upload,n=e.download;this.log.json({progress:{download:n,upload:t}})},e.prototype.storeState=function(e,t,n,r){var i=this,o=r||{};this.states[e]||(this.states[e]={}),this.states[e][t]||(this.states[e][t]={}),"incr"===n?Object.keys(o).forEach((function(n){i.states[e][t][n]=i.states[e][t][n]?i.states[e][t][n]+parseInt(o[n],10):parseInt(o[n],10)})):Object.keys(o).forEach((function(n){i.states[e][t][n]=i.states[e][t][n]?i.states[e][t][n]-parseInt(o[n],10):-parseInt(o[n],10)}));try{this.states[e].success.niceReads=Oe(this.states[e].success.reads)}catch(a){this.states[e].success.niceReads=0}try{this.states[e].progress.niceSize=Oe(this.states[e].success.bytes+this.states[e].progress.bytes||0)}catch(a){this.states[e].progress.niceSize=0}try{this.states[e].success.niceSize=Oe(this.states[e].success.bytes)}catch(a){this.states[e].success.niceSize=0}this.states[e].niceTypes=Object.keys(this.states[e].types||{}).sort().map((function(t){return i.states[e].types[t]+" "+t})).join(", ");var s=Date.now();(!this.stateReportTime||s-this.stateReportTime>2e3)&&(this.stateReportTime=s,this.reportProgress()),this.liveStates$.next(P({},this.states))},e.prototype.uploadState=function(e,t,n){return this.storeState("upload",e,t,n)},e.prototype.downloadState=function(e,t,n){return this.storeState("download",e,t,n)},e.prototype.url=function(){return this.config.options.url},e.prototype.apikey=function(){return this.config.options.apikey},e.prototype.attr=function(e,t){if(!(e in this.config.options))throw new Error("config object does not contain property "+e);return t?(this.config.options[e]=t,this):this.config.options[e]},e.prototype.stats=function(e){return this.states[e]},e}();qe.version=re.version,qe.Profile=Re,qe.REST=Ae,qe.utils=re;var Ne=function(){function e(e,t){this.EPI2ME=e,this.options=t,this.masterInstance=new e(this.options),this.log=this.masterInstance.log,this.REST=this.masterInstance.REST,this.graphQL=this.masterInstance.graphQL,this.SampleReader=this.masterInstance.SampleReader,this.utils=e.utils,this.version=e.version,this.runningInstances={}}return e.prototype.startRun=function(e,t){return T(this,void 0,void 0,(function(){var n,r,i,o;return x(this,(function(s){switch(s.label){case 0:n=new this.EPI2ME(P(P({},this.options),e)),s.label=1;case 1:return s.trys.push([1,3,,8]),[4,n.autoStart(t)];case 2:return r=s.sent(),this.runningInstances[r.id_workflow_instance]=n,[3,8];case 3:i=s.sent(),this.log.error("Experienced error starting "+String(i)),s.label=4;case 4:return s.trys.push([4,6,,7]),[4,n.stopEverything()];case 5:return s.sent(),[3,7];case 6:return o=s.sent(),this.log.error("Also experienced error stopping "+String(o)),[3,7];case 7:return[3,8];case 8:return[2,n]}}))}))},e.prototype.startGQLRun=function(e,t){return T(this,void 0,void 0,(function(){var n,r,i,o;return x(this,(function(s){switch(s.label){case 0:n=new this.EPI2ME(P(P(P({},this.options),e),{useGraphQL:!0})),s.label=1;case 1:return s.trys.push([1,3,,8]),[4,n.autoStartGQL(t)];case 2:return r=s.sent(),this.runningInstances[r.id_workflow_instance]=n,console.log(r),[3,8];case 3:i=s.sent(),this.log.error("Experienced error starting "+String(i)),s.label=4;case 4:return s.trys.push([4,6,,7]),[4,n.stopEverything()];case 5:return s.sent(),[3,7];case 6:return o=s.sent(),this.log.error("Also experienced error stopping "+String(o)),[3,7];case 7:return[3,8];case 8:return[2,n]}}))}))},e}();var Ce={fastq:function(e){return new Promise((function(t,r){var i=1,o=-1,s={size:0};try{s=n.statSync(e)}catch(a){return void r(a)}n.createReadStream(e).on("data",(function(e){o=-1,i-=1;do{o=e.indexOf("10",o+1),i+=1}while(-1!==o)})).on("end",(function(){return t({type:"fastq",bytes:s.size,reads:Math.floor(i/4)})})).on("error",r)}))},fasta:function(e){return new Promise((function(t,r){var i=1,o=-1,s={size:0};try{s=n.statSync(e)}catch(a){r(a)}n.createReadStream(e).on("data",(function(e){o=-1,i-=1;do{o=e.indexOf("62",o+1),i+=1}while(-1!==o)})).on("end",(function(){return t({type:"fasta",bytes:s.size,sequences:Math.floor((1+i)/2)})})).on("error",r)}))},fastqgz:function(e){return new Promise((function(t,r){var i=1,o=-1,s={size:0};try{s=n.statSync(e)}catch(u){return void r(u)}var a=y.createGunzip();n.createReadStream(e).pipe(a).on("data",(function(e){o=-1,i-=1;do{o=e.indexOf(10,o+1),i+=1}while(-1!==o)})).on("end",(function(){return t({type:"gz",bytes:s.size,reads:Math.floor(i/4)})})).on("error",r)}))},default:function(e){return T(this,void 0,void 0,(function(){return x(this,(function(t){return[2,n.stat(e).then((function(e){return{type:"bytes",bytes:e.size}}))]}))}))}},We={fq:"fastq",fa:"fasta"};function Me(e){if("string"!==typeof e&&!(e instanceof String))return Promise.resolve({});var t=s.extname(e).toLowerCase().replace(/^[.]/,"");(We[t]&&(t=We[t]),"gz"===t)&&(t=e.split(".").slice(1).reduce((function(e,t){return e+(We[t]||t)}),""));return Ce[t]||(t="default"),Ce[t](e)}var Fe=function(e){function t(i,o){var s=e.call(this,{})||this;s.raiseExceptions=!!o,s.prefsFile=i||t.profilePath(),s.allProfileData={};try{s.allProfileData=r.merge({profiles:{}},n.readJSONSync(s.prefsFile)),s.allProfileData.endpoint&&(s.defaultEndpoint=s.allProfileData.endpoint)}catch(a){if(s.raiseExceptions)throw a}return s}return E(t,e),t.profilePath=function(){return s.join(i.homedir(),".epi2me.json")},t.prototype.profile=function(e,t){var i;if(e&&t){r.merge(this.allProfileData,{profiles:(i={},i[e]=t,i)});try{n.writeJSONSync(this.prefsFile,this.allProfileData)}catch(o){if(this.raiseExceptions)throw o}}if(e){if(!this.allProfileData.profiles)throw new Error("cannot read property");return r.merge({endpoint:this.defaultEndpoint},this.allProfileData.profiles[e])}return{}},t}(Re),De=function(){function e(e){var t=r.merge({bandwidth:1,interval:500},e);this.bandwidth=t.bandwidth,this.interval=t.interval,this.pipeline=[],this.running=[],this.completed=0,this.intervalId=null,"start"in t&&!t.start||this.start()}return e.MakeQueryablePromise=function(e){if(e.isResolved)return e;var t=!0,n=!1,r=!1,i=e.then((function(e){return r=!0,t=!1,e})).catch((function(e){throw n=!0,t=!1,e}));return i.dependsOn=e,i.isResolved=function(){return r},i.isPending=function(){return t},i.isRejected=function(){return n},i},e.prototype.enqueue=function(e){this.pipeline.push(e)},e.prototype.start=function(){var e=this;this.intervalId||(this.intervalId=setInterval((function(){e.monitorInterval()}),this.interval))},e.prototype.stop=function(){clearInterval(this.intervalId),delete this.intervalId},e.prototype.state=function(){return{queued:this.pipeline.length,running:this.running.length,completed:this.completed,state:this.intervalId?"running":"stopped"}},e.prototype.monitorInterval=function(){var t=this;this.running.map((function(e,t){return e.isPending()?null:t})).filter((function(e){return e})).reverse().forEach((function(e){t.running.splice(e,1),t.completed+=1}));for(var n=this.bandwidth-this.running.length,r=0;r<n;r+=1){var i=this.pipeline.shift();if(!i)return;this.running.push(e.MakeQueryablePromise(i()))}},e}(),Qe=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return E(t,e),t.prototype.workflows=function(t){return T(this,void 0,void 0,(function(){var r,i,o,a;return x(this,(function(u){switch(u.label){case 0:if(!this.options.local)return[2,e.prototype.workflows.call(this,t)];r=s.join(this.options.url,"workflows"),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,n.readdir(r)];case 2:return o=u.sent(),i=o.filter((function(e){return n.statSync(s.join(r,e)).isDirectory()})).map((function(e){return s.join(r,e,"workflow.json")})).map((function(e){return n.readJsonSync(e)})),[2,t?t(null,i):Promise.resolve(i)];case 3:return a=u.sent(),this.log.warn(a),[2,t?t(void 0):Promise.reject(void 0)];case 4:return[2]}}))}))},t.prototype.workflow=function(t,r,i){return T(this,void 0,void 0,(function(){var o,a,u,c;return x(this,(function(l){switch(l.label){case 0:if(!this.options.local||!t||"object"===typeof t||i)return[2,e.prototype.workflow.call(this,t,r,i)];o=s.join(this.options.url,"workflows"),a=s.join(o,t,"workflow.json"),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,n.readJson(a)];case 2:return u=l.sent(),[2,i?i(null,u):Promise.resolve(u)];case 3:return c=l.sent(),[2,i?i(c):Promise.reject(c)];case 4:return[2]}}))}))},t.prototype.workflowInstances=function(t,r){return T(this,void 0,void 0,(function(){var i,o,a,u,c,l;return x(this,(function(h){switch(h.label){case 0:if(!this.options.local)return[2,e.prototype.workflowInstances.call(this,t,r)];if(!t||t instanceof Function||void 0!==r?(i=t,o=r):o=t,o)return a=new Error("querying of local instances unsupported in local mode"),[2,i?i(a):Promise.reject(a)];u=s.join(this.options.url,"instances"),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,n.readdir(u)];case 2:return c=(c=(c=h.sent()).filter((function(e){return n.statSync(s.join(u,e)).isDirectory()}))).map((function(e){var t,r=s.join(u,e,"workflow.json");try{t=n.readJsonSync(r)}catch(i){t={id_workflow:"-",description:"-",rev:"0.0"}}return t.id_workflow_instance=e,t.filename=r,t})),[2,i?i(null,c):Promise.resolve(c)];case 3:return l=h.sent(),[2,i?i(l):Promise.reject(l)];case 4:return[2]}}))}))},t.prototype.datasets=function(t,r){return T(this,void 0,void 0,(function(){var i,o,a,u,c,l;return x(this,(function(h){switch(h.label){case 0:if(!this.options.local)return[2,e.prototype.datasets.call(this,t,r)];if(!t||t instanceof Function||void 0!==r?(i=t,o=r):o=t,o||(o={}),o.show||(o.show="mine"),"mine"!==o.show)return[2,i(new Error("querying of local datasets unsupported in local mode"))];a=s.join(this.options.url,"datasets"),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,n.readdir(a)];case 2:return u=(u=h.sent()).filter((function(e){return n.statSync(s.join(a,e)).isDirectory()})),c=0,u=u.sort().map((function(e){return{is_reference_dataset:!0,summary:null,dataset_status:{status_label:"Active",status_value:"active"},size:0,prefix:e,id_workflow_instance:null,id_account:null,is_consented_human:null,data_fields:null,component_id:null,uuid:e,is_shared:!1,id_dataset:c+=1,id_user:null,last_modified:null,created:null,name:e,source:e,attributes:null}})),[2,i?i(null,u):Promise.resolve(u)];case 3:return l=h.sent(),this.log.warn(l),[2,i?i(null,[]):Promise.resolve([])];case 4:return[2]}}))}))},t.prototype.bundleWorkflow=function(e,t,n){return T(this,void 0,void 0,(function(){return x(this,(function(r){return[2,re.pipe("workflow/bundle/"+e+".tar.gz",t,this.options,n)]}))}))},t}(Ae),Ue=function(){function e(){this.experiments={}}return e.prototype.getExperiments=function(e){var t=e.sourceDir,n=void 0===t?Se.sampleDirectory:t,r=e.refresh,i=void 0!==r&&r;return T(this,void 0,void 0,(function(){return x(this,(function(e){switch(e.label){case 0:return Object.keys(this.experiments).length&&!i?[3,2]:[4,this.updateExperiments(n)];case 1:e.sent(),e.label=2;case 2:return[2,this.experiments]}}))}))},e.prototype.updateExperiments=function(e){return void 0===e&&(e=Se.sampleDirectory),T(this,void 0,void 0,(function(){var t,n;return x(this,(function(i){switch(i.label){case 0:"sequencing_summary",t=(new k).withBasePath().withErrors().filter((function(e){return e.includes("sequencing_summary")})).exclude((function(e){return e.includes("fastq_")})).withMaxDepth(3).crawl(e),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t.withPromise()];case 2:return n=i.sent(),[3,4];case 3:return i.sent(),[2];case 4:return this.experiments=n.reduce((function(e,t){var n,i=r.takeRight(t.split(s.sep),3),o=i[0],a=i[1],u=/(?<date>[0-9]{8})_(?<time>[0-9]{4})_.*_(?<flowcell>\w+\d+)_\w+/;if(!u.test(a))return e;var c=null===(n=u.exec(a))||void 0===n?void 0:n.groups,l=c.date,h=c.time,f=c.flowcell,p=l.slice(0,4)+"-"+l.slice(4,6)+"-"+l.slice(6,8),d="T"+h.slice(0,2)+":"+h.slice(2,4)+":00",g=new Date(p+d);return e[o]={startDate:g.toDateString()+" "+g.toLocaleTimeString(),samples:j(e[o]?e[o].samples:[],[{sample:a,flowcell:f,path:s.dirname(t)+"/fastq_pass"}])},e}),{}),[2]}}))}))},e}(),ze=function(){function e(e,t,n,i,o){if(this.id_workflow_instance=e,this.children=n,this.options=r.merge(i),this.log=this.options.log,this.REST=t,this.graphQL=o,!e)throw new Error("must specify id_workflow_instance");if(!n||!n.length)throw new Error("must specify children to session")}return e.prototype.session=function(){return T(this,void 0,void 0,(function(){var e,t,n,i,o=this;return x(this,(function(s){switch(s.label){case 0:if(this.sts_expiration&&this.sts_expiration>Date.now())return[2,Promise.resolve()];this.log.debug("new instance token needed"),s.label=1;case 1:return s.trys.push([1,6,,7]),this.options.useGraphQL?[4,this.graphQL.instanceToken({variables:{idWorkflowInstance:this.id_workflow_instance}})]:[3,3];case 2:return t=s.sent().data.token,[3,5];case 3:return[4,this.REST.instanceToken(this.id_workflow_instance,this.options)];case 4:t=s.sent(),s.label=5;case 5:return e=t,this.log.debug("allocated new instance token expiring at "+e.expiration),this.sts_expiration=new Date(e.expiration).getTime()-60*parseInt(this.options.sessionGrace||"0",10),n={},this.options.proxy&&r.merge(n,{httpOptions:{agent:S(this.options.proxy,!0)}}),r.merge(n,{region:this.options.region},e),this.children.forEach((function(e){try{e.config.update(n)}catch(t){o.log.warn("failed to update config on "+String(e)+": "+String(t))}})),[3,7];case 6:return i=s.sent(),this.log.warn("failed to fetch instance token: "+String(i)),[3,7];case 7:return[2,Promise.resolve()]}}))}))},e}();function Le(e,t,i,o,a,u){return T(this,void 0,void 0,(function(){var c,l,h,f,p,d,g,m,w,v,y,b=this;return x(this,(function(k){switch(k.label){case 0:return c=4,l=r.merge(t),h=l.maxChunkBytes,f=l.maxChunkReads,p=s.dirname(e),d=s.basename(e),g=d.match(/^[^.]+/),m=g?g[0]:"",w=d.replace(m,""),v=s.join(p,m),h||f?[4,n.stat(e)]:[2,i(e).then((function(){return{source:e,split:!1,chunks:[e]}}))];case 1:return y=k.sent(),h&&y.size<h?[2,i(e).then((function(){return{source:e,split:!1,chunks:[e]}}))]:[2,new Promise((function(t){var s,l,p,d=0,g=0,m="",y=0,k=0,S={source:e,split:!0,chunks:[]},_=[new Promise((function(e){p=e}))];I.createInterface({input:a(e)}).on("line",(function(e){return T(b,void 0,void 0,(function(){return x(this,(function(t){var r;return m+=e,m+="\n",(g+=1)>=c&&(g=0,r=m,T(b,void 0,void 0,(function(){var e;return x(this,(function(t){return y||(s=v+"_"+(d+=1)+w,e=new Promise((function(e,t){var r=s,a=function(){i(r).then((function(){e(r)})).catch((function(e){t(e)})).finally((function(){n.unlink(r).catch((function(e){o.warn("Error unlinking chunk "+r+": "+String(e))}))}))};u?l=u(r,a):(l=n.createWriteStream(r)).on("close",a)})),_.push(e)),y+=1,k+=r.length,l.write(r,(function(){})),(h&&k>=h||f&&y>=f)&&(y=0,k=0,l.end()),[2]}))})),m=""),[2]}))}))})).on("close",(function(){l.end(),p(),Promise.all(_).then((function(e){e.shift(),t(r.merge({chunks:e},S))}))})).on("error",(function(t){o.error("Error chunking "+e+": "+String(t))}))}))]}}))}))}function He(e,t,r,i){return T(this,void 0,void 0,(function(){return x(this,(function(o){return[2,Le(e,t,r,i,(function(e){return n.createReadStream(e)}))]}))}))}function Je(e,t,r,i){return T(this,void 0,void 0,(function(){return x(this,(function(o){return[2,Le(e,t,r,i,(function(e){return n.createReadStream(e).pipe(b.createGunzip())}),(function(e,t){var r=n.createWriteStream(e);r.on("close",t);var i=b.createGzip();return i.pipe(r),i}))]}))}))}var Be=function(){var e=process.env.APPDATA||("darwin"===process.platform?s.join(i.homedir(),"Library/Application Support"):i.homedir());return process.env.EPI2ME_HOME||s.join(e,"linux"===process.platform?".epi2me":"EPI2ME")},Ge=function(e){function o(t){var n=e.call(this,t)||this;return n.config.options.inputFolders=n.config.options.inputFolders||[],n.config.options.inputFolder&&n.config.options.inputFolders.push(n.config.options.inputFolder),n.REST=new Qe(r.merge({},{log:n.log},n.config.options)),n.SampleReader=new Ue,n.uploadsInProgress=[],n}return E(o,e),o.prototype.sessionedS3=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){switch(e.label){case 0:return this.sessionManager||(this.sessionManager=this.initSessionManager()),[4,this.sessionManager.session()];case 1:return e.sent(),[2,new t.S3({useAccelerateEndpoint:"on"===this.config.options.awsAcceleration})]}}))}))},o.prototype.sessionedSQS=function(){return T(this,void 0,void 0,(function(){return x(this,(function(e){switch(e.label){case 0:return this.sessionManager||(this.sessionManager=this.initSessionManager()),[4,this.sessionManager.session()];case 1:return e.sent(),[2,new t.SQS]}}))}))},o.prototype.deleteMessage=function(e){return T(this,void 0,void 0,(function(){var t,n;return x(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 1:return t=r.sent(),[4,this.sessionedSQS()];case 2:return[2,r.sent().deleteMessage({QueueUrl:t,ReceiptHandle:e.ReceiptHandle}).promise()];case 3:return n=r.sent(),this.log.error("deleteMessage exception: "+String(n)),this.states.download.failure||(this.states.download.failure={}),this.states.download.failure[n]=this.states.download.failure[n]?this.states.download.failure[n]+1:1,[2,Promise.reject(n)];case 4:return[2]}}))}))},o.prototype.discoverQueue=function(e){return T(this,void 0,void 0,(function(){var t,n;return x(this,(function(r){switch(r.label){case 0:if(this.config.instance.discoverQueueCache[e])return[2,Promise.resolve(this.config.instance.discoverQueueCache[e])];this.log.debug("discovering queue for "+e),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,this.sessionedSQS()];case 2:return[4,r.sent().getQueueUrl({QueueName:e}).promise()];case 3:return t=r.sent(),[3,5];case 4:return n=r.sent(),this.log.error("Error: failed to find queue for "+e+": "+String(n)),[2,Promise.reject(n)];case 5:return this.log.debug("found queue "+t.QueueUrl),this.config.instance.discoverQueueCache[e]=t.QueueUrl,[2,Promise.resolve(t.QueueUrl)]}}))}))},o.prototype.queueLength=function(e){return T(this,void 0,void 0,(function(){var t,n,r,i;return x(this,(function(o){switch(o.label){case 0:if(!e)return[2,Promise.reject(new Error("no queueURL specified"))];t=e.match(/([\w\-_]+)$/)[0],this.log.debug("querying queue length of "+t),o.label=1;case 1:return o.trys.push([1,4,,5]),[4,this.sessionedSQS()];case 2:return[4,o.sent().getQueueAttributes({QueueUrl:e,AttributeNames:["ApproximateNumberOfMessages"]}).promise()];case 3:return(null===(n=o.sent())||void 0===n?void 0:n.Attributes)&&"ApproximateNumberOfMessages"in n.Attributes?(r=n.Attributes.ApproximateNumberOfMessages,r=parseInt(r,10)||0,[2,Promise.resolve(r)]):[2,Promise.reject(new Error("unexpected response"))];case 4:return i=o.sent(),this.log.error("error in getQueueAttributes "+String(i)),[2,Promise.reject(i)];case 5:return[2]}}))}))},o.prototype.autoStart=function(e,t){return T(this,void 0,void 0,(function(){var n,r=this;return x(this,(function(i){switch(i.label){case 0:return[4,this.autoStartGeneric(e,(function(){return r.REST.startWorkflow(e)}),t)];case 1:return n=i.sent(),this.setClassConfigREST(n),[2,this.autoConfigure(n,t)]}}))}))},o.prototype.autoStartGQL=function(e,t){return T(this,void 0,void 0,(function(){var n,r=this;return x(this,(function(i){switch(i.label){case 0:return[4,this.autoStartGeneric(e,(function(){return r.graphQL.startWorkflow({variables:e})}),t)];case 1:return n=i.sent(),this.setClassConfigGQL(n),[2,this.autoConfigure(this.config.instance,t)]}}))}))},o.prototype.autoStartGeneric=function(e,t,n){return T(this,void 0,void 0,(function(){var r,i,o;return x(this,(function(s){switch(s.label){case 0:this.stopped=!1,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t()];case 2:return r=s.sent(),this.analyseState$.next(!0),[3,4];case 3:return i=s.sent(),o="Failed to start workflow: "+String(i),this.log.warn(o),[2,n?n(o):Promise.reject(i)];case 4:return this.config.workflow=JSON.parse(JSON.stringify(e)),this.log.info("instance "+JSON.stringify(r)),this.log.info("workflow config "+JSON.stringify(this.config.workflow)),[2,r]}}))}))},o.prototype.autoJoin=function(e,t){return T(this,void 0,void 0,(function(){var n,r,i;return x(this,(function(o){switch(o.label){case 0:this.stopped=!1,this.config.instance.id_workflow_instance=e,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.REST.workflowInstance(e)];case 2:return n=o.sent(),[3,4];case 3:return r=o.sent(),i="Failed to join workflow instance: "+String(r),this.log.warn(i),[2,t?t(i):Promise.reject(r)];case 4:return"stopped"===n.state?(this.log.warn("workflow "+e+" is already stopped"),[2,t?t("could not join workflow"):Promise.reject(new Error("could not join workflow"))]):(this.config.workflow=this.config.workflow||{},this.log.debug("instance "+JSON.stringify(n)),this.log.debug("workflow config "+JSON.stringify(this.config.workflow)),this.setClassConfigREST(n),[2,this.autoConfigure(n,t)])}}))}))},o.prototype.setClassConfigGQL=function(e){var t=e.data.startData,n=t.bucket,r=t.idUser,i=t.remoteAddr,o=t.userDefined,s=void 0===o?{}:o,a=t.instance,u=a.outputqueue,c=a.keyId,l=a.startDate,h=a.idWorkflowInstance,f=a.mappedTelemetry,p=a.chain,d=a.workflowImage,g=d.region.name,m=d.workflow.idWorkflow,w=d.inputqueue,v={bucket:n,user_defined:s,id_user:parseInt(r),remote_addr:i,id_workflow_instance:h,key_id:c,start_date:l,outputQueueName:u,summaryTelemetry:f,inputQueueName:w,id_workflow:parseInt(m),region:g||this.config.options.region,bucketFolder:u+"/"+r+"/"+h,chain:re.convertResponseToObject(p)};this.config.instance=P(P({},this.config.instance),v)},o.prototype.setClassConfigREST=function(e){var t=this;["id_workflow_instance","id_workflow","remote_addr","key_id","bucket","user_defined","start_date","id_user"].forEach((function(n){t.config.instance[n]=e[n]})),this.config.instance.inputQueueName=e.inputqueue,this.config.instance.outputQueueName=e.outputqueue,this.config.instance.region=e.region||this.config.options.region,this.config.instance.bucketFolder=e.outputqueue+"/"+e.id_user+"/"+e.id_workflow_instance,this.config.instance.summaryTelemetry=e.telemetry,e.chain&&(this.config.instance.chain=re.convertResponseToObject(e.chain))},o.prototype.initSessionManager=function(e,n){return new ze(this.config.instance.id_workflow_instance,this.REST,j([t],n||[]),r.merge({sessionGrace:this.config.options.sessionGrace,proxy:this.config.options.proxy,region:this.config.instance.region,log:this.log,useGraphQL:this.config.options.useGraphQL},e),this.graphQL)},o.prototype.autoConfigure=function(e,t){return T(this,void 0,void 0,(function(){var r,i,o,a,u,c=this;return x(this,(function(l){switch(l.label){case 0:if(!this.config.options.inputFolders.length)throw new Error("must set inputFolder");if(!this.config.options.outputFolder)throw new Error("must set outputFolder");if(!this.config.instance.bucketFolder)throw new Error("bucketFolder must be set");if(!this.config.instance.inputQueueName)throw new Error("inputQueueName must be set");if(!this.config.instance.outputQueueName)throw new Error("outputQueueName must be set");return n.mkdirpSync(this.config.options.outputFolder),r=s.join(Be(),"instances"),i=s.join(r,this.config.instance.id_workflow_instance),this.db=new be(i,{idWorkflowInstance:this.config.instance.id_workflow_instance,inputFolders:this.config.options.inputFolders},this.log),o=this.config.instance.id_workflow_instance?"telemetry-"+this.config.instance.id_workflow_instance+".log":"telemetry.log",a=s.join(this.config.options.outputFolder,"epi2me-logs"),u=s.join(a,o),n.mkdirp(a,(function(e){if(e&&!String(e).match(/EEXIST/))c.log.error("error opening telemetry log stream: mkdirpException:"+String(e));else try{c.telemetryLogStream=n.createWriteStream(u,{flags:"a"}),c.log.info("logging telemetry to "+u)}catch(t){c.log.error("error opening telemetry log stream: "+String(t))}})),t&&t(null,this.config.instance),this.timers.summaryTelemetryInterval=setInterval((function(){c.stopped?clearInterval(c.timers.summaryTelemetryInterval):c.fetchTelemetry()}),1e4*this.config.options.downloadCheckInterval),this.timers.downloadCheckInterval=setInterval((function(){c.stopped?clearInterval(c.timers.downloadCheckInterval):c.checkForDownloads()}),1e3*this.config.options.downloadCheckInterval),this.timers.stateCheckInterval=setInterval((function(){return T(c,void 0,void 0,(function(){var e,t,n,r;return x(this,(function(i){switch(i.label){case 0:if(this.stopped)return clearInterval(this.timers.stateCheckInterval),[2];i.label=1;case 1:return i.trys.push([1,10,,11]),e=void 0,this.config.options.useGraphQL?[4,this.graphQL.query("query workflowInstance($idWorkflowInstance: ID!) {\n              instanceObj:workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n                stop_date: stopDate\n                state\n              }\n            }")({variables:{idWorkflowInstance:this.config.instance.id_workflow_instance}})]:[3,3];case 2:return e=i.sent().data.instanceObj,[3,5];case 3:return[4,this.REST.workflowInstance(this.config.instance.id_workflow_instance)];case 4:e=i.sent(),i.label=5;case 5:if("stopped"!==e.state)return[3,9];this.log.warn("instance was stopped remotely at "+e.stop_date+". shutting down the workflow."),i.label=6;case 6:return i.trys.push([6,8,,9]),[4,this.stopEverything()];case 7:return"function"===typeof(t=i.sent()).config.options.remoteShutdownCb&&t.config.options.remoteShutdownCb("instance was stopped remotely at "+e.stop_date),[3,9];case 8:return n=i.sent(),this.log.error("Error whilst stopping: "+String(n)),[3,9];case 9:return[3,11];case 10:return r=i.sent(),this.log.warn("failed to check instance state: "+((null===r||void 0===r?void 0:r.error)?r.error:r)),[3,11];case 11:return[2]}}))}))}),1e3*this.config.options.stateCheckInterval),this.sessionManager=this.initSessionManager(),[4,this.sessionManager.session()];case 1:return l.sent(),this.reportProgress(),this.loadUploadFiles(),this.uploadState$.next(!0),this.timers.fileCheckInterval=setInterval(this.loadUploadFiles.bind(this),1e3*this.config.options.fileCheckInterval),[2,Promise.resolve(e)]}}))}))},o.prototype.stopUpload=function(){return T(this,void 0,void 0,(function(){var t,n;return x(this,(function(r){switch(r.label){case 0:for(t=0,n=this.uploadsInProgress;t<n.length;t++)n[t].abort();return this.uploadsInProgress=[],[4,e.prototype.stopUpload.call(this)];case 1:return r.sent(),this.log.debug("clearing split files"),this.db?[2,this.db.splitClean()]:[2]}}))}))},o.prototype.stopEverything=function(){return T(this,void 0,void 0,(function(){return x(this,(function(t){switch(t.label){case 0:return delete this.sessionManager,[4,e.prototype.stopEverything.call(this)];case 1:return t.sent(),[2]}}))}))},o.prototype.checkForDownloads=function(){return T(this,void 0,void 0,(function(){var e,t,n;return x(this,(function(r){switch(r.label){case 0:if(this.checkForDownloadsRunning)return[2,Promise.resolve()];this.checkForDownloadsRunning=!0,this.log.debug("checkForDownloads checking for downloads"),r.label=1;case 1:return r.trys.push([1,7,,8]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 2:return e=r.sent(),[4,this.queueLength(e)];case 3:return(t=r.sent())?[3,4]:(this.log.debug("no downloads available"),[3,6]);case 4:return this.log.debug("downloads available: "+t),[4,this.downloadAvailable()];case 5:r.sent(),r.label=6;case 6:return[3,8];case 7:return n=r.sent(),this.log.warn("checkForDownloads error "+String(n)),this.states.download.failure||(this.states.download.failure={}),this.states.download.failure[n]=this.states.download.failure[n]?this.states.download.failure[n]+1:1,[3,8];case 8:return this.checkForDownloadsRunning=!1,[2,Promise.resolve()]}}))}))},o.prototype.downloadAvailable=function(){return T(this,void 0,void 0,(function(){var e,t,n,r;return x(this,(function(i){switch(i.label){case 0:if((e=Object.keys(this.downloadWorkerPool||{}).length)>=this.config.options.transferPoolSize)return this.log.debug(e+" downloads already queued"),[2,Promise.resolve()];i.label=1;case 1:return i.trys.push([1,5,,6]),[4,this.discoverQueue(this.config.instance.outputQueueName)];case 2:return n=i.sent(),this.log.debug("fetching messages"),[4,this.sessionedSQS()];case 3:return[4,i.sent().receiveMessage({AttributeNames:["All"],QueueUrl:n,VisibilityTimeout:this.config.options.inFlightDelay,MaxNumberOfMessages:this.config.options.transferPoolSize-e,WaitTimeSeconds:this.config.options.waitTimeSeconds}).promise()];case 4:return t=i.sent(),[3,6];case 5:return r=i.sent(),this.log.error("receiveMessage exception: "+String(r)),this.states.download.failure[r]=this.states.download.failure[r]?this.states.download.failure[r]+1:1,[2,Promise.reject(r)];case 6:return[2,this.receiveMessages(t)]}}))}))},o.prototype.loadUploadFiles=function(){return T(this,void 0,void 0,(function(){var e,t,n,r,i,o=this;return x(this,(function(s){switch(s.label){case 0:if(this.dirScanInProgress)return[2,Promise.resolve()];this.dirScanInProgress=!0,this.log.debug("upload: started directory scan"),s.label=1;case 1:return s.trys.push([1,6,,7]),e=function(e){return o.db.seenUpload(e)},[4,re.loadInputFiles(this.config.options,this.log,e)];case 2:t=s.sent(),n=0,r=function(){return new Promise((function(e){if(o.stopped)return t.length=0,o.log.debug("upload: skipping, stopped"),void e();if(n>o.config.options.transferPoolSize)setTimeout(e,1e3);else{var r=t.splice(0,o.config.options.transferPoolSize-n);n+=r.length,o.enqueueUploadFiles(r).then().catch((function(e){o.log.error("upload: exception in enqueueUploadFiles: "+String(e))})).finally((function(){n-=r.length,e()}))}}))},s.label=3;case 3:return t.length?[4,r()]:[3,5];case 4:return s.sent(),[3,3];case 5:return[3,7];case 6:return i=s.sent(),this.log.error("upload: exception in loadInputFiles: "+String(i)),[3,7];case 7:return this.dirScanInProgress=!1,this.log.debug("upload: finished directory scan"),[2,Promise.resolve()]}}))}))},o.prototype.enqueueUploadFiles=function(e){return T(this,void 0,void 0,(function(){var t,n,i,o,a,u,c,l,h,f=this;return x(this,(function(p){switch(p.label){case 0:if(t=0,n=0,i=0,o=0,a={},!r.isArray(e)||!e.length)return[2,Promise.resolve()];if(this.log.info("enqueueUploadFiles "+e.length+" files: "+e.map((function(e){return e.path})).join(" ")+"."),"workflow"in this.config&&("workflow_attributes"in this.config.workflow?a=this.config.workflow.workflow_attributes:"attributes"in this.config.workflow&&((u=this.config.workflow.attributes)||(u={}),["max_size","max_files","split_size","split_reads"].forEach((function(e){"epi2me:"+e in u&&(a[e]=parseInt(u["epi2me:"+e],10))})),"epi2me:category"in u&&u["epi2me:category"].includes("storage")&&(a.requires_storage=!0))),this.log.info("enqueueUploadFiles settings "+JSON.stringify(a)),"requires_storage"in a&&a.requires_storage&&!("storage_account"in this.config.workflow))return c={msg:"ERROR: Workflow requires storage enabled. Please provide a valid storage account [ --storage ].",type:"WARNING_STORAGE_ENABLED"},this.log.error(c.msg),this.states.warnings.push(c),[2,Promise.resolve()];if("split_size"in a&&(i=parseInt(a.split_size,10),this.log.info("enqueueUploadFiles splitting supported files at "+i+" bytes")),"split_reads"in a&&(o=parseInt(a.split_reads,10),this.log.info("enqueueUploadFiles splitting supported files at "+o+" reads")),"max_size"in a&&(n=parseInt(a.max_size,10),this.log.info("enqueueUploadFiles restricting file size to "+n)),"max_files"in a&&(t=parseInt(a.max_files,10),this.log.info("enqueueUploadFiles restricting file count to "+t),e.length>t))return c={msg:"ERROR: "+e.length+" files found. Workflow can only accept "+t+". Please move the extra files away.",type:"WARNING_FILE_TOO_MANY"},this.log.error(c.msg),this.states.warnings.push(c),[2,Promise.resolve()];this.states.upload.filesCount+=e.length,l=e.map((function(e){return T(f,void 0,void 0,(function(){var r,a,u,c,l,h,f,p,d,g,m,w,v,y=this;return x(this,(function(b){switch(b.label){case 0:return r=e,t&&this.states.upload.filesCount>t?(d="Maximum "+t+" file(s) already uploaded. Marking "+r.relative+" as skipped.",g={msg:d,type:"WARNING_FILE_TOO_MANY"},this.log.error(d),this.states.warnings.push(g),this.states.upload.filesCount-=1,r.skip="SKIP_TOO_MANY",[3,11]):[3,1];case 1:return 0!==r.size?[3,2]:(d='The file "'+r.relative+'" is empty. It will be skipped.',g={msg:d,type:"WARNING_FILE_EMPTY"},r.skip="SKIP_EMPTY",this.states.upload.filesCount-=1,this.log.error(d),this.states.warnings.push(g),[3,11]);case 2:if(!((null===(v=r.path)||void 0===v?void 0:v.match(/\.(?:fastq|fq)(?:\.gz)?$/))&&(i&&r.size>i||o)))return[3,7];d=r.relative+(r.size>i?" is too big and":"")+" is going to be split",this.log.warn(d),g={msg:d,type:"WARNING_FILE_SPLIT"},this.states.warnings.push(g),a=i?{maxChunkBytes:i}:{maxChunkReads:o},u=r.path.match(/\.gz$/)?Je:He,c=re.getFileID(),l=new De({bandwidth:this.config.options.transferPoolSize}),h=0,f=function(e){return T(y,void 0,void 0,(function(){var t=this;return x(this,(function(n){switch(n.label){case 0:return this.log.debug("chunkHandler for "+e),[4,this.db.splitFile(e,r.path)];case 1:return n.sent(),this.stopped?(l.stop(),this.log.info("stopped, so skipping "+e),[2,Promise.reject(new Error("stopped"))]):(h+=1,[2,Me(e).then((function(n){return{name:s.basename(e),path:e,relative:e.replace(t.config.options.inputFolder,""),id:c+"_"+h,stats:n,size:n.bytes}})).then((function(e){return T(t,void 0,void 0,(function(){var t=this;return x(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){l.enqueue((function(){return t.log.info("chunk upload starting "+e.id+" "+e.path),t.stopped?(t.log.info("chunk upload skipped (stopped) "+e.id+" "+e.path),l.stop(),n(),Promise.resolve()):t.uploadJob(e).then((function(){return t.db.splitDone(e.path)})).catch((function(n){t.log.error("chunk upload failed "+e.id+" "+e.path+": "+String(n))})).finally(n)}))}))];case 1:return n.sent(),[2]}}))}))}))])}}))}))},b.label=3;case 3:return b.trys.push([3,5,,6]),[4,u(r.path,a,f,this.log)];case 4:return b.sent(),l.stop(),[3,6];case 5:if(p=b.sent(),l.stop(),"Error: stopped"===String(p))return[2,Promise.resolve()];throw p;case 6:return[2,this.db.uploadFile(r.path)];case 7:return n&&r.size>n?(d='The file "'+r.relative+'" is bigger than the maximum size limit ('+Oe(n)+"B). It will be skipped.",g={msg:d,type:"WARNING_FILE_TOO_BIG"},r.skip="SKIP_TOO_BIG",this.states.upload.filesCount-=1,this.log.error(d),this.states.warnings.push(g),[3,11]):[3,8];case 8:return b.trys.push([8,10,,11]),m=r,[4,Me(r.path)];case 9:return m.stats=b.sent(),[3,11];case 10:return w=b.sent(),this.log.error("failed to stat "+r.path+": "+String(w)),[3,11];case 11:return[2,this.uploadJob(r)]}}))}))})),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,Promise.all(l)];case 2:return p.sent(),this.log.info("upload: inputBatchQueue ("+l.length+" jobs) complete"),[2,this.loadUploadFiles()];case 3:return h=p.sent(),this.log.error("upload: enqueueUploadFiles exception "+String(h)),[2,Promise.reject(h)];case 4:return[2]}}))}))},o.prototype.uploadJob=function(e){return T(this,void 0,void 0,(function(){var t,n,i,o,a;return x(this,(function(u){switch(u.label){case 0:if("skip"in e)return[2,this.db.skipFile(e.path)];u.label=1;case 1:return u.trys.push([1,3,,4]),this.log.info("upload: "+e.id+" starting"),[4,this.uploadHandler(e)];case 2:return t=u.sent(),this.log.info("upload: "+t.id+" uploaded and notified"),[3,4];case 3:return i=u.sent(),n=i,this.log.error("upload: "+e.id+" done, but failed: "+String(n)),[3,4];case 4:if(t||(t={}),n){if(this.log.error("uploadJob "+n),this.states.upload.failure||(this.states.upload.failure={}),this.states.upload.failure[n]=this.states.upload.failure[n]?this.states.upload.failure[n]+1:1,String(n).match(/AWS.SimpleQueueService.NonExistentQueue/))return this.log.error("instance stopped because of a fatal error"),[2,this.stopEverything()]}else this.uploadState("success","incr",r.merge({files:1},t.stats)),t.name&&(o=s.extname(t.name),this.uploadState("types","incr",((a={})[o]=1,a)));return[2,Promise.resolve()]}}))}))},o.prototype.receiveMessages=function(e){return T(this,void 0,void 0,(function(){var t=this;return x(this,(function(n){return e&&e.Messages&&e.Messages.length?(this.downloadWorkerPool||(this.downloadWorkerPool={}),e.Messages.forEach((function(e){t.downloadWorkerPool[e.MessageId]=1;var n=setTimeout((function(){throw t.log.error("this.downloadWorkerPool timeoutHandle. Clearing queue slot for message: "+e.MessageId),new Error("download timed out")}),1e3*(60+t.config.options.downloadTimeout));t.processMessage(e).catch((function(e){t.log.error("processMessage "+String(e))})).finally((function(){clearTimeout(n),e&&delete t.downloadWorkerPool[e.MessageId]}))})),this.log.info("downloader queued "+e.Messages.length+" messages for processing"),[2,Promise.resolve()]):(this.log.info("complete (empty)"),[2,Promise.resolve()])}))}))},o.prototype.processMessage=function(e){var t,o,a,u,c,l,h;return T(this,void 0,void 0,(function(){var f,p,d,g,m,w,v,y,b,k,S,I,_,E,P,T,O,R,A=this;return x(this,(function(x){switch(x.label){case 0:if(!e)return this.log.debug("download.processMessage: empty message"),[2,Promise.resolve()];"Attributes"in e&&"ApproximateReceiveCount"in e.Attributes&&this.log.debug("download.processMessage: "+e.MessageId+" / "+e.Attributes.ApproximateReceiveCount),x.label=1;case 1:return x.trys.push([1,2,,7]),f=JSON.parse(e.Body),[3,7];case 2:d=x.sent(),this.log.error("error parsing JSON message.Body from message: "+JSON.stringify(e)+" "+String(d)),x.label=3;case 3:return x.trys.push([3,5,,6]),[4,this.deleteMessage(e)];case 4:return x.sent(),[3,6];case 5:return g=x.sent(),this.log.error("Exception deleting message: "+String(g)),[3,6];case 6:return[2,Promise.resolve()];case 7:if(!f.telemetry)return[3,13];if(!(m=f.telemetry).tm_path)return[3,12];x.label=8;case 8:return x.trys.push([8,11,,12]),this.log.debug("download.processMessage: "+e.MessageId+" fetching telemetry"),[4,this.sessionedS3()];case 9:return[4,x.sent().getObject({Bucket:f.bucket,Key:m.tm_path}).promise()];case 10:return w=x.sent(),this.log.info("download.processMessage: "+e.MessageId+" fetched telemetry"),m.batch=w.Body.toString("utf-8").split("\n").filter((function(e){return(null===e||void 0===e?void 0:e.length)>0})).map((function(e){try{return JSON.parse(e)}catch(t){return A.log.error("Telemetry Batch JSON Parse error: "+String(t)),e}})),[3,12];case 11:return v=x.sent(),this.log.error("Could not fetch telemetry JSON: "+String(v)),[3,12];case 12:try{this.telemetryLogStream.write(JSON.stringify(m)+i.EOL)}catch($){this.log.error("error writing telemetry: "+$)}this.config.options.telemetryCb&&this.config.options.telemetryCb(m),x.label=13;case 13:if(!f.path)return this.log.warn("nothing to download"),[2,Promise.resolve()];if(y=f.path.match(/[\w\W]*\/([\w\W]*?)$/),b=y?y[1]:"",p=s.join(this.config.options.outputFolder,this.config.instance.id_workflow_instance||""),(null===(o=null===(t=f.telemetry)||void 0===t?void 0:t.hints)||void 0===o?void 0:o.folder)&&(this.log.debug("using folder hint "+f.telemetry.hints.folder),k=f.telemetry.hints.folder.split("/").map((function(e){return e.toUpperCase()})),p=s.join.apply(null,j([p],k))),n.mkdirpSync(p),S=s.join(p,b),"data+telemetry"!==this.config.options.downloadMode)return[3,18];I=[""],("string"===typeof(_=(null===(c=null===(u=null===(a=this.config)||void 0===a?void 0:a.workflow)||void 0===u?void 0:u.settings)||void 0===c?void 0:c.output_format)?this.config.workflow.settings.output_format:[])||_ instanceof String)&&(_=_.trim().split(/[\s,]+/));try{I.push.apply(I,_)}catch(q){this.log.error("Failed to work out workflow file suffixes: "+String(q))}x.label=14;case 14:return x.trys.push([14,16,,17]),E=I.map((function(t){var n=f.path+t,r=S+t;return A.log.debug("download.processMessage: "+e.MessageId+" downloading "+n+" to "+r),new Promise((function(i,o){A.initiateDownloadStream({bucket:f.bucket,path:n},e,r).then(i).catch((function(e){A.log.error("Caught exception waiting for initiateDownloadStream: "+String(e)),t?o(e):i()}))}))})),[4,Promise.all(E)];case 15:return x.sent(),[3,17];case 16:return P=x.sent(),this.log.error("Exception fetching file batch: "+String(P)),[3,17];case 17:try{(T=!(null===(l=f.telemetry)||void 0===l||!l.json)&&f.telemetry.json.exit_status)&&this.config.options.dataCb&&this.config.options.dataCb(S,T)}catch(N){this.log.warn("failed to fire data callback: "+N)}return[3,19];case 18:O=(null===(h=f.telemetry.batch_summary)||void 0===h?void 0:h.reads_num)?f.telemetry.batch_summary.reads_num:1,this.downloadState("success","incr",{files:1,reads:O}),x.label=19;case 19:return x.trys.push([19,21,,22]),[4,this.deleteMessage(e)];case 20:return x.sent(),[3,22];case 21:return R=x.sent(),this.log.error("Exception deleting message: "+String(R)),[3,22];case 22:return this.realtimeFeedback("workflow_instance:state",{type:"stop",id_workflow_instance:this.config.instance.id_workflow_instance,id_workflow:this.config.instance.id_workflow,component_id:"0",message_id:r.merge(e).MessageId,id_user:this.config.instance.id_user}).catch((function(e){A.log.warn("realtimeFeedback failed: "+String(e))})),[2,Promise.resolve()]}}))}))},o.prototype.initiateDownloadStream=function(e,t,i){return T(this,void 0,void 0,(function(){var o=this;return x(this,(function(a){return[2,new Promise((function(a,u){return T(o,void 0,void 0,(function(){var o,c,l,h,f,p,d,g,m,w=this;return x(this,(function(v){switch(v.label){case 0:return v.trys.push([0,2,,3]),[4,this.sessionedS3()];case 1:return o=v.sent(),[3,3];case 2:return c=v.sent(),u(c),[3,3];case 3:f=function(t){if(w.log.error("Error during stream of bucket="+e.bucket+" path="+e.path+" to file="+i+" "+String(t)),clearTimeout(w.timers.transferTimeouts[i]),delete w.timers.transferTimeouts[i],!l.networkStreamError)try{l.networkStreamError=1,l.close(),n.remove(i).then((function(){w.log.warn("removed failed download "+i)})).catch((function(e){w.log.warn("failed to remove "+i+". unlinkException: "+String(e))})),h.destroy&&(w.log.error("destroying read stream for "+i),h.destroy())}catch(r){w.log.error("error handling stream error: "+String(r))}};try{p={Bucket:e.bucket,Key:e.path},l=n.createWriteStream(i),(d=o.getObject(p)).on("httpHeaders",(function(e,t){w.downloadState("progress","incr",{total:parseInt(t["content-length"],10)})})),h=d.createReadStream()}catch(y){return this.log.error("getObject/createReadStream exception: "+String(y)),u(y),[2]}return h.on("error",f),l.on("finish",(function(){return T(w,void 0,void 0,(function(){var e,t,n,o;return x(this,(function(a){switch(a.label){case 0:if(l.networkStreamError)return[2];this.log.debug("downloaded "+i),a.label=1;case 1:return a.trys.push([1,3,,4]),e=s.extname(i),[4,Me(i)];case 2:return t=a.sent(),this.downloadState("success","incr",r.merge({files:1},t)),this.downloadState("types","incr",((o={})[e]=1,o)),this.downloadState("progress","decr",{total:t.bytes,bytes:t.bytes}),[3,4];case 3:return n=a.sent(),this.log.warn("failed to stat "+i+": "+String(n)),[3,4];case 4:return this.reportProgress(),[2]}}))}))})),l.on("close",(function(n){w.log.debug("closing writeStream "+i),n&&w.log.error("error closing write stream "+n),clearInterval(w.timers.visibilityIntervals[i]),delete w.timers.visibilityIntervals[i],clearTimeout(w.timers.transferTimeouts[i]),delete w.timers.transferTimeouts[i],setTimeout(w.checkForDownloads.bind(w)),w.log.info("download.initiateDownloadStream: "+t.MessageId+" downloaded "+e.path+" to "+i),a()})),l.on("error",f),g=function(){f(new Error("transfer timed out"))},this.timers.transferTimeouts[i]=setTimeout(g,1e3*this.config.options.downloadTimeout),m=function(){return T(w,void 0,void 0,(function(){var e,n,r;return x(this,(function(o){switch(o.label){case 0:this.stopped&&(clearInterval(this.timers.visibilityIntervals[i]),delete this.timers.visibilityIntervals[i]),e=this.config.instance.outputQueueURL,n=t.ReceiptHandle,this.log.debug({message_id:t.MessageId},"updateVisibility"),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.sqs.changeMessageVisibility({QueueUrl:e,ReceiptHandle:n,VisibilityTimeout:this.config.options.inFlightDelay}).promise()];case 2:return o.sent(),[3,4];case 3:return r=o.sent(),this.log.error({message_id:t.MessageId,queue:e,error:r},"Error setting visibility"),clearInterval(this.timers.visibilityIntervals[i]),[3,4];case 4:return[2]}}))}))},this.timers.visibilityIntervals[i]=setInterval(m,900*this.config.options.inFlightDelay),h.on("data",(function(e){clearTimeout(w.timers.transferTimeouts[i]),w.timers.transferTimeouts[i]=setTimeout(g,1e3*w.config.options.downloadTimeout),w.downloadState("progress","incr",{bytes:e.length})})).pipe(l),[2]}}))}))}))]}))}))},o.prototype.uploadHandler=function(e){return T(this,void 0,void 0,(function(){var t,r,i,o,s,a=this;return x(this,(function(u){switch(u.label){case 0:return[4,this.sessionedS3()];case 1:return t=u.sent(),i=e.relative.replace(/^[\\/]+/,"").replace(/\\/g,"/").replace(/\//g,"_"),o=[this.config.instance.bucketFolder,"component-0",i,i].join("/").replace(/\/+/g,"/"),[2,new Promise((function(i,u){var c=function(){r&&!r.closed&&r.close(),u(new Error(e.name+" timed out"))};s=setTimeout(c,1e3*(a.config.options.uploadTimeout+5));try{r=n.createReadStream(e.path)}catch(l){return clearTimeout(s),void u(l)}r.on("error",(function(e){r.close();var t="error in upload readstream";(null===e||void 0===e?void 0:e.message)&&(t+=": "+e.message),clearTimeout(s),u(new Error(t))})),r.on("open",(function(){var n={Bucket:a.config.instance.bucket,Key:o,Body:r};a.config.instance.key_id&&(n.SSEKMSKeyId=a.config.instance.key_id,n.ServerSideEncryption="aws:kms"),e.size&&(n["Content-Length"]=e.size),a.uploadState("progress","incr",{total:e.size});var l=0,h=t.upload(n,{partSize:10485760,queueSize:1});a.uploadsInProgress.push(h);var f=a.initSessionManager(null,[h.service]);f.sts_expiration=a.sessionManager.sts_expiration,h.on("httpUploadProgress",(function(e){return T(a,void 0,void 0,(function(){var t;return x(this,(function(n){switch(n.label){case 0:this.uploadState("progress","incr",{bytes:e.loaded-l}),l=e.loaded,clearTimeout(s),s=setTimeout(c,1e3*(this.config.options.uploadTimeout+5)),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,f.session()];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),this.log.warn("Error refreshing token: "+String(t)),[3,4];case 4:return[2]}}))}))})),h.promise().then((function(){a.log.info(e.id+" S3 upload complete"),r.close(),clearTimeout(s),a.uploadComplete(o,e).then((function(){i(e)})).catch((function(e){console.log("catch"),u(e)})).finally((function(){a.uploadState("progress","decr",{total:e.size,bytes:e.size}),a.uploadsInProgress=a.uploadsInProgress.filter((function(e){return e!==h}))}))})).catch((function(t){a.log.warn(e.id+" uploadStreamError "+t),u(t)}))}))}))]}}))}))},o.prototype.uploadComplete=function(e,t){return T(this,void 0,void 0,(function(){var n,i,o,s,a,u=this;return x(this,(function(c){switch(c.label){case 0:if(this.log.info(t.id+" uploaded to S3: "+e),n={bucket:this.config.instance.bucket,outputQueue:this.config.instance.outputQueueName,remote_addr:this.config.instance.remote_addr,user_defined:this.config.instance.user_defined||null,apikey:this.config.options.apikey,id_workflow_instance:this.config.instance.id_workflow_instance,id_master:this.config.instance.id_workflow,utc:(new Date).toISOString(),path:e,prefix:e.substring(0,e.lastIndexOf("/"))},this.config.instance.chain)try{n.components=JSON.parse(JSON.stringify(this.config.instance.chain.components)),n.targetComponentId=this.config.instance.chain.targetComponentId}catch(l){return this.log.error(t.id+" exception parsing components JSON "+String(l)),[2,Promise.reject(l)]}if(this.config.instance.key_id&&(n.key_id=this.config.instance.key_id),this.config.options.agent_address)try{n.agent_address=JSON.parse(this.config.options.agent_address)}catch(h){this.log.error(t.id+" Could not parse agent_address "+String(h))}n.components&&Object.keys(n.components).forEach((function(e){"uploadMessageQueue"===n.components[e].inputQueueName&&(n.components[e].inputQueueName=u.uploadMessageQueue),"downloadMessageQueue"===n.components[e].inputQueueName&&(n.components[e].inputQueueName=u.downloadMessageQueue)})),i={},c.label=1;case 1:return c.trys.push([1,5,,6]),[4,this.discoverQueue(this.config.instance.inputQueueName)];case 2:return o=c.sent(),[4,this.sessionedSQS()];case 3:return s=c.sent(),this.log.info(t.id+" sending SQS message to input queue"),[4,s.sendMessage({QueueUrl:o,MessageBody:JSON.stringify(n)}).promise()];case 4:return i=c.sent(),[3,6];case 5:return a=c.sent(),this.log.error(t.id+" exception sending SQS message: "+String(a)),[2,Promise.reject(a)];case 6:return this.realtimeFeedback("workflow_instance:state",{type:"start",id_workflow_instance:this.config.instance.id_workflow_instance,id_workflow:this.config.instance.id_workflow,component_id:"0",message_id:r.merge(i).MessageId,id_user:this.config.instance.id_user}).catch((function(e){u.log.warn("realtimeFeedback failed: "+String(e))})),this.log.info(t.id+" SQS message sent. Mark as uploaded"),[2,this.db.uploadFile(t.path)]}}))}))},o.prototype.fetchTelemetry=function(){var e,t;return T(this,void 0,void 0,(function(){var r,i,o,a,u,c=this;return x(this,(function(l){switch(l.label){case 0:if(!(null===(t=null===(e=this.config)||void 0===e?void 0:e.instance)||void 0===t?void 0:t.summaryTelemetry))return[2,Promise.resolve()];r=s.join(Be(),"instances"),i=s.join(r,this.config.instance.id_workflow_instance),o=[],Object.keys(this.config.instance.summaryTelemetry).forEach((function(e){var t=c.config.instance.summaryTelemetry[e]||{},r=t[Object.keys(t)[0]];if(r){r.startsWith("http")||(r=F(c.config.options.url,r));var a=s.join(i,e+".json");o.push(c.REST.fetchContent(r).then((function(e){return n.writeJSONSync(a,e),c.reportState$.next(!0),c.log.debug("fetched telemetry summary "+a),Promise.resolve(e)})).catch((function(e){return c.log.debug("Error fetching telemetry: "+String(e)),Promise.resolve(null)})))}})),a=0,l.label=1;case 1:return l.trys.push([1,3,,4]),[4,Promise.all(o)];case 2:return u=l.sent(),this.instanceTelemetry$.next(u),[3,4];case 3:return l.sent(),a+=1,[3,4];case 4:return a&&this.log.warn("summary telemetry incomplete"),[2,Promise.resolve()]}}))}))},o}(qe);Ge.version=re.version,Ge.REST=Qe,Ge.utils=re,Ge.SessionManager=ze,Ge.EPI2ME_HOME=Be(),Ge.Profile=Fe,Ge.Factory=Ne,module.exports=Ge;
