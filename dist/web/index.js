/**
 * Copyright Metrichor Ltd. (An Oxford Nanopore Technologies Company) 2020
 */

"use strict";function e(e){return e&&"object"===typeof e&&"default"in e?e.default:e}var t=require("lodash"),n=require("rxjs"),r=e(require("graphql-tag")),o=require("apollo-cache-inmemory"),s=e(require("apollo-client")),i=require("apollo-link"),a=require("apollo-link-http"),u=require("@lifeomic/axios-fetch"),c=e(require("axios")),h=e(require("crypto")),l=require("tunnel"),p=e(require("os")),f=e(require("socket.io-client")),d=function(){return(d=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function g(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(t){s(t)}}function a(e){try{u(r.throw(e))}catch(t){s(t)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}u((r=r.apply(e,t||[])).next())}))}function m(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(a){s=[6,a],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function w(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var s=arguments[t],i=0,a=s.length;i<a;i++,o++)r[o]=s[i];return r}function v(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var y="https://epi2me.nanoporetech.com",k={local:!1,url:y,user_agent:"EPI2ME API",region:"eu-west-1",sessionGrace:5,uploadTimeout:1200,downloadTimeout:1200,fileCheckInterval:5,downloadCheckInterval:3,stateCheckInterval:60,inFlightDelay:600,waitTimeSeconds:20,waitTokenError:30,transferPoolSize:3,downloadMode:"data+telemetry",filetype:[".fastq",".fq",".fastq.gz",".fq.gz"],signing:!0,sampleDirectory:"/data"},b="\npage\npages\nhasNext\nhasPrevious\ntotalCount\n",I="\nidWorkflowInstance\nstartDate\nworkflowImage{\n  workflow\n  {\n    rev\n    name\n  }\n}\n",$="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};function S(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===t||null===t)&&n.path)}},n.exports),n.exports}var j=S((function(e,t){!function(n){var r=t&&!t.nodeType&&t,o=e&&!e.nodeType&&e,s="object"==typeof $&&$;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var i,a,u=2147483647,c=/^xn--/,h=/[^\x20-\x7E]/,l=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,d=String.fromCharCode;function g(e){throw RangeError(p[e])}function m(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function w(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+m((e=e.replace(l,".")).split("."),t).join(".")}function v(e){for(var t,n,r=[],o=0,s=e.length;o<s;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<s?56320==(64512&(n=e.charCodeAt(o++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),o--):r.push(t);return r}function y(e){return m(e,(function(e){var t="";return e>65535&&(t+=d((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=d(e)})).join("")}function k(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function b(e,t,n){var r=0;for(e=n?f(e/700):e>>1,e+=f(e/t);e>455;r+=36)e=f(e/35);return f(r+36*e/(e+38))}function I(e){var t,n,r,o,s,i,a,c,h,l,p,d=[],m=e.length,w=0,v=128,k=72;for((n=e.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&g("not-basic"),d.push(e.charCodeAt(r));for(o=n>0?n+1:0;o<m;){for(s=w,i=1,a=36;o>=m&&g("invalid-input"),((c=(p=e.charCodeAt(o++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:36)>=36||c>f((u-w)/i))&&g("overflow"),w+=c*i,!(c<(h=a<=k?1:a>=k+26?26:a-k));a+=36)i>f(u/(l=36-h))&&g("overflow"),i*=l;k=b(w-s,t=d.length+1,0==s),f(w/t)>u-v&&g("overflow"),v+=f(w/t),w%=t,d.splice(w++,0,v)}return y(d)}function S(e){var t,n,r,o,s,i,a,c,h,l,p,m,w,y,I,$=[];for(m=(e=v(e)).length,t=128,n=0,s=72,i=0;i<m;++i)(p=e[i])<128&&$.push(d(p));for(r=o=$.length,o&&$.push("-");r<m;){for(a=u,i=0;i<m;++i)(p=e[i])>=t&&p<a&&(a=p);for(a-t>f((u-n)/(w=r+1))&&g("overflow"),n+=(a-t)*w,t=a,i=0;i<m;++i)if((p=e[i])<t&&++n>u&&g("overflow"),p==t){for(c=n,h=36;!(c<(l=h<=s?1:h>=s+26?26:h-s));h+=36)I=c-l,y=36-l,$.push(d(k(l+I%y,0))),c=f(I/y);$.push(d(k(c,0))),s=b(n,w,r==o),n=0,++r}++n,++t}return $.join("")}if(i={version:"1.3.2",ucs2:{decode:v,encode:y},decode:I,encode:S,toASCII:function(e){return w(e,(function(e){return h.test(e)?"xn--"+S(e):e}))},toUnicode:function(e){return w(e,(function(e){return c.test(e)?I(e.slice(4).toLowerCase()):e}))}},r&&o)if(e.exports==r)o.exports=i;else for(a in i)i.hasOwnProperty(a)&&(r[a]=i[a]);else n.punycode=i}($)}));function x(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var P=function(e,t,n,r){t=t||"&",n=n||"=";var o={};if("string"!==typeof e||0===e.length)return o;var s=/\+/g;e=e.split(t);var i=1e3;r&&"number"===typeof r.maxKeys&&(i=r.maxKeys);var a=e.length;i>0&&a>i&&(a=i);for(var u=0;u<a;++u){var c,h,l,p,f=e[u].replace(s,"%20"),d=f.indexOf(n);d>=0?(c=f.substr(0,d),h=f.substr(d+1)):(c=f,h=""),l=decodeURIComponent(c),p=decodeURIComponent(h),x(o,l)?Array.isArray(o[l])?o[l].push(p):o[l]=[o[l],p]:o[l]=p}return o},T=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}},E=function(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"===typeof e?Object.keys(e).map((function(r){var o=encodeURIComponent(T(r))+n;return Array.isArray(e[r])?e[r].map((function(e){return o+encodeURIComponent(T(e))})).join(t):o+encodeURIComponent(T(e[r]))})).join(t):r?encodeURIComponent(T(r))+n+encodeURIComponent(T(e)):""},A=S((function(e,t){t.decode=t.parse=P,t.encode=t.stringify=E})),O=function(e,t){return F(e,!1,!0).resolve(t)};function _(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var W=/^([a-z0-9.+-]+:)/i,q=/:[0-9]*$/,C=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),D=["'"].concat(C),R=["%","/","?",";","#"].concat(D),U=["/","?","#"],H=/^[a-z0-9A-Z_-]{0,63}$/,z=/^([a-z0-9A-Z_-]{0,63})(.*)$/,B={javascript:!0,"javascript:":!0},N={javascript:!0,"javascript:":!0},M={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function F(e,t,n){if(e&&G(e)&&e instanceof _)return e;var r=new _;return r.parse(e,t,n),r}function J(e){return"string"===typeof e}function G(e){return"object"===typeof e&&null!==e}function L(e){return null===e}_.prototype.parse=function(e,t,n){if(!J(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var r=e;r=r.trim();var o=W.exec(r);if(o){var s=(o=o[0]).toLowerCase();this.protocol=s,r=r.substr(o.length)}if(n||o||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var i="//"===r.substr(0,2);!i||o&&N[o]||(r=r.substr(2),this.slashes=!0)}if(!N[o]&&(i||o&&!M[o])){for(var a,u,c=-1,h=0;h<U.length;h++){-1!==(l=r.indexOf(U[h]))&&(-1===c||l<c)&&(c=l)}-1!==(u=-1===c?r.lastIndexOf("@"):r.lastIndexOf("@",c))&&(a=r.slice(0,u),r=r.slice(u+1),this.auth=decodeURIComponent(a)),c=-1;for(h=0;h<R.length;h++){var l;-1!==(l=r.indexOf(R[h]))&&(-1===c||l<c)&&(c=l)}-1===c&&(c=r.length),this.host=r.slice(0,c),r=r.slice(c),this.parseHost(),this.hostname=this.hostname||"";var p="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!p)for(var f=this.hostname.split(/\./),d=(h=0,f.length);h<d;h++){var g=f[h];if(g&&!g.match(H)){for(var m="",w=0,v=g.length;w<v;w++)g.charCodeAt(w)>127?m+="x":m+=g[w];if(!m.match(H)){var y=f.slice(0,h),k=f.slice(h+1),b=g.match(z);b&&(y.push(b[1]),k.unshift(b[2])),k.length&&(r="/"+k.join(".")+r),this.hostname=y.join(".");break}}}if(this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),!p){var I=this.hostname.split("."),$=[];for(h=0;h<I.length;++h){var S=I[h];$.push(S.match(/[^A-Za-z0-9_-]/)?"xn--"+j.encode(S):S)}this.hostname=$.join(".")}var x=this.port?":"+this.port:"",P=this.hostname||"";this.host=P+x,this.href+=this.host,p&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==r[0]&&(r="/"+r))}if(!B[s])for(h=0,d=D.length;h<d;h++){var T=D[h],E=encodeURIComponent(T);E===T&&(E=escape(T)),r=r.split(T).join(E)}var O=r.indexOf("#");-1!==O&&(this.hash=r.substr(O),r=r.slice(0,O));var _=r.indexOf("?");if(-1!==_?(this.search=r.substr(_),this.query=r.substr(_+1),t&&(this.query=A.parse(this.query)),r=r.slice(0,_)):t&&(this.search="",this.query={}),r&&(this.pathname=r),M[s]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){x=this.pathname||"",S=this.search||"";this.path=x+S}return this.href=this.format(),this},_.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",o=!1,s="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&G(this.query)&&Object.keys(this.query).length&&(s=A.stringify(this.query));var i=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||M[t])&&!1!==o?(o="//"+(o||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):o||(o=""),r&&"#"!==r.charAt(0)&&(r="#"+r),i&&"?"!==i.charAt(0)&&(i="?"+i),t+o+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(i=i.replace("#","%23"))+r},_.prototype.resolve=function(e){return this.resolveObject(F(e,!1,!0)).format()},_.prototype.resolveObject=function(e){if(J(e)){var t=new _;t.parse(e,!1,!0),e=t}var n=new _;if(Object.keys(this).forEach((function(e){n[e]=this[e]}),this),n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol)return Object.keys(e).forEach((function(t){"protocol"!==t&&(n[t]=e[t])})),M[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n;if(e.protocol&&e.protocol!==n.protocol){if(!M[e.protocol])return Object.keys(e).forEach((function(t){n[t]=e[t]})),n.href=n.format(),n;if(n.protocol=e.protocol,e.host||N[e.protocol])n.pathname=e.pathname;else{for(var r=(e.pathname||"").split("/");r.length&&!(e.host=r.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==r[0]&&r.unshift(""),r.length<2&&r.unshift(""),n.pathname=r.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var o=n.pathname||"",s=n.search||"";n.path=o+s}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var i=n.pathname&&"/"===n.pathname.charAt(0),a=e.host||e.pathname&&"/"===e.pathname.charAt(0),u=a||i||n.host&&e.pathname,c=u,h=n.pathname&&n.pathname.split("/")||[],l=(r=e.pathname&&e.pathname.split("/")||[],n.protocol&&!M[n.protocol]);if(l&&(n.hostname="",n.port=null,n.host&&(""===h[0]?h[0]=n.host:h.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===r[0]?r[0]=e.host:r.unshift(e.host)),e.host=null),u=u&&(""===r[0]||""===h[0])),a)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,h=r;else if(r.length)h||(h=[]),h.pop(),h=h.concat(r),n.search=e.search,n.query=e.query;else if(null!=e.search){if(l)n.hostname=n.host=h.shift(),(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift());return n.search=e.search,n.query=e.query,L(n.pathname)&&L(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!h.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var p=h.slice(-1)[0],f=(n.host||e.host)&&("."===p||".."===p)||""===p,d=0,g=h.length;g>=0;g--)"."==(p=h[g])?h.splice(g,1):".."===p?(h.splice(g,1),d++):d&&(h.splice(g,1),d--);if(!u&&!c)for(;d--;d)h.unshift("..");!u||""===h[0]||h[0]&&"/"===h[0].charAt(0)||h.unshift(""),f&&"/"!==h.join("/").substr(-1)&&h.push("");var m,w=""===h[0]||h[0]&&"/"===h[0].charAt(0);l&&(n.hostname=n.host=w?"":h.length?h.shift():"",(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift()));return(u=u||n.host&&h.length)&&!w&&h.unshift(""),h.length?n.pathname=h.join("/"):(n.pathname=null,n.path=null),L(n.pathname)&&L(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},_.prototype.parseHost=function(){var e=this.host,t=q.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};var K=function(){var e=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&n.apisecret){e.headers["X-EPI2ME-APIKEY"]=n.apikey,e.headers["X-EPI2ME-SIGNATUREDATE"]=(new Date).toISOString();var r=[Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n"),e.body].join("\n"),o=h.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SIGNATUREV0"]=o}};return{version:"3.0.1733",setHeaders:function(n,r){var o=t.merge({log:{debug:function(){}}},r).log,s=r;if(s||(s={}),n.headers=t.merge({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-CLIENT":s.user_agent||"api","X-EPI2ME-VERSION":s.agent_version||K.version},n.headers,s.headers),"signing"in s&&!s.signing||e(n,s),s.proxy){var i=s.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=i[2],u=i[3],c={host:i[4],port:i[5]};a&&u&&(c.proxyAuth=a+":"+u),s.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),n.httpsAgent=l.httpsOverHttps({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),n.httpsAgent=l.httpsOverHttp({proxy:c})),n.proxy=!1}}}}(),X=u.buildAxiosFetch(c),V=function(e,t){var n=t.headers.keys,r=n.apikey,o=n.apisecret;return delete t.headers.keys,K.setHeaders(t,{apikey:r,apisecret:o,signing:!0}),X(e,t)},Q=new s({link:new i.ApolloLink((function(e){var t=e.getContext(),n=t.apikey,r=t.apisecret,o=t.url,s=a.createHttpLink({uri:O(o,"/graphql"),fetch:V,headers:{keys:{apikey:n,apisecret:r}}});return i.execute(s,e)})),cache:new o.InMemoryCache});c.defaults.validateStatus=function(e){return e<=504};var Z,Y,ee,te,ne,re,oe,se,ie,ae,ue,ce,he,le,pe,fe=function(){var e=this,n=function(e,t){e.headers||(e.headers={});var n=t;if(n||(n={}),n.apikey&&(e.headers["X-EPI2ME-ApiKey"]=n.apikey,n.apisecret)){e.headers["X-EPI2ME-SignatureDate"]=(new Date).toISOString(),e.url.match(/^https:/)&&(e.url=e.url.replace(/:443/,"")),e.url.match(/^http:/)&&(e.url=e.url.replace(/:80/,""));var r=[e.url,Object.keys(e.headers).sort().filter((function(e){return e.match(/^x-epi2me/i)})).map((function(t){return t+":"+e.headers[t]})).join("\n")].join("\n"),o=h.createHmac("sha1",n.apisecret).update(r).digest("hex");e.headers["X-EPI2ME-SignatureV0"]=o}},r=function(t){return g(e,void 0,void 0,(function(){var e,n;return m(this,(function(r){return(e=t?t.data:null)?t&&t.status>=400?(n="Network error "+t.status,e.error&&(n=e.error),504===t.status&&(n="Please check your network connection and try again."),[2,Promise.reject(new Error(n))]):e.error?[2,Promise.reject(new Error(e.error))]:[2,Promise.resolve(e)]:[2,Promise.reject(new Error("unexpected non-json response"))]}))}))};return{version:"3.0.1733",headers:function(e,r){var o=t.merge({log:{debug:function(){}}},r).log,s=r;if(s||(s={}),e.headers=t.merge({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-Client":s.user_agent||"api","X-EPI2ME-Version":s.agent_version||fe.version},e.headers,s.headers),"signing"in s&&!s.signing||n(e,s),s.proxy){var i=s.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=i[2],u=i[3],c={host:i[4],port:i[5]};a&&u&&(c.proxyAuth=a+":"+u),s.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),e.httpsAgent=l.httpsOverHttps({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),e.httpsAgent=l.httpsOverHttp({proxy:c})),e.proxy=!1}},head:function(n,r){return g(e,void 0,void 0,(function(){var e,o,s,i,a,u,h,l;return m(this,(function(p){switch(p.label){case 0:e=t.merge({log:{debug:function(){}}},r).log,s=r.url,i=n,r.skip_url_mangle?o=i:(i="/"+i,s=s.replace(/\/+$/,""),i=i.replace(/\/+/g,"/"),o=s+i),a={url:o,gzip:!0},fe.headers(a,r),p.label=1;case 1:return p.trys.push([1,3,,4]),e.debug("HEAD "+a.url),[4,c.head(a.url,a)];case 2:return(u=p.sent())&&u.status>=400?(h="Network error "+u.status,504===u.status&&(h="Please check your network connection and try again."),[2,Promise.reject(new Error(h))]):[3,4];case 3:return l=p.sent(),[2,Promise.reject(l)];case 4:return[2,Promise.resolve(u)]}}))}))},get:function(n,o){return g(e,void 0,void 0,(function(){var e,s,i,a,u,h,l;return m(this,(function(p){switch(p.label){case 0:e=t.merge({log:{debug:function(){}}},o).log,i=o.url,a=n,o.skip_url_mangle?s=a:(a="/"+a,i=i.replace(/\/+$/,""),a=a.replace(/\/+/g,"/"),s=i+a),u={url:s,gzip:!0},fe.headers(u,o),p.label=1;case 1:return p.trys.push([1,3,,4]),e.debug("GET "+u.url),[4,c.get(u.url,u)];case 2:return h=p.sent(),[3,4];case 3:return l=p.sent(),[2,Promise.reject(l)];case 4:return[2,r(h,o)]}}))}))},post:function(n,o,s){return g(e,void 0,void 0,(function(){var e,i,a,u,h,l,p,f,d;return m(this,(function(g){switch(g.label){case 0:e=t.merge({log:{debug:function(){}}},s).log,i=(i=s.url).replace(/\/+$/,""),a=n.replace(/\/+/g,"/"),u={url:i+"/"+a,gzip:!0,data:o,headers:{}},s.legacy_form&&(h=[],l=t.merge({json:JSON.stringify(o)},o),Object.keys(l).sort().forEach((function(e){h.push(e+"="+escape(l[e]))})),u.data=h.join("&"),u.headers["Content-Type"]="application/x-www-form-urlencoded"),fe.headers(u,s),p=u.data,delete u.data,g.label=1;case 1:return g.trys.push([1,3,,4]),e.debug("POST "+u.url),[4,c.post(u.url,p,u)];case 2:return f=g.sent(),[3,4];case 3:return d=g.sent(),[2,Promise.reject(d)];case 4:return s.handler?[2,s.handler(f)]:[2,r(f,s)]}}))}))},put:function(n,o,s,i){return g(e,void 0,void 0,(function(){var e,a,u,h,l,p,f,d,g;return m(this,(function(m){switch(m.label){case 0:e=t.merge({log:{debug:function(){}}},i).log,a=(a=i.url).replace(/\/+$/,""),u=n.replace(/\/+/g,"/"),h={url:a+"/"+u+"/"+o,gzip:!0,data:s,headers:{}},i.legacy_form&&(l=[],p=t.merge({json:JSON.stringify(s)},s),Object.keys(p).sort().forEach((function(e){l.push(e+"="+escape(p[e]))})),h.data=l.join("&"),h.headers["Content-Type"]="application/x-www-form-urlencoded"),fe.headers(h,i),f=h.data,delete h.data,m.label=1;case 1:return m.trys.push([1,3,,4]),e.debug("PUT "+h.url),[4,c.put(h.url,f,h)];case 2:return d=m.sent(),[3,4];case 3:return g=m.sent(),[2,Promise.reject(g)];case 4:return[2,r(d,i)]}}))}))},convertResponseToObject:function(e){if("object"===typeof e)return e;try{return JSON.parse(e)}catch(t){throw new Error("exception parsing chain JSON "+String(t))}}}}(),de=function(e){var n=this;this.createContext=function(e){var r=n.options,o=r.apikey,s=r.apisecret,i=r.url;return t.merge({apikey:o,apisecret:s,url:i},e)},this.query=function(e){return function(t){var o,s=void 0===t?{}:t,i=s.context,a=void 0===i?{}:i,u=s.variables,c=void 0===u?{}:u,h=s.options,l=void 0===h?{}:h,p=n.createContext(a);return o="string"===typeof e?r(Z||(Z=v(["\n        ","\n      "],["\n        ","\n      "])),e):"function"===typeof e?r(Y||(Y=v(["\n        ","\n      "],["\n        ","\n      "])),e(b)):e,n.client.query(d(d({query:o,variables:c},l),{context:p}))}},this.mutate=function(e){return function(t){var o,s=void 0===t?{}:t,i=s.context,a=void 0===i?{}:i,u=s.variables,c=void 0===u?{}:u,h=s.options,l=void 0===h?{}:h,p=n.createContext(a);return o="string"===typeof e?r(ee||(ee=v(["\n        ","\n      "],["\n        ","\n      "])),e):e,n.client.mutate(d(d({mutation:o,variables:c},l),{context:p}))}},this.resetCache=function(){n.client.resetStore()},this.workflows=this.query(r(te||(te=v(["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "],["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "])),b,"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowPages=function(e){return g(n,void 0,void 0,(function(){var t,n,r,o=this;return m(this,(function(s){switch(s.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return n=s.sent(),r=function(e){return g(o,void 0,void 0,(function(){return m(this,(function(r){switch(r.label){case 0:return t=e,[4,this.workflows({variables:{page:t}})];case 1:return[2,n=r.sent()]}}))}))},[2,{data:n,next:function(){return r(t+1)},previous:function(){return r(t-1)},first:function(){return r(1)},last:function(){return r(0)}}]}}))}))},this.workflow=this.query(r(ne||(ne=v(["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "],["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "])),"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowInstances=this.query(r(re||(re=v(["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "],["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "])),b,I)),this.workflowInstance=this.query(r(oe||(oe=v(["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "],["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "])),I)),this.startWorkflow=this.mutate(r(se||(se=v(["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "],["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "])))),this.stopWorkflow=this.mutate(r(ie||(ie=v(["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "],["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "])))),this.instanceToken=this.mutate(r(ae||(ae=v(["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "],["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "])))),this.user=this.query(r(ue||(ue=v(["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "],["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "])))),this.updateUser=this.mutate(r(ce||(ce=v(["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "],["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "])))),this.register=this.mutate(r(he||(he=v(["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "],["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "])))),this.status=this.query(r(le||(le=v(["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "],["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "])))),this.healthCheck=function(){return fe.get("/status",n.options)},this.regions=this.query(r(pe||(pe=v(["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "],["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "])))),this.options=t.assign({agent_version:fe.version,local:!1,url:y,user_agent:"EPI2ME API",signing:!0},e),this.options.url=this.options.url.replace(/:\/\//,"://graphql."),this.options.url=this.options.url.replace(/\/$/,""),this.log=this.options.log,this.client=Q},ge=function(e,t){var n=["","K","M","G","T","P","E","Z"],r=t||0,o=e||0;return o>=1e3?(o/=1e3,(r+=1)>=n.length?"???":ge(o,r)):0===r?""+o+n[r]:""+o.toFixed(1)+n[r]},me=function(){function e(e){this.allProfileData={},this.defaultEndpoint=process.env.METRICHOR||k.url,e&&(this.allProfileData=t.merge({profiles:{}},e)),this.allProfileData.endpoint&&(this.defaultEndpoint=this.allProfileData.endpoint)}return e.prototype.profile=function(e){return e?t.merge({endpoint:this.defaultEndpoint},t.merge({profiles:{}},this.allProfileData).profiles[e]):{}},e.prototype.profiles=function(){return Object.keys(this.allProfileData.profiles||{})},e}(),we=function(){function e(e){this.options=t.assign({agent_version:fe.version,local:!1,url:y,user_agent:"EPI2ME API",signing:!0},e),this.log=this.options.log,this.cachedResponses={}}return e.prototype.list=function(e){return g(this,void 0,void 0,(function(){var t;return m(this,(function(n){return t=e.match(/^[a-z_]+/i)[0],[2,fe.get(e,this.options).then((function(e){return e[t+"s"]}))]}))}))},e.prototype.read=function(e,t){return g(this,void 0,void 0,(function(){return m(this,(function(n){return[2,fe.get(e+"/"+t,this.options)]}))}))},e.prototype.user=function(){return g(this,void 0,void 0,(function(){return m(this,(function(e){return this.options.local?[2,{accounts:[{id_user_account:"none",number:"NONE",name:"None"}]}]:[2,fe.get("user",this.options)]}))}))},e.prototype.status=function(){return g(this,void 0,void 0,(function(){return m(this,(function(e){return[2,fe.get("status",this.options)]}))}))},e.prototype.jwt=function(){return g(this,void 0,void 0,(function(){var e;return m(this,(function(n){return e=function(e){return e.headers["x-epi2me-jwt"]?Promise.resolve(e.headers["x-epi2me-jwt"]):Promise.reject(new Error("failed to fetch JWT"))},[2,fe.post("authenticate",{},t.merge({handler:e},this.options))]}))}))},e.prototype.instanceToken=function(e,n){return g(this,void 0,void 0,(function(){return m(this,(function(r){return[2,fe.post("token",t.merge(n,{id_workflow_instance:e}),t.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.installToken=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(n){return[2,fe.post("token/install",{id_workflow:e},t.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.attributes=function(){return g(this,void 0,void 0,(function(){return m(this,(function(e){return[2,this.list("attribute")]}))}))},e.prototype.workflows=function(){return g(this,void 0,void 0,(function(){return m(this,(function(e){return[2,this.list("workflow")]}))}))},e.prototype.amiImages=function(){return g(this,void 0,void 0,(function(){return m(this,(function(e){if(this.options.local)throw new Error("amiImages unsupported in local mode");return[2,this.list("ami_image")]}))}))},e.prototype.amiImage=function(e,t){return g(this,void 0,void 0,(function(){var n,r,o;return m(this,(function(s){if(e&&t instanceof Object?(n=e,r=t,o="update"):e instanceof Object&&!t?(r=e,o="create"):(o="read",n=e),this.options.local)throw new Error("ami_image unsupported in local mode");if("update"===o)return[2,fe.put("ami_image",n,r,this.options)];if("create"===o)return[2,fe.post("ami_image",r,this.options)];if(!n)throw new Error("no id_ami_image specified");return[2,this.read("ami_image",n)]}))}))},e.prototype.workflow=function(e,n,r){return g(this,void 0,void 0,(function(){var o,s,i,a,u,c,h,l,p,f,d,g,v,y,k,b,I,$=this;return m(this,(function(m){switch(m.label){case 0:if(e&&n&&r instanceof Function?(o=e,s=n,i=r,a="update"):e&&n instanceof Object&&!(n instanceof Function)?(o=e,s=n,a="update"):e instanceof Object&&n instanceof Function?(s=e,i=n,a="create"):e instanceof Object&&!n?(s=e,a="create"):(a="read",o=e,i=n instanceof Function?n:null),"update"!==a)return[3,4];m.label=1;case 1:return m.trys.push([1,3,,4]),[4,fe.put("workflow",o,s,this.options)];case 2:return u=m.sent(),[2,i?i(null,u):Promise.resolve(u)];case 3:return c=m.sent(),[2,i?i(c):Promise.reject(c)];case 4:if("create"!==a)return[3,8];m.label=5;case 5:return m.trys.push([5,7,,8]),[4,fe.post("workflow",s,this.options)];case 6:return h=m.sent(),[2,i?i(null,h):Promise.resolve(h)];case 7:return l=m.sent(),[2,i?i(l):Promise.reject(l)];case 8:if(!o)return p=new Error("no workflow id specified"),[2,i?i(p):Promise.reject(p)];f={},m.label=9;case 9:return m.trys.push([9,11,,12]),[4,this.read("workflow",o)];case 10:if((d=m.sent()).error)throw new Error(d.error);return t.merge(f,d),[3,12];case 11:return g=m.sent(),this.log.error(o+": error fetching workflow "+String(g)),[2,i?i(g):Promise.reject(g)];case 12:t.merge(f,{params:{}}),m.label=13;case 13:return m.trys.push([13,15,,16]),[4,fe.get("workflow/config/"+o,this.options)];case 14:if((v=m.sent()).error)throw new Error(v.error);return t.merge(f,v),[3,16];case 15:return y=m.sent(),this.log.error(o+": error fetching workflow config "+String(y)),[2,i?i(y):Promise.reject(y)];case 16:k=t.filter(f.params,{widget:"ajax_dropdown"}),b=w(k.map((function(e,t){var n=k[t];return new Promise((function(e,t){var r=n.values.source.replace("{{EPI2ME_HOST}}","").replace(/&?apikey=\{\{EPI2ME_API_KEY\}\}/,"");fe.get(r,$.options).then((function(t){var r=t[n.values.data_root];return r&&(n.values=r.map((function(e){return{label:e[n.values.items.label_key],value:e[n.values.items.value_key]}}))),e()})).catch((function(e){return $.log.error("failed to fetch "+r),t(e)}))}))}))),m.label=17;case 17:return m.trys.push([17,19,,20]),[4,Promise.all(b)];case 18:return m.sent(),[2,i?i(null,f):Promise.resolve(f)];case 19:return I=m.sent(),this.log.error(o+": error fetching config and parameters "+String(I)),[2,i?i(I):Promise.reject(I)];case 20:return[2]}}))}))},e.prototype.startWorkflow=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(n){return[2,fe.post("workflow_instance",e,t.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.stopWorkflow=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(n){return[2,fe.put("workflow_instance/stop",e,null,t.assign({},this.options,{legacy_form:!0}))]}))}))},e.prototype.workflowInstances=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(t){return e&&e.run_id?[2,fe.get("workflow_instance/wi?show=all&columns[0][name]=run_id;columns[0][searchable]=true;columns[0][search][regex]=true;columns[0][search][value]="+e.run_id+";",this.options).then((function(e){return e.data.map((function(e){return{id_workflow_instance:e.id_ins,id_workflow:e.id_flo,run_id:e.run_id,description:e.desc,rev:e.rev}}))}))]:[2,this.list("workflow_instance")]}))}))},e.prototype.workflowInstance=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(t){return[2,this.read("workflow_instance",e)]}))}))},e.prototype.workflowConfig=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(t){return[2,fe.get("workflow/config/"+e,this.options)]}))}))},e.prototype.register=function(e,n){return g(this,void 0,void 0,(function(){return m(this,(function(r){return[2,fe.put("reg",e,{description:n||p.userInfo().username+"@"+p.hostname()},t.assign({},this.options,{signing:!1}))]}))}))},e.prototype.datasets=function(e){return g(this,void 0,void 0,(function(){var t;return m(this,(function(n){return(t=e)||(t={}),t.show||(t.show="mine"),[2,this.list("dataset?show="+t.show)]}))}))},e.prototype.dataset=function(e){return g(this,void 0,void 0,(function(){return m(this,(function(t){return this.options.local?[2,this.datasets().then((function(t){return t.find((function(t){return t.id_dataset===e}))}))]:[2,this.read("dataset",e)]}))}))},e.prototype.fetchContent=function(e){return g(this,void 0,void 0,(function(){var n,r,o,s,i;return m(this,(function(a){switch(a.label){case 0:n=t.assign({},this.options,{skip_url_mangle:!0,headers:{"Content-Type":""}}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,fe.head(e,n)];case 2:return o=a.sent(),(r=o.headers.etag)&&this.cachedResponses[e]&&this.cachedResponses[e].etag===r?[2,this.cachedResponses[e].response]:[3,4];case 3:return s=a.sent(),this.log.warn("Failed to HEAD request "+e+": "+String(s)),[3,4];case 4:return[4,fe.get(e,n)];case 5:return i=a.sent(),r&&(this.cachedResponses[e]={etag:r,response:i}),[2,i]}}))}))},e}(),ve=function(){function e(e,n){var r=this;this.debounces={},this.debounceWindow=t.merge({debounceWindow:2e3},n).debounceWindow,this.log=t.merge({log:{debug:function(){}}},n).log,e.jwt().then((function(e){r.socket=f(n.url,{transportOptions:{polling:{extraHeaders:{Cookie:"x-epi2me-jwt="+e}}}}),r.socket.on("connect",(function(){r.log.debug("socket ready")}))})).catch((function(e){r.log.error("socket connection failed - JWT authentication error")}))}return e.prototype.debounce=function(e,n){var r=this,o=t.merge(e)._uuid;if(o){if(this.debounces[o])return;this.debounces[o]=1,setTimeout((function(){delete r.debounces[o]}),this.debounceWindow)}n&&n(e)},e.prototype.watch=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing watch on "+e),void setTimeout((function(){n.watch(e,t)}),1e3);this.socket.on(e,(function(e){return n.debounce(e,t)}))},e.prototype.emit=function(e,t){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing emit on "+e),void setTimeout((function(){n.emit(e,t)}),1e3);this.log.debug("socket emit "+e+" "+JSON.stringify(t)),this.socket.emit(e,t)},e}(),ye=function(){function e(e){var r;if((r="string"===typeof e||"object"===typeof e&&e.constructor===String?JSON.parse(e):e||{}).endpoint&&(r.url=r.endpoint,delete r.endpoint),r.log){if(!t.every([r.log.info,r.log.warn,r.log.error,r.log.debug,r.log.json],t.isFunction))throw new Error("expected log object to have error, debug, info, warn and json methods");this.log=r.log}else this.log={info:function(e){console.info("["+(new Date).toISOString()+"] INFO: "+e)},debug:function(e){console.debug("["+(new Date).toISOString()+"] DEBUG: "+e)},warn:function(e){console.warn("["+(new Date).toISOString()+"] WARN: "+e)},error:function(e){console.error("["+(new Date).toISOString()+"] ERROR: "+e)},json:function(e){console.log(JSON.stringify(e))}};this.stopped=!0,this.uploadState$=new n.BehaviorSubject(!1),this.analyseState$=new n.BehaviorSubject(!1),this.reportState$=new n.BehaviorSubject(!1),this.instanceTelemetry$=new n.BehaviorSubject(null),this.experimentalWorkerStatus$=new n.BehaviorSubject(null),this.runningStates$=n.combineLatest(this.uploadState$,this.analyseState$,this.reportState$),this.states={upload:{filesCount:0,success:{files:0,bytes:0,reads:0},types:{},niceTypes:"",progress:{bytes:0,total:0}},download:{progress:{},success:{files:0,reads:0,bytes:0},fail:0,types:{},niceTypes:""},warnings:[]},this.liveStates$=new n.BehaviorSubject(this.states),this.config={options:t.defaults(r,k),instance:{id_workflow_instance:r.id_workflow_instance,inputQueueName:null,outputQueueName:null,outputQueueURL:null,discoverQueueCache:{},bucket:null,bucketFolder:null,remote_addr:null,chain:null,key_id:null}},this.config.instance.awssettings={region:this.config.options.region},this.REST=new we(t.merge({log:this.log},this.config.options)),this.graphQL=new de(t.merge({log:this.log},this.config.options)),this.timers={downloadCheckInterval:null,stateCheckInterval:null,fileCheckInterval:null,transferTimeouts:{},visibilityIntervals:{},summaryTelemetryInterval:null}}return e.prototype.socket=function(){return g(this,void 0,void 0,(function(){var e,n=this;return m(this,(function(r){return this.mySocket?[2,this.mySocket]:(this.mySocket=new ve(this.REST,t.merge({log:this.log},this.config.options)),(e=this.config.instance.id_workflow_instance)&&this.mySocket.watch("workflow_instance:state:"+e,(function(e){var t=n.config.instance;if(t){var r=t.summaryTelemetry,o=Object.entries(t.chain.components).sort((function(e,t){return e[0]-t[0]})).reduce((function(t,n){var o=n[0],s=n[1];if(!e[o])return t;var i=+o,a=i&&Object.keys(r[s.wid])[0]||"ROOT",u=e[o].split(",").map((function(e){return Math.max(0,+e)}));return w(t,[{running:u[0],complete:u[1],error:u[2],step:i,name:a}])}),[]);n.experimentalWorkerStatus$.next(o)}})),[2,this.mySocket])}))}))},e.prototype.realtimeFeedback=function(e,t){return g(this,void 0,void 0,(function(){return m(this,(function(n){switch(n.label){case 0:return[4,this.socket()];case 1:return n.sent().emit(e,t),[2]}}))}))},e.prototype.stopTimer=function(e){this.timers[e]&&(this.log.debug("clearing "+e+" interval"),clearInterval(this.timers[e]),this.timers[e]=null)},e.prototype.stopAnalysis=function(){return g(this,void 0,void 0,(function(){var e,t;return m(this,(function(n){switch(n.label){case 0:if(this.stopUpload(),this.stopped=!0,!(e=this.config.instance.id_workflow_instance))return[3,8];n.label=1;case 1:return n.trys.push([1,6,,7]),this.config.options.graphQL?[4,this.graphQL.stopWorkflow({variables:{idWorkflowInstance:e}})]:[3,3];case 2:return n.sent(),[3,5];case 3:return[4,this.REST.stopWorkflow(e)];case 4:n.sent(),n.label=5;case 5:return this.analyseState$.next(!1),[3,7];case 6:return t=n.sent(),this.log.error("Error stopping instance: "+String(t)),[2,Promise.reject(t)];case 7:this.log.info("workflow instance "+e+" stopped"),n.label=8;case 8:return[2,Promise.resolve()]}}))}))},e.prototype.stopUpload=function(){return g(this,void 0,void 0,(function(){var e=this;return m(this,(function(t){return this.log.debug("stopping watchers"),["stateCheckInterval","fileCheckInterval"].forEach((function(t){return e.stopTimer(t)})),this.uploadState$.next(!1),[2]}))}))},e.prototype.stopEverything=function(){return g(this,void 0,void 0,(function(){var e=this;return m(this,(function(t){switch(t.label){case 0:return this.stopAnalysis(),Object.keys(this.timers.transferTimeouts).forEach((function(t){e.log.debug("clearing transferTimeout for "+t),clearTimeout(e.timers.transferTimeouts[t]),delete e.timers.transferTimeouts[t]})),Object.keys(this.timers.visibilityIntervals).forEach((function(t){e.log.debug("clearing visibilityInterval for "+t),clearInterval(e.timers.visibilityIntervals[t]),delete e.timers.visibilityIntervals[t]})),this.downloadWorkerPool?(this.log.debug("clearing downloadWorkerPool"),[4,Promise.all(Object.values(this.downloadWorkerPool))]):[3,2];case 1:t.sent(),this.downloadWorkerPool=null,t.label=2;case 2:return["summaryTelemetryInterval","downloadCheckInterval"].forEach((function(t){return e.stopTimer(t)})),[2]}}))}))},e.prototype.reportProgress=function(){var e=this.states,t=e.upload,n=e.download;this.log.json({progress:{download:n,upload:t}})},e.prototype.storeState=function(e,t,n,r){var o=this,s=r||{};this.states[e]||(this.states[e]={}),this.states[e][t]||(this.states[e][t]={}),"incr"===n?Object.keys(s).forEach((function(n){o.states[e][t][n]=o.states[e][t][n]?o.states[e][t][n]+parseInt(s[n],10):parseInt(s[n],10)})):Object.keys(s).forEach((function(n){o.states[e][t][n]=o.states[e][t][n]?o.states[e][t][n]-parseInt(s[n],10):-parseInt(s[n],10)}));try{this.states[e].success.niceReads=ge(this.states[e].success.reads)}catch(a){this.states[e].success.niceReads=0}try{this.states[e].progress.niceSize=ge(this.states[e].success.bytes+this.states[e].progress.bytes||0)}catch(a){this.states[e].progress.niceSize=0}try{this.states[e].success.niceSize=ge(this.states[e].success.bytes)}catch(a){this.states[e].success.niceSize=0}this.states[e].niceTypes=Object.keys(this.states[e].types||{}).sort().map((function(t){return o.states[e].types[t]+" "+t})).join(", ");var i=Date.now();(!this.stateReportTime||i-this.stateReportTime>2e3)&&(this.stateReportTime=i,this.reportProgress()),this.liveStates$.next(d({},this.states))},e.prototype.uploadState=function(e,t,n){return this.storeState("upload",e,t,n)},e.prototype.downloadState=function(e,t,n){return this.storeState("download",e,t,n)},e.prototype.url=function(){return this.config.options.url},e.prototype.apikey=function(){return this.config.options.apikey},e.prototype.attr=function(e,t){if(!(e in this.config.options))throw new Error("config object does not contain property "+e);return t?(this.config.options[e]=t,this):this.config.options[e]},e.prototype.stats=function(e){return this.states[e]},e}();ye.version=fe.version,ye.Profile=me,ye.REST=we,ye.utils=fe,module.exports=ye;
