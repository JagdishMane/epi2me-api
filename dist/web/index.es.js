/**
 * Copyright Metrichor Ltd. (An Oxford Nanopore Technologies Company) 2020
 */

import{BehaviorSubject as t,combineLatest as e}from"rxjs";import s from"graphql-tag";import{ApolloClient as r,ApolloLink as o,createHttpLink as n,execute as i,InMemoryCache as a}from"@apollo/client/core";import c from"axios";import l from"crypto";import{httpsOverHttps as h,httpsOverHttp as u}from"tunnel";import p,{Headers as f}from"cross-fetch";import{merge as d,assign as g}from"lodash";import w from"os";import m from"socket.io-client";var y=!1,v="https://epi2me.nanoporetech.com",k="EPI2ME API",b="eu-west-1",$=5,I=1200,S=1200,_=5,j=3,O=60,E=600,T=20,x=30,C=3,A="data+telemetry",W=[".fastq",".fq",".fastq.gz",".fq.gz"],P=!0,R="/data";const q="\npage\npages\nhasNext\nhasPrevious\ntotalCount\n",D="\nidWorkflowInstance\nstartDate\nworkflowImage{\n  workflow\n  {\n    rev\n    name\n  }\n}\n";var U="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};function z(t,e,s){return t(s={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===e||null===e)&&s.path)}},s.exports),s.exports}var F=z((function(t,e){!function(s){var r=e&&!e.nodeType&&e,o=t&&!t.nodeType&&t,n="object"==typeof U&&U;n.global!==n&&n.window!==n&&n.self!==n||(s=n);var i,a,c=2147483647,l=/^xn--/,h=/[^\x20-\x7E]/,u=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,d=String.fromCharCode;function g(t){throw RangeError(p[t])}function w(t,e){for(var s=t.length,r=[];s--;)r[s]=e(t[s]);return r}function m(t,e){var s=t.split("@"),r="";return s.length>1&&(r=s[0]+"@",t=s[1]),r+w((t=t.replace(u,".")).split("."),e).join(".")}function y(t){for(var e,s,r=[],o=0,n=t.length;o<n;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<n?56320==(64512&(s=t.charCodeAt(o++)))?r.push(((1023&e)<<10)+(1023&s)+65536):(r.push(e),o--):r.push(e);return r}function v(t){return w(t,(function(t){var e="";return t>65535&&(e+=d((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+=d(t)})).join("")}function k(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function b(t,e,s){var r=0;for(t=s?f(t/700):t>>1,t+=f(t/e);t>455;r+=36)t=f(t/35);return f(r+36*t/(t+38))}function $(t){var e,s,r,o,n,i,a,l,h,u,p,d=[],w=t.length,m=0,y=128,k=72;for((s=t.lastIndexOf("-"))<0&&(s=0),r=0;r<s;++r)t.charCodeAt(r)>=128&&g("not-basic"),d.push(t.charCodeAt(r));for(o=s>0?s+1:0;o<w;){for(n=m,i=1,a=36;o>=w&&g("invalid-input"),((l=(p=t.charCodeAt(o++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:36)>=36||l>f((c-m)/i))&&g("overflow"),m+=l*i,!(l<(h=a<=k?1:a>=k+26?26:a-k));a+=36)i>f(c/(u=36-h))&&g("overflow"),i*=u;k=b(m-n,e=d.length+1,0==n),f(m/e)>c-y&&g("overflow"),y+=f(m/e),m%=e,d.splice(m++,0,y)}return v(d)}function I(t){var e,s,r,o,n,i,a,l,h,u,p,w,m,v,$,I=[];for(w=(t=y(t)).length,e=128,s=0,n=72,i=0;i<w;++i)(p=t[i])<128&&I.push(d(p));for(r=o=I.length,o&&I.push("-");r<w;){for(a=c,i=0;i<w;++i)(p=t[i])>=e&&p<a&&(a=p);for(a-e>f((c-s)/(m=r+1))&&g("overflow"),s+=(a-e)*m,e=a,i=0;i<w;++i)if((p=t[i])<e&&++s>c&&g("overflow"),p==e){for(l=s,h=36;!(l<(u=h<=n?1:h>=n+26?26:h-n));h+=36)$=l-u,v=36-u,I.push(d(k(u+$%v,0))),l=f($/v);I.push(d(k(l,0))),n=b(s,m,r==o),s=0,++r}++s,++e}return I.join("")}if(i={version:"1.3.2",ucs2:{decode:y,encode:v},decode:$,encode:I,toASCII:function(t){return m(t,(function(t){return h.test(t)?"xn--"+I(t):t}))},toUnicode:function(t){return m(t,(function(t){return l.test(t)?$(t.slice(4).toLowerCase()):t}))}},r&&o)if(t.exports==r)o.exports=i;else for(a in i)i.hasOwnProperty(a)&&(r[a]=i[a]);else s.punycode=i}(U)}));function H(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var N=function(t,e,s,r){e=e||"&",s=s||"=";var o={};if("string"!==typeof t||0===t.length)return o;var n=/\+/g;t=t.split(e);var i=1e3;r&&"number"===typeof r.maxKeys&&(i=r.maxKeys);var a=t.length;i>0&&a>i&&(a=i);for(var c=0;c<a;++c){var l,h,u,p,f=t[c].replace(n,"%20"),d=f.indexOf(s);d>=0?(l=f.substr(0,d),h=f.substr(d+1)):(l=f,h=""),u=decodeURIComponent(l),p=decodeURIComponent(h),H(o,u)?Array.isArray(o[u])?o[u].push(p):o[u]=[o[u],p]:o[u]=p}return o},M=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}},L=function(t,e,s,r){return e=e||"&",s=s||"=",null===t&&(t=void 0),"object"===typeof t?Object.keys(t).map((function(r){var o=encodeURIComponent(M(r))+s;return Array.isArray(t[r])?t[r].map((function(t){return o+encodeURIComponent(M(t))})).join(e):o+encodeURIComponent(M(t[r]))})).join(e):r?encodeURIComponent(M(r))+s+encodeURIComponent(M(t)):""},G=z((function(t,e){e.decode=e.parse=N,e.encode=e.stringify=L})),B=function(t,e){return nt(t,!1,!0).resolve(e)};function J(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var X=/^([a-z0-9.+-]+:)/i,K=/:[0-9]*$/,Q=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),V=["'"].concat(Q),Z=["%","/","?",";","#"].concat(V),Y=["/","?","#"],tt=/^[a-z0-9A-Z_-]{0,63}$/,et=/^([a-z0-9A-Z_-]{0,63})(.*)$/,st={javascript:!0,"javascript:":!0},rt={javascript:!0,"javascript:":!0},ot={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function nt(t,e,s){if(t&&at(t)&&t instanceof J)return t;var r=new J;return r.parse(t,e,s),r}function it(t){return"string"===typeof t}function at(t){return"object"===typeof t&&null!==t}function ct(t){return null===t}function lt(t){const e=new o(e=>{const s=e.getContext(),r=t(s),o=n({uri:B(s.url,"/graphql"),fetch:r});return i(o,e)}),s=new a;return new r({link:e,cache:s})}J.prototype.parse=function(t,e,s){if(!it(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var r=t;r=r.trim();var o=X.exec(r);if(o){var n=(o=o[0]).toLowerCase();this.protocol=n,r=r.substr(o.length)}if(s||o||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var i="//"===r.substr(0,2);!i||o&&rt[o]||(r=r.substr(2),this.slashes=!0)}if(!rt[o]&&(i||o&&!ot[o])){for(var a,c,l=-1,h=0;h<Y.length;h++){-1!==(u=r.indexOf(Y[h]))&&(-1===l||u<l)&&(l=u)}-1!==(c=-1===l?r.lastIndexOf("@"):r.lastIndexOf("@",l))&&(a=r.slice(0,c),r=r.slice(c+1),this.auth=decodeURIComponent(a)),l=-1;for(h=0;h<Z.length;h++){var u;-1!==(u=r.indexOf(Z[h]))&&(-1===l||u<l)&&(l=u)}-1===l&&(l=r.length),this.host=r.slice(0,l),r=r.slice(l),this.parseHost(),this.hostname=this.hostname||"";var p="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!p)for(var f=this.hostname.split(/\./),d=(h=0,f.length);h<d;h++){var g=f[h];if(g&&!g.match(tt)){for(var w="",m=0,y=g.length;m<y;m++)g.charCodeAt(m)>127?w+="x":w+=g[m];if(!w.match(tt)){var v=f.slice(0,h),k=f.slice(h+1),b=g.match(et);b&&(v.push(b[1]),k.unshift(b[2])),k.length&&(r="/"+k.join(".")+r),this.hostname=v.join(".");break}}}if(this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),!p){var $=this.hostname.split("."),I=[];for(h=0;h<$.length;++h){var S=$[h];I.push(S.match(/[^A-Za-z0-9_-]/)?"xn--"+F.encode(S):S)}this.hostname=I.join(".")}var _=this.port?":"+this.port:"",j=this.hostname||"";this.host=j+_,this.href+=this.host,p&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==r[0]&&(r="/"+r))}if(!st[n])for(h=0,d=V.length;h<d;h++){var O=V[h],E=encodeURIComponent(O);E===O&&(E=escape(O)),r=r.split(O).join(E)}var T=r.indexOf("#");-1!==T&&(this.hash=r.substr(T),r=r.slice(0,T));var x=r.indexOf("?");if(-1!==x?(this.search=r.substr(x),this.query=r.substr(x+1),e&&(this.query=G.parse(this.query)),r=r.slice(0,x)):e&&(this.search="",this.query={}),r&&(this.pathname=r),ot[n]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){_=this.pathname||"",S=this.search||"";this.path=_+S}return this.href=this.format(),this},J.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",s=this.pathname||"",r=this.hash||"",o=!1,n="";this.host?o=t+this.host:this.hostname&&(o=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&at(this.query)&&Object.keys(this.query).length&&(n=G.stringify(this.query));var i=this.search||n&&"?"+n||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||ot[e])&&!1!==o?(o="//"+(o||""),s&&"/"!==s.charAt(0)&&(s="/"+s)):o||(o=""),r&&"#"!==r.charAt(0)&&(r="#"+r),i&&"?"!==i.charAt(0)&&(i="?"+i),e+o+(s=s.replace(/[?#]/g,(function(t){return encodeURIComponent(t)})))+(i=i.replace("#","%23"))+r},J.prototype.resolve=function(t){return this.resolveObject(nt(t,!1,!0)).format()},J.prototype.resolveObject=function(t){if(it(t)){var e=new J;e.parse(t,!1,!0),t=e}var s=new J;if(Object.keys(this).forEach((function(t){s[t]=this[t]}),this),s.hash=t.hash,""===t.href)return s.href=s.format(),s;if(t.slashes&&!t.protocol)return Object.keys(t).forEach((function(e){"protocol"!==e&&(s[e]=t[e])})),ot[s.protocol]&&s.hostname&&!s.pathname&&(s.path=s.pathname="/"),s.href=s.format(),s;if(t.protocol&&t.protocol!==s.protocol){if(!ot[t.protocol])return Object.keys(t).forEach((function(e){s[e]=t[e]})),s.href=s.format(),s;if(s.protocol=t.protocol,t.host||rt[t.protocol])s.pathname=t.pathname;else{for(var r=(t.pathname||"").split("/");r.length&&!(t.host=r.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==r[0]&&r.unshift(""),r.length<2&&r.unshift(""),s.pathname=r.join("/")}if(s.search=t.search,s.query=t.query,s.host=t.host||"",s.auth=t.auth,s.hostname=t.hostname||t.host,s.port=t.port,s.pathname||s.search){var o=s.pathname||"",n=s.search||"";s.path=o+n}return s.slashes=s.slashes||t.slashes,s.href=s.format(),s}var i=s.pathname&&"/"===s.pathname.charAt(0),a=t.host||t.pathname&&"/"===t.pathname.charAt(0),c=a||i||s.host&&t.pathname,l=c,h=s.pathname&&s.pathname.split("/")||[],u=(r=t.pathname&&t.pathname.split("/")||[],s.protocol&&!ot[s.protocol]);if(u&&(s.hostname="",s.port=null,s.host&&(""===h[0]?h[0]=s.host:h.unshift(s.host)),s.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===r[0]?r[0]=t.host:r.unshift(t.host)),t.host=null),c=c&&(""===r[0]||""===h[0])),a)s.host=t.host||""===t.host?t.host:s.host,s.hostname=t.hostname||""===t.hostname?t.hostname:s.hostname,s.search=t.search,s.query=t.query,h=r;else if(r.length)h||(h=[]),h.pop(),h=h.concat(r),s.search=t.search,s.query=t.query;else if(null!=t.search){if(u)s.hostname=s.host=h.shift(),(w=!!(s.host&&s.host.indexOf("@")>0)&&s.host.split("@"))&&(s.auth=w.shift(),s.host=s.hostname=w.shift());return s.search=t.search,s.query=t.query,ct(s.pathname)&&ct(s.search)||(s.path=(s.pathname?s.pathname:"")+(s.search?s.search:"")),s.href=s.format(),s}if(!h.length)return s.pathname=null,s.search?s.path="/"+s.search:s.path=null,s.href=s.format(),s;for(var p=h.slice(-1)[0],f=(s.host||t.host)&&("."===p||".."===p)||""===p,d=0,g=h.length;g>=0;g--)"."==(p=h[g])?h.splice(g,1):".."===p?(h.splice(g,1),d++):d&&(h.splice(g,1),d--);if(!c&&!l)for(;d--;d)h.unshift("..");!c||""===h[0]||h[0]&&"/"===h[0].charAt(0)||h.unshift(""),f&&"/"!==h.join("/").substr(-1)&&h.push("");var w,m=""===h[0]||h[0]&&"/"===h[0].charAt(0);u&&(s.hostname=s.host=m?"":h.length?h.shift():"",(w=!!(s.host&&s.host.indexOf("@")>0)&&s.host.split("@"))&&(s.auth=w.shift(),s.host=s.hostname=w.shift()));return(c=c||s.host&&h.length)&&!m&&h.unshift(""),h.length?s.pathname=h.join("/"):(s.pathname=null,s.path=null),ct(s.pathname)&&ct(s.search)||(s.path=(s.pathname?s.pathname:"")+(s.search?s.search:"")),s.auth=t.auth||s.auth,s.slashes=s.slashes||t.slashes,s.href=s.format(),s},J.prototype.parseHost=function(){var t=this.host,e=K.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)};const ht=(...t)=>{},ut={debug:ht,error:ht,info:ht,warn:ht},pt={info(...t){console.info(`[${(new Date).toISOString()}] INFO:`,...t)},debug(...t){console.debug(`[${(new Date).toISOString()}] DEBUG:`,...t)},warn(...t){console.warn(`[${(new Date).toISOString()}] WARN:`,...t)},error(...t){console.error(`[${(new Date).toISOString()}] ERROR:`,...t)}};function ft(t){return"object"===typeof t&&!1===Array.isArray(t)}function dt(t){return"function"===typeof t}function gt(t){return Array.isArray(t)}function wt(t){return"undefined"===typeof t}function mt(t){return null===t||"undefined"===typeof t}function yt(t,e){if(function(t){return"string"===typeof t}(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to String`)}function vt(t,e){if(function(t){return"number"===typeof t}(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Number`)}function kt(t,e){if(function(t){return"number"===typeof t||"string"===typeof t}(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Index`)}function bt(t,e){if(ft(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Indexable`)}function $t(t,e){if(function(t){return"boolean"===typeof t}(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Boolean`)}function It(t,e){if(gt(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Array`)}function St(t,e){if(ft(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Record`)}function _t(t,e){if(dt(t))return t;if(mt(t)&&"undefined"!==typeof e)return e;throw new Error(`Unable to cast ${typeof t} to Function`)}function jt(t,e,s){if(mt(t)&&"undefined"!==typeof s)return s;if(gt(t))return t.map(e);throw new Error(`Unable to cast ${typeof t} to Array`)}function Ot(t){if(!mt(t))return yt(t)}function Et(t){if(!mt(t))return vt(t)}function Tt(t){if(!mt(t))return kt(t)}function xt(t){if(!mt(t))return $t(t)}function Ct(t){if(!mt(t))return _t(t)}c.defaults.validateStatus=t=>t<=504;const At=function(){const t={sign:(t,e)=>{var s,r;if(!e)return;if(t.headers||(t.headers={}),!e.apikey)return;if(t.headers["X-EPI2ME-ApiKey"]=e.apikey,!e.apisecret)return;t.headers["X-EPI2ME-SignatureDate"]=(new Date).toISOString(),(null===(s=t.url)||void 0===s?void 0:s.match(/^https:/))&&(t.url=t.url.replace(/:443/,"")),(null===(r=t.url)||void 0===r?void 0:r.match(/^http:/))&&(t.url=t.url.replace(/:80/,""));const o=[t.url,Object.keys(t.headers).sort().filter(t=>t.match(/^x-epi2me/i)).map(e=>`${e}:${t.headers[e]}`).join("\n")].join("\n"),n=l.createHmac("sha1",e.apisecret).update(o).digest("hex");t.headers["X-EPI2ME-SignatureV0"]=n},responseHandler(t){const e=t&&ft(t.data)?t.data:null;if(t&&t.status>=400){let s="Network error "+t.status;throw(null===e||void 0===e?void 0:e.error)&&(s=e.error+""),504===t.status&&(s="Please check your network connection and try again."),new Error(s)}if(!e)throw new Error("unexpected non-json response");if(e.error)throw new Error(e.error+"");return e}};return{version:"3.0.1839",headers(e,s){var r,o;if(e.headers=Object.assign(Object.assign({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-Client":s.user_agent||"api","X-EPI2ME-Version":s.agent_version||At.version},e.headers),s.headers),(null===(r=s.signing)||void 0===r||r)&&t.sign(e,s),s.proxy){const t=s.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/);if(!t)throw new Error("Failed to parse Proxy URL");const r=t[2],n=t[3],i={host:t[4],port:parseInt(t[5],10)};r&&n&&(i.proxyAuth=`${r}:${n}`);const a=null!==(o=s.log)&&void 0!==o?o:ut;s.proxy.match(/^https/)?(a.debug("using HTTPS over HTTPS proxy",JSON.stringify(i)),e.httpsAgent=h({proxy:i})):(a.debug("using HTTPS over HTTP proxy",JSON.stringify(i)),e.httpsAgent=u({proxy:i})),e.proxy=!1}},async head(t,e){var s;const r={url:this.mangleURL(t,e)};if(this.headers(r,e),!r.url)throw new Error("unreachable: url argument in HEAD was deleted");(null!==(s=e.log)&&void 0!==s?s:ut).debug("HEAD",r.url);const o=await c.head(r.url,r);if(o&&o.status>=400){if(504===o.status)throw new Error("Please check your network connection and try again.");throw new Error("Network error "+o.status)}return o},async get(e,s){var r;const o={url:this.mangleURL(e,s)};if(this.headers(o,s),!o.url)throw new Error("unreachable: url argument in GET was deleted");(null!==(r=s.log)&&void 0!==r?r:ut).debug("GET",o.url);const n=await c.get(o.url,o);return t.responseHandler(n)},async post(e,s,r){var o;let n=r.url;n=n.replace(/\/+$/,"");const i={url:`${n}/${e.replace(/\/+/g,"/")}`,data:s,headers:{}};r.legacy_form&&this.processLegacyForm(i,s),this.headers(i,r);const{data:a}=i;delete i.data;const l=null!==(o=r.log)&&void 0!==o?o:ut;if(!i.url)throw new Error("unreachable: url argument in POST was deleted");l.debug("POST",i.url);const h=await c.post(i.url,a,i);return r.handler?r.handler(h):t.responseHandler(h)},async put(e,s,r,o){var n;let i=o.url;i=i.replace(/\/+$/,"");const a={url:`${i}/${e.replace(/\/+/g,"/")}/${s}`,data:r,headers:{}};o.legacy_form&&this.processLegacyForm(a,r),this.headers(a,o);const{data:l}=a;delete a.data;const h=null!==(n=o.log)&&void 0!==n?n:ut;if(!a.url)throw new Error("unreachable: url argument in PUT was deleted");h.debug("PUT",a.url);const u=await c.put(a.url,l,a);return t.responseHandler(u)},mangleURL(t,e){let s=e.url;return e.skip_url_mangle?t:(t="/"+t,s=s.replace(/\/+$/,""),s+(t=t.replace(/\/+/g,"/")))},processLegacyForm(t,e){const s=[],r=Object.assign({json:JSON.stringify(e)},e);Object.keys(r).sort().forEach(t=>{s.push(`${t}=${escape(r[t]+"")}`)}),t.data=s.join("&"),t.headers["Content-Type"]="application/x-www-form-urlencoded"},convertResponseToObject(t){if("object"===typeof t)return t;try{return JSON.parse(t)}catch(e){throw new Error("exception parsing chain JSON "+String(e))}}}}();function Wt(t={}){var e,s;const r=new f;if(r.set("Accept","application/json"),r.set("Content-Type","application/json"),r.set("X-EPI2ME-Client",null!==(e=t.user_agent)&&void 0!==e?e:"api"),r.set("X-EPI2ME-Version",null!==(s=t.agent_version)&&void 0!==s?s:"3.0.1839"),t.headers)for(const[o,n]of Object.entries(t.headers))r.set(o,n);return r}class Pt{constructor(t){this.initClient=()=>lt(()=>(t,e={})=>{const s=Wt({headers:new f(e.headers)});return s.set("Authorization","Bearer "+this.options.jwt),e.headers=s,p(t,e)}),this.createContext=t=>{const{apikey:e,apisecret:s,url:r}=this.options;return Object.assign({apikey:e,apisecret:s,url:r},t)},this.resetCache=()=>{this.client.resetStore()},this.workflows=this.query(s`
    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {
      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {
        ${q}
        results {
          ${"\nidWorkflow\nname\ndescription\nsummary\nrev\n"}
        }
      }
    }
  `),this.workflowPages=async t=>{let e=t,s=await this.workflows({variables:{page:e}});const r=async t=>(e=t,s=await this.workflows({variables:{page:e}}),s);return{data:s,next:()=>r(e+1),previous:()=>r(e-1),first:()=>r(1),last:()=>r(0)}},this.workflow=this.query(s`
    query workflow($idWorkflow: ID!) {
      workflow(idWorkflow: $idWorkflow) {
        ${"\nidWorkflow\nname\ndescription\nsummary\nrev\n"}
      }
    }
   `),this.workflowInstances=this.query(s`
  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {
    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {
      ${q}
      results {
        ${D}
      }
    }
  }
   `),this.workflowInstance=this.query(s`
      query workflowInstance($idWorkflowInstance: ID!) {
        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {
          ${D}
        }
      }
   `),this.startWorkflow=this.mutate(s`
    mutation startWorkflow(
      $idWorkflow: ID!
      $computeAccountId: ID!
      $storageAccountId: ID
      $isConsentedHuman: Boolean = false
      $idDataset: ID
      $storeResults: Boolean = false
      $userDefined: GenericScalar
      $instanceAttributes: [GenericScalar]
      $region: String
    ) {
      startData: startWorkflowInstance(
        idWorkflow: $idWorkflow
        computeAccountId: $computeAccountId
        storageAccountId: $storageAccountId
        isConsentedHuman: $isConsentedHuman
        idDataset: $idDataset
        storeResults: $storeResults
        userDefined: $userDefined
        instanceAttributes: $instanceAttributes
        region: $region
      ) {
        bucket
        idUser
        remoteAddr
        instance {
          idWorkflowInstance
          chain
          keyId
          outputqueue
          mappedTelemetry
          workflowImage {
            inputqueue
            workflow {
              idWorkflow
            }
            region {
              name
            }
          }
        }
      }
    }
  `),this.stopWorkflow=this.mutate(s`
    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {
      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {
        success
        message
      }
    }
  `),this.instanceToken=this.mutate(s`
    mutation getInstanceToken($idWorkflowInstance: ID!) {
      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {
        id_workflow_instance: idWorkflowInstance
        accessKeyId
        secretAccessKey
        sessionToken
        expiration
        region
      }
    }
  `),this.user=this.query(s`
    query user {
      me {
        username
        realname
        useraccountSet {
          idUserAccount
        }
      }
    }
  `),this.updateUser=this.mutate(s`
    mutation updateUser($idRegionPreferred: ID!) {
      updateUser(idRegionPreferred: $idRegionPreferred) {
        idRegionPreferred
      }
    }
  `),this.register=this.mutate(s`
    mutation registerToken($code: String!, $description: String) {
      registerToken(code: $code, description: $description) {
        apikey
        apisecret
        description
      }
    }
  `),this.status=this.query(s`
    query status {
      status {
        portalVersion
        remoteAddr
        serverTime
        minimumAgent
        dbVersion
      }
    }
  `),this.regions=this.query(s`
    query regions {
      regions {
        idRegion
        description
        name
      }
    }
  `);let e=t.url;e=e.replace(/:\/\//,"://graphql."),e=e.replace(/\/$/,"");const{apikey:r,apisecret:o,jwt:n,log:i,local:a,signing:c}=t;this.options={url:e,agent_version:t.agent_version,local:a,user_agent:t.user_agent,signing:c,apikey:r,apisecret:o,jwt:n},this.log=i,this.client=this.initClient()}query(t){return e=>{var r,o,n;const i=null!==(r=null===e||void 0===e?void 0:e.context)&&void 0!==r?r:{},a=null!==(o=null===e||void 0===e?void 0:e.variables)&&void 0!==o?o:{},c=null!==(n=null===e||void 0===e?void 0:e.options)&&void 0!==n?n:{},l=this.createContext(i);let h;return h="string"===typeof t?s`
          ${t}
        `:"function"===typeof t?s`
          ${t(q)}
        `:t,this.client.query(Object.assign(Object.assign({query:h,variables:a},c),{context:l}))}}mutate(t){return e=>{var r,o,n;const i=null!==(r=null===e||void 0===e?void 0:e.context)&&void 0!==r?r:{},a=null!==(o=null===e||void 0===e?void 0:e.variables)&&void 0!==o?o:{},c=null!==(n=null===e||void 0===e?void 0:e.options)&&void 0!==n?n:{},l=this.createContext(i);let h;return h="string"===typeof t?s`
          ${t}
        `:t,this.client.mutate(Object.assign(Object.assign({mutation:h,variables:a},c),{context:l}))}}async convertONTJWT(t={token_type:"jwt"},e){if("jwt"!==t.token_type&&!t.description)throw new Error("Description required for signature requests");return At.post("convert-ont",t,Object.assign(Object.assign({},this.options),{log:{debug:ht},headers:{"X-ONT-JWT":e}}))}async healthCheck(){return{status:$t((await At.get("/status",Object.assign(Object.assign({},this.options),{log:{debug:ht}}))).status)}}}Pt.NETWORK_ONLY="network-only",Pt.CACHE_FIRST="cache-first",Pt.CACHE_AND_NETWORK="cache-and-network",Pt.CACHE_ONLY="cache-only",Pt.NO_CACHE="no-cache";class Rt extends Pt{constructor(t){super(t),this.initClient=()=>lt(()=>(t,e={})=>{const s=Object.assign(Object.assign({},e),{headers:Wt({headers:new f(e.headers)}),agent:null}),{apikey:r,apisecret:o}=this.options;if(r&&o){const t=t=>[...t,e.body+""];!function(t,e,{apikey:s,apisecret:r},o=!1){t.set("X-EPI2ME-ApiKey",s),t.set("X-EPI2ME-SignatureDate",(new Date).toISOString());const n=e(Array.from(t.keys()).sort().filter(t=>t.match(/^x-epi2me/i)).map(e=>`${o?e.toUpperCase():e}:${t.get(e)}`)).join("\n"),i=l.createHmac("sha1",r).update(n).digest("hex");t.set("X-EPI2ME-SignatureV0",i)}(s.headers,t,{apikey:r,apisecret:o},!0)}return p(t,s)}),this.client=this.initClient()}}const qt=(t,e)=>{const s=["","K","M","G","T","P","E","Z"];let r=e||0,o=t||0;return o>=1e3?(o/=1e3,r+=1,r>=s.length?"???":qt(o,r)):0===r?`${o}${s[r]}`:`${o.toFixed(1)}${s[r]}`};class Dt{constructor(t){this.cachedResponses=new Map,this.options=t,this.log=this.options.log}async list(t){const e=t.match(/^[a-z_]+/i);if(!e)throw new Error("Failed to parse entity identifier");return It((await At.get(t,this.options))[e[0]+"s"])}read(t,e){return At.get(`${t}/${e}`,this.options)}async user(){return this.options.local?{accounts:[{id_user_account:"none",number:"NONE",name:"None"}]}:At.get("user",this.options)}async status(){const t=await At.get("status",this.options);return{agent_url:yt(t.agent_url),agent_version:yt(t.agent_version),db_version:yt(t.db_version),minimum_agent:yt(t.minimum_agent),portal_version:yt(t.portal_version),remote_addr:yt(t.remote_addr),server_time:yt(t.server_time)}}async jwt(){return yt(await At.post("authenticate",{},Object.assign(Object.assign({},this.options),{handler:async t=>{if(t.headers["x-epi2me-jwt"])return t.headers["x-epi2me-jwt"];throw new Error("failed to fetch JWT")}})))}async instanceToken(t,e){return At.post("token",d(e,{id_workflow_instance:t}),g({},this.options,{legacy_form:!0}))}async installToken(t){return At.post("token/install",{id_workflow:t},g({},this.options,{legacy_form:!0}))}attributes(){return this.list("attribute")}async workflows(t){const e=this.list("workflow");if(t)try{t(null,await e)}catch(s){t(s,null)}return e}amiImages(){if(this.options.local)throw new Error("amiImages unsupported in local mode");return this.list("ami_image")}amiImage(t,e){if(this.options.local)throw new Error("ami_image unsupported in local mode");return e instanceof Object?this.updateAmiImage(yt(t),St(e)):t instanceof Object?At.post("ami_image",St(t),this.options):this.read("ami_image",yt(t))}updateAmiImage(t,e){return At.put("ami_image",t,e,this.options)}createAmiImage(t){return At.post("ami_image",t,this.options)}readAmiImage(t){return this.read("ami_image",t)}async workflow(t,e,s){if(t&&e&&s instanceof Function)return this.updateWorkflow(yt(t),St(e),s);if(t&&e instanceof Object&&!(e instanceof Function))return this.updateWorkflow(yt(t),St(e));if(t instanceof Object&&e instanceof Function)return this.createWorkflow(St(t),e);if(t instanceof Object&&!e)return this.createWorkflow(St(t));const r=Ot(t),o=Ct(e);if(!r){const t=new Error("no workflow id specified");return o?o(t):Promise.reject(t)}const n={};try{const t=await this.read("workflow",r);if(t.error)throw new Error(t.error+"");d(n,t)}catch(c){if(this.log.error(`${r}: error fetching workflow ${String(c)}`),o)return void o(c);throw c}d(n,{params:{}});try{const t=await At.get("workflow/config/"+r,this.options);if(t.error)throw new Error(t.error+"");d(n,t)}catch(c){if(this.log.error(`${r}: error fetching workflow config ${String(c)}`),o)return void o(c);throw c}const i=gt(n.params)?It(n.params):St(n.params),a=[...Object.values(i).map(t=>St(t)).filter(t=>"ajax_dropdown"===t.widget).map(async t=>{if(wt(t))throw new Error("parameter is undefined");const e=St(t.values),s=St(e.items),r=yt(e.source).replace("{{EPI2ME_HOST}}","").replace(/&?apikey=\{\{EPI2ME_API_KEY\}\}/,"");let n;try{n=await At.get(r,this.options)}catch(c){if(this.log.error("failed to fetch "+r),o)return void o(c);throw c}const i=Tt(e.data_root),a=function(t,e){if(!mt(t))return jt(t,e)}(wt(i)?i:n[i],bt);a&&(t.values=a.map(t=>({label:t[kt(s.label_key)],value:t[kt(s.value_key)]})))})];try{await Promise.all(a),o&&o(null,n)}catch(c){if(this.log.error(`${r}: error fetching config and parameters ${String(c)}`),!o)throw c;o(c)}return n}async updateWorkflow(t,e,s){const r=At.put("workflow",t,e,this.options);if(s)try{s(null,await r)}catch(o){s(o)}return r}async createWorkflow(t,e){const s=At.post("workflow",t,this.options);if(e)try{e(null,await s)}catch(r){e(r)}return s}async startWorkflow(t){return At.post("workflow_instance",t,Object.assign(Object.assign({},this.options),{legacy_form:!0}))}async stopWorkflow(t){return At.put("workflow_instance/stop",t.toString(),{},Object.assign(Object.assign({},this.options),{legacy_form:!0}))}async workflowInstances(t){if(!t||!t.run_id)return this.list("workflow_instance");return jt((await At.get(`workflow_instance/wi?show=all&columns[0][name]=run_id;columns[0][searchable]=true;columns[0][search][regex]=true;columns[0][search][value]=${t.run_id};`,this.options)).data,St).map(t=>({id_workflow_instance:t.id_ins,id_workflow:t.id_flo,run_id:t.run_id,description:t.desc,rev:t.rev}))}async workflowInstance(t){return this.read("workflow_instance",t+"")}async workflowConfig(t){return At.get("workflow/config/"+t,this.options)}async register(t,e){return At.put("reg",t,{description:e||`${w.userInfo().username}@${w.hostname()}`},g({},this.options,{signing:!1}))}async datasets(t={}){if(dt(t))throw new Error("Unexpected callback instead of query");t.show||(t.show="mine");return jt(await this.list("dataset?show="+t.show),St)}async dataset(t){if(!this.options.local)return this.read("dataset",t);return jt(await this.datasets(),St).find(e=>e.id_dataset===t)}async fetchContent(t){const e=Object.assign(Object.assign({},this.options),{skip_url_mangle:!0,headers:{"Content-Type":""}});let s;try{s=(await At.head(t,e)).headers.etag;const r=this.cachedResponses.get(t);if(s&&r&&r.etag===s)return r.response}catch(o){this.log.warn(`Failed to HEAD request ${t}: ${String(o)}`)}const r=await At.get(t,e);return s&&this.cachedResponses.set(t,{etag:s,response:r}),r}}class Ut{constructor(t,e){var s;this.debounces=new Set,this.debounceWindow=null!==(s=e.debounceWindow)&&void 0!==s?s:2e3,this.log=e.log,this.initialise(t,e.url)}async initialise(t,e){try{const s=await t.jwt();this.socket=m(e,{transportOptions:{polling:{extraHeaders:{Cookie:"x-epi2me-jwt="+s}}}}),this.socket.on("connect",()=>{this.log.debug("socket ready")})}catch(s){this.log.error("socket connection failed - JWT authentication error")}}debounce(t,e){const s=d(t)._uuid;if(s){if(this.debounces.has(s))return;this.debounces.add(s),setTimeout(()=>{this.debounces.delete(s)},this.debounceWindow)}e&&e(t)}watch(t,e){if(!this.socket)return this.log.debug("socket not ready. requeueing watch on "+t),void setTimeout(()=>{this.watch(t,e)},1e3);this.socket.on(t,t=>this.debounce(t,e))}emit(t,e){if(!this.socket)return this.log.debug("socket not ready. requeueing emit on "+t),void setTimeout(()=>{this.emit(t,e)},1e3);this.log.debug(`socket emit ${t} ${JSON.stringify(e)}`),this.socket.emit(t,e)}}class zt{constructor(s={}){let r;if(this.stopped=!0,this.uploadState$=new t(!1),this.analyseState$=new t(!1),this.reportState$=new t(!1),this.runningStates$=e(this.uploadState$,this.analyseState$,this.reportState$),this.instanceTelemetry$=new t([]),this.experimentalWorkerStatus$=new t([]),this.states={download:{progress:{bytes:0,total:0,niceSize:0},success:{files:0,bytes:0,reads:0,niceReads:0,niceSize:0},types:{},fail:0,niceTypes:""},upload:{progress:{bytes:0,total:0,niceSize:0},success:{files:0,bytes:0,reads:0,niceReads:0,niceSize:0},types:{},filesCount:0,niceTypes:""},warnings:[]},this.timers={transferTimeouts:{},visibilityIntervals:{}},this.liveStates$=new t(this.states),"string"===typeof s){const t=St(JSON.parse(s));r=zt.parseOptObject(t)}else r=zt.parseOptObject(s);this.config={options:r,instance:{id_workflow_instance:r.id_workflow_instance,discoverQueueCache:{},awssettings:{region:r.region}}},this.log=r.log,this.REST=new Dt(r),this.graphQL=new Rt(r)}get id(){return kt(this.config.instance.id_workflow_instance)}static parseOptObject(t){const e=yt(t.url,v),s={agent_version:yt(t.agent_version,At.version),log:this.resolveLogger(t.log),local:$t(t.local,y),url:yt(t.endpoint,e),region:yt(t.region,b),user_agent:yt(t.user_agent,k),sessionGrace:vt(t.sessionGrace,$),uploadTimeout:vt(t.uploadTimeout,I),downloadTimeout:vt(t.downloadTimeout,S),fileCheckInterval:vt(t.fileCheckInterval,_),downloadCheckInterval:vt(t.downloadCheckInterval,j),stateCheckInterval:vt(t.stateCheckInterval,O),inFlightDelay:vt(t.inFlightDelay,E),waitTimeSeconds:vt(t.waitTimeSeconds,T),waitTokenError:vt(t.waitTokenError,x),transferPoolSize:vt(t.transferPoolSize,C),downloadMode:yt(t.downloadMode,A),filetype:jt(t.filetype,yt,W),signing:$t(t.signing,P),sampleDirectory:yt(t.sampleDirectory,R),useGraphQL:xt(t.useGraphQL),apikey:Ot(t.apikey),apisecret:Ot(t.apisecret),id_workflow_instance:Tt(t.id_workflow_instance),debounceWindow:Et(t.debounceWindow),proxy:Ot(t.proxy),jwt:Ot(t.jwt),inputFolders:jt(t.inputFolders,yt,[]),outputFolder:Ot(t.outputFolder),awsAcceleration:Ot(t.awsAcceleration),agent_address:Ot(t.agent_address),telemetryCb:Ct(t.telemetryCb),dataCb:Ct(t.dataCb),remoteShutdownCb:Ct(t.remoteShutdownCb)};return t.inputFolder&&s.inputFolders.push(yt(t.inputFolder)),s}static resolveLogger(t){if(!ft(t))return pt;try{return{info:_t(t.info),debug:_t(t.debug),warn:_t(t.warn),error:_t(t.error)}}catch(e){throw new Error("expected log object to have error, debug, info and warn methods")}}async socket(){if(this.mySocket)return this.mySocket;this.mySocket=new Ut(this.REST,this.config.options);const{id_workflow_instance:t}=this.config.instance;return t&&this.mySocket.watch("workflow_instance:state:"+t,t=>{var e,s;const{instance:r}=this.config,o=function(t){if(!mt(t))return St(t)}(null===(e=r.chain)||void 0===e?void 0:e.components);if(o){const e=St(r.summaryTelemetry),n=Object.entries(o).sort((t,e)=>parseInt(t[0],10)-parseInt(e[0],10)),i=bt(t),a=[];for(const[t,r]of n)if(t in i){const o=+t;let n="ROOT";if(0!==o){const t=kt(St(r).wid);n=null!==(s=Object.keys(St(e[t]))[0])&&void 0!==s?s:"ROOT"}const[c,l,h]=yt(i[t]).split(",").map(t=>Math.max(0,+t));a.push({running:c,complete:l,error:h,step:o,name:n})}this.experimentalWorkerStatus$.next(a)}}),this.mySocket}async realtimeFeedback(t,e){(await this.socket()).emit(t,e)}setTimer(t,e,s){if(this.timers[t])throw new Error(`An interval with the name ${t} has already been created`);this.timers[t]=function(t,e){const s=setInterval(e,t);return()=>clearInterval(s)}(e,s)}stopTimer(t){const e=this.timers[t];e&&(this.log.debug(`clearing ${t} interval`),e(),delete this.timers[t])}stopTimeout(t,e){const s=this.timers[t][e];s&&(s(),delete this.timers[t][e])}async stopAnalysis(){this.stopUpload(),this.stopped=!0;const{id_workflow_instance:t}=this.config.instance;if(t){try{this.config.options.useGraphQL?await this.graphQL.stopWorkflow({variables:{idWorkflowInstance:t}}):await this.REST.stopWorkflow(t),this.analyseState$.next(!1)}catch(e){throw this.log.error("Error stopping instance: "+String(e)),e}this.log.info(`workflow instance ${t} stopped`)}}stopUpload(){this.log.debug("stopping watchers"),this.stopTimer("stateCheckInterval"),this.stopTimer("fileCheckInterval"),this.uploadState$.next(!1)}async stopEverything(){this.stopAnalysis();for(const t in this.timers.transferTimeouts){this.log.debug("clearing transferTimeout for "+t);const e=this.timers.transferTimeouts[t];e&&e(),delete this.timers.transferTimeouts[t]}for(const t in this.timers.visibilityIntervals){this.log.debug("clearing visibilityInterval for "+t);const e=this.timers.visibilityIntervals[t];e&&e(),delete this.timers.visibilityIntervals[t]}this.downloadWorkerPool&&(this.log.debug("clearing downloadWorkerPool"),await Promise.all(Object.values(this.downloadWorkerPool)),delete this.downloadWorkerPool),this.stopTimer("summaryTelemetryInterval"),this.stopTimer("downloadCheckInterval")}reportProgress(){const{upload:t,download:e}=this.states;this.log.debug({progress:{download:e,upload:t}})}uploadState(t,e,s){var r,o;const n=null!==(r=this.states.upload)&&void 0!==r?r:{progress:{bytes:0,total:0,niceSize:0},success:{files:0,bytes:0,reads:0,niceReads:0,niceSize:0},types:{},filesCount:0,niceTypes:""};"success"===t?this.updateSuccessState(n.success,e,s):"types"===t?this.updateTypesState(n.types,e,s):this.updateProgressState(n.progress,e,s);try{n.success.niceReads=qt(this.states.upload.success.reads)}catch(a){n.success.niceReads=0}try{n.progress.niceSize=qt(null!==(o=n.success.bytes+n.progress.bytes)&&void 0!==o?o:0)}catch(a){n.progress.niceSize=0}try{n.success.niceSize=qt(this.states.upload.success.bytes)}catch(a){n.success.niceSize=0}n.niceTypes=Object.keys(this.states.upload.types||{}).sort().map(t=>`${this.states.upload.types[t]} ${t}`).join(", ");const i=Date.now();(!this.stateReportTime||i-this.stateReportTime>2e3)&&(this.stateReportTime=i,this.reportProgress()),this.liveStates$.next(Object.assign({},this.states))}downloadState(t,e,s){var r,o;const n=null!==(r=this.states.download)&&void 0!==r?r:{progress:{bytes:0,total:0,niceSize:0},success:{files:0,bytes:0,reads:0,niceReads:0,niceSize:0},types:{},fail:0,niceTypes:""};"success"===t?this.updateSuccessState(n.success,e,s):"types"===t?this.updateTypesState(n.types,e,s):this.updateProgressState(n.progress,e,s);try{n.success.niceReads=qt(this.states.upload.success.reads)}catch(a){n.success.niceReads=0}try{n.progress.niceSize=qt(null!==(o=n.success.bytes+n.progress.bytes)&&void 0!==o?o:0)}catch(a){n.progress.niceSize=0}try{n.success.niceSize=qt(this.states.upload.success.bytes)}catch(a){n.success.niceSize=0}n.niceTypes=Object.keys(this.states.upload.types||{}).sort().map(t=>`${this.states.upload.types[t]} ${t}`).join(", ");const i=Date.now();(!this.stateReportTime||i-this.stateReportTime>2e3)&&(this.stateReportTime=i,this.reportProgress()),this.liveStates$.next(Object.assign({},this.states))}updateSuccessState(t,e,s){var r;const o=new Set(["files","bytes","reads"]);for(const n of Object.keys(s)){const i=("incr"===e?1:-1)*(null!==(r=s[n])&&void 0!==r?r:0);if(o.has(n)){const e=n;t[e]=t[e]+i}}}updateTypesState(t,e,s){var r;for(const o of Object.keys(s)){const n=("incr"===e?1:-1)*(null!==(r=s[o])&&void 0!==r?r:0);t[o]=vt(t[o],0)+n}}updateProgressState(t,e,s){var r;const o=new Set(["bytes","total"]);for(const n of Object.keys(s)){const i=("incr"===e?1:-1)*(null!==(r=s[n])&&void 0!==r?r:0);if(o.has(n)){const e=n;t[e]=t[e]+i}}}url(){return this.config.options.url}apikey(){return this.config.options.apikey}attr(t,e){if(!e)return this.config.options[t];switch(t){case"url":case"region":case"user_agent":case"downloadMode":case"sampleDirectory":case"apikey":case"apisecret":this.config.options[t]=yt(e);break;case"id_workflow_instance":case"sessionGrace":case"uploadTimeout":case"fileCheckInterval":case"downloadCheckInterval":case"stateCheckInterval":case"inFlightDelay":case"waitTimeSeconds":case"waitTokenError":case"transferPoolSize":case"debounceWindow":this.config.options[t]=vt(e);break;case"signing":case"useGraphQL":case"local":this.config.options[t]=$t(e);break;case"filetype":this.config.options[t]=jt(e,yt);break;default:throw new Error('Cannot modify the "log" attribute')}return this}stats(t){return this.states[t]}}zt.version=At.version,zt.Profile=class{constructor(t){this.allProfileData={},this.defaultEndpoint=process.env.METRICHOR||v,t&&(this.allProfileData=d({profiles:{}},t)),this.allProfileData.endpoint&&(this.defaultEndpoint=this.allProfileData.endpoint)}profile(t){return t?d({endpoint:this.defaultEndpoint},d({profiles:{}},this.allProfileData).profiles[t]):{}}profiles(){return Object.keys(this.allProfileData.profiles||{})}},zt.REST=Dt,zt.utils=At;export default zt;
